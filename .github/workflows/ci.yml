name: CI
on:
  pull_request:
  push:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Dependencies
        run: go mod download
      - name: Lint and Static Checks
        run: |
          go vet ./...
          staticcheck ./... || true
          govulncheck ./...
      - name: Unit Tests
        run: go test ./... -v
      - name: Coverage (func)
        run: |
          go test ./... -cover -coverprofile=coverage.out
          go tool cover -func=coverage.out | tee coverage.txt
          awk '/total:/ { if ($3+0 < 50) { print "Coverage below 50%: "$3; exit 1 } }' coverage.txt || true
      - name: Coverage HTML
        run: |
          go tool cover -html=coverage.out -o coverage.html
      - name: Upload Coverage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: |
            coverage.out
            coverage.txt
            coverage.html

  golangci-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.60.1
      - name: Run golangci-lint
        run: |
          $(go env GOPATH)/bin/golangci-lint run ./...

  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --config-path .gitleaks.toml --redact --verbose --exit-code 1

  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Run E2E Tests
        run: go test -tags e2e ./tests/e2e -v

  sarif-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Generate SARIF from sample project
        run: |
          go run . scan ./tests/e2e/test-projects/npm-vulnerable --output sarif > typosentinel.sarif.json
      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: typosentinel.sarif.json
          category: typosentinel-cli
      - name: Upload SARIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: sarif
          path: typosentinel.sarif.json

  supply-chain-firewall:
    uses: ./.github/workflows/supply-chain-firewall.yml
    with:
      asset-criticality: INTERNAL
      policy-threshold: alert
      fail-on-violation: true
