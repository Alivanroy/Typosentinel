name: CI
on:
  pull_request:
  push:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Dependencies
        run: go mod download
      - name: Lint and Static Checks
        run: |
          go vet ./...
          staticcheck ./... || true
          govulncheck ./...
      - name: License Check (go-licenses)
        run: |
          go install github.com/google/go-licenses@latest
          $(go env GOPATH)/bin/go-licenses check ./... || true
      - name: Unit Tests
        run: go test ./... -v
      - name: Coverage (func)
        run: |
          go test ./... -cover -coverprofile=coverage.out
          go tool cover -func=coverage.out | tee coverage.txt
          awk '/total:/ { if ($3+0 < 20) { print "Coverage below 20%: "$3; exit 1 } }' coverage.txt || true
          cp coverage.txt coverage_baseline.txt
          go test ./pkg/types -cover | tee types_cov.txt
          awk '/coverage:/ { gsub("%","",$3); if ($3+0 < 100) { print "pkg/types coverage below 100%: "$3"%"; exit 1 } }' types_cov.txt
          go test ./internal/detector -cover | tee detector_cov.txt
          awk '/coverage:/ { gsub("%","",$3); if ($3+0 < 70) { print "internal/detector coverage below 70%: "$3"%"; exit 1 } }' detector_cov.txt
      - name: Coverage HTML
        run: |
          go tool cover -html=coverage.out -o coverage.html
      - name: Upload Coverage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: |
            coverage.out
            coverage.txt
            coverage_baseline.txt
            coverage.html

  golangci-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.60.1
      - name: Run golangci-lint
        run: |
          $(go env GOPATH)/bin/golangci-lint run ./...

  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --config-path .gitleaks.toml --redact --verbose --exit-code 1


  sarif-report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Generate SARIF from sample project
        run: |
          go run . scan ./tests/e2e/test-projects/npm-vulnerable --output sarif > typosentinel.sarif.json
      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: typosentinel.sarif.json
          category: typosentinel-cli
      - name: Upload SARIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: sarif
          path: typosentinel.sarif.json

  supply-chain-firewall:
    uses: ./.github/workflows/supply-chain-firewall.yml
    with:
      asset-criticality: INTERNAL
      policy-threshold: alert
      fail-on-violation: true

  e2e-realworld:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Run Realworld E2E Suite
        env:
          API_AUTH_ENABLED: "false"
        run: |
          go test -tags=realworld ./tests/e2e/testrealworld -v

  release-validation:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - name: Validate Tag Format
        run: |
          [[ "${GITHUB_REF##*/}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]] || { echo "Invalid semantic tag"; exit 1; }
