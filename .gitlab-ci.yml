# GitLab CI/CD Pipeline for TypoSentinel
# This pipeline provides comprehensive testing, security scanning, and deployment

stages:
  - lint
  - security
  - test
  - integration
  - build
  - performance
  - deploy
  - cleanup

variables:
  GO_VERSION: "1.21"
  PYTHON_VERSION: "3.11"
  DOCKER_REGISTRY: $CI_REGISTRY
  IMAGE_NAME: $CI_PROJECT_PATH
  POSTGRES_DB: typosentinel_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: test123
  REDIS_HOST: redis
  REDIS_PORT: 6379
  DB_HOST: postgres
  DB_PORT: 5432
  DB_NAME: typosentinel_test
  DB_USER: postgres
  DB_PASSWORD: test123

# Default image and cache settings
default:
  image: golang:${GO_VERSION}
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - .cache/go
      - .cache/pip
    policy: pull-push

# Before script to set up common dependencies
before_script:
  - export GOPATH="$CI_PROJECT_DIR/.cache/go"
  - export PATH="$GOPATH/bin:$PATH"
  - mkdir -p .cache/go .cache/pip

# Lint Stage
lint:go:
  stage: lint
  script:
    - go mod download
    - go vet ./...
    - go fmt ./...
    - |
      if ! command -v golangci-lint &> /dev/null; then
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.54.2
      fi
    - golangci-lint run ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

lint:python:
  stage: lint
  image: python:${PYTHON_VERSION}
  before_script:
    - cd ml
    - pip install --cache-dir ../.cache/pip -r requirements.txt
    - pip install --cache-dir ../.cache/pip flake8 black pytest
  script:
    - flake8 .
    - black --check .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - changes:
        - ml/**/*

# Security Stage
security:go:
  stage: security
  script:
    - go mod download
    - |
      if ! command -v gosec &> /dev/null; then
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
      fi
    - |
      if ! command -v govulncheck &> /dev/null; then
        go install golang.org/x/vuln/cmd/govulncheck@latest
      fi
    - gosec ./...
    - govulncheck ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

security:trivy:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy fs --format sarif --output trivy-results.sarif .
    - trivy fs --format table .
  artifacts:
    reports:
      sast: trivy-results.sarif
    paths:
      - trivy-results.sarif
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Test Stage
test:unit:
  stage: test
  services:
    - name: postgres:15
      alias: postgres
      variables:
        POSTGRES_PASSWORD: $POSTGRES_PASSWORD
        POSTGRES_USER: $POSTGRES_USER
        POSTGRES_DB: $POSTGRES_DB
    - name: redis:7
      alias: redis
  script:
    - go mod download
    - |
      # Wait for services to be ready
      until pg_isready -h postgres -p 5432 -U $POSTGRES_USER; do
        echo "Waiting for postgres..."
        sleep 2
      done
    - |
      until redis-cli -h redis ping; do
        echo "Waiting for redis..."
        sleep 2
      done
    - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
    - go tool cover -html=coverage.out -o coverage.html
  coverage: '/coverage: \d+\.\d+% of statements/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.out
      - coverage.html
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

test:python:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - cd ml
    - pip install --cache-dir ../.cache/pip -r requirements.txt
    - pip install --cache-dir ../.cache/pip pytest pytest-cov pytest-asyncio httpx
  script:
    - python -m pytest tests/ -v --cov=. --cov-report=html --cov-report=xml --cov-report=term
  coverage: '/TOTAL.+ ([0-9]{1,3}%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ml/coverage.xml
    paths:
      - ml/htmlcov/
      - ml/coverage.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - changes:
        - ml/**/*

# Integration Test Stage
integration:test:
  stage: integration
  services:
    - name: postgres:15
      alias: postgres
      variables:
        POSTGRES_PASSWORD: $POSTGRES_PASSWORD
        POSTGRES_USER: $POSTGRES_USER
        POSTGRES_DB: $POSTGRES_DB
  before_script:
    - export GOPATH="$CI_PROJECT_DIR/.cache/go"
    - export PATH="$GOPATH/bin:$PATH"
    - apt-get update && apt-get install -y python3 python3-pip make
  script:
    - go mod download
    - cd ml && pip3 install --cache-dir ../.cache/pip -r requirements.txt && cd ..
    - make build
    - |
      # Wait for postgres to be ready
      until pg_isready -h postgres -p 5432 -U $POSTGRES_USER; do
        echo "Waiting for postgres..."
        sleep 2
      done
    - |
      # Start ML service in background if it exists
      if [ -f "ml/service/api_server.py" ]; then
        cd ml/service && python3 api_server.py --host 0.0.0.0 --port 8000 &
        ML_PID=$!
        cd ../..
        sleep 10
      fi
    - go test -v -tags=integration ./... -timeout=15m
    - |
      # Stop ML service if it was started
      if [ ! -z "$ML_PID" ]; then
        kill $ML_PID || true
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Build Stage
build:docker:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - |
      # Build main application image
      docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
      docker build -t $CI_REGISTRY_IMAGE:latest .
    - |
      # Build ML service image if Dockerfile exists
      if [ -f "ml/Dockerfile" ]; then
        docker build -t $CI_REGISTRY_IMAGE/ml:$CI_COMMIT_SHA -f ml/Dockerfile ml/
        docker build -t $CI_REGISTRY_IMAGE/ml:latest -f ml/Dockerfile ml/
      fi
    - |
      # Push images if not a merge request
      if [ "$CI_PIPELINE_SOURCE" != "merge_request_event" ]; then
        docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
        docker push $CI_REGISTRY_IMAGE:latest
        if [ -f "ml/Dockerfile" ]; then
          docker push $CI_REGISTRY_IMAGE/ml:$CI_COMMIT_SHA
          docker push $CI_REGISTRY_IMAGE/ml:latest
        fi
      fi
    - |
      # Test Docker images
      docker run --rm $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA --version
      if [ -f "ml/Dockerfile" ]; then
        docker run --rm -d --name ml-test -p 8001:8000 $CI_REGISTRY_IMAGE/ml:$CI_COMMIT_SHA
        sleep 10
        curl -f http://localhost:8001/health || exit 1
        docker stop ml-test
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Performance Test Stage
performance:benchmark:
  stage: performance
  script:
    - go mod download
    - go test -bench=. -benchmem ./... | tee benchmark.txt
  artifacts:
    paths:
      - benchmark.txt
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Deploy Stage
deploy:staging:
  stage: deploy
  environment:
    name: staging
    url: https://staging.typosentinel.com
  script:
    - echo "Deploying to staging environment..."
    - |
      # Add your staging deployment commands here
      # This could involve updating Kubernetes manifests,
      # triggering deployment pipelines, etc.
      echo "Staging deployment completed"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  when: manual

deploy:production:
  stage: deploy
  environment:
    name: production
    url: https://typosentinel.com
  script:
    - echo "Deploying to production environment..."
    - |
      # Add your production deployment commands here
      # This could involve updating Kubernetes manifests,
      # triggering deployment pipelines, etc.
      echo "Production deployment completed"
  rules:
    - if: $CI_COMMIT_TAG
  when: manual

# Release Job
release:create:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  before_script:
    - apk add --no-cache go make
    - export GOPATH="$CI_PROJECT_DIR/.cache/go"
    - export PATH="$GOPATH/bin:$PATH"
  script:
    - go mod download
    - make build-all || echo "Build-all target not found, skipping"
    - make package || echo "Package target not found, skipping"
    - |
      # Generate changelog from git commits
      echo "## Changes" > CHANGELOG.md
      if [ ! -z "$CI_COMMIT_TAG" ]; then
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CI_COMMIT_TAG^ 2>/dev/null || echo "")
        if [ ! -z "$PREVIOUS_TAG" ]; then
          git log --pretty=format:"- %s" $PREVIOUS_TAG..$CI_COMMIT_TAG >> CHANGELOG.md
        else
          git log --pretty=format:"- %s" >> CHANGELOG.md
        fi
      fi
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'Release $CI_COMMIT_TAG'
    description: './CHANGELOG.md'
    assets:
      links:
        - name: 'Docker Image'
          url: '$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG'
  rules:
    - if: $CI_COMMIT_TAG

# Cleanup Stage
cleanup:artifacts:
  stage: cleanup
  script:
    - echo "Cleaning up old artifacts..."
    - |
      # Add cleanup commands here if needed
      echo "Cleanup completed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  when: manual

# Include additional CI templates if needed
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Code-Quality.gitlab-ci.yml