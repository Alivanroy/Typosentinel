# Test-specific Dockerfile for Typosentinel with full source
FROM golang:1.23-alpine AS builder

# Install build dependencies including CGO support for SQLite
RUN apk add --no-cache gcc musl-dev sqlite-dev

WORKDIR /app

# Copy go mod files first for better caching
COPY go.mod go.sum ./
RUN go mod download

# Copy all source code
COPY . .

# Build with CGO enabled for SQLite support
RUN CGO_ENABLED=1 GOOS=linux go build -a -installsuffix cgo -o typosentinel-test ./main.go

# Final test stage
FROM golang:1.23-alpine

# Install runtime dependencies including SQLite
RUN apk add --no-cache ca-certificates tzdata curl sqlite sqlite-dev gcc musl-dev

WORKDIR /app

# Copy the entire source code including tests
COPY --from=builder /app/ .

# Create necessary directories
RUN mkdir -p /app/data /app/logs

# Set environment variables for testing
ENV TYPOSENTINEL_DB_TYPE=sqlite
ENV TYPOSENTINEL_DB_NAME=/app/data/typosentinel-test.db
ENV TYPOSENTINEL_LOG_LEVEL=debug

# Default command runs tests
CMD ["go", "test", "./tests/...", "-v"]