# Open-Source Vulnerability Database Integration

This document provides a comprehensive guide to the newly integrated open-source vulnerability database system in Typosentinel. The integration enhances the project's security capabilities by incorporating multiple vulnerability databases for comprehensive threat detection.

## ğŸš€ Overview

The vulnerability database integration adds support for multiple open-source vulnerability databases:

- **OSV (Open Source Vulnerabilities)** - Google's comprehensive vulnerability database
- **GitHub Security Advisory Database** - GitHub's curated security advisories
- **NIST NVD (National Vulnerability Database)** - Existing integration enhanced

## ğŸ“ Project Structure

The integration introduces several new components:

```
internal/vulnerability/
â”œâ”€â”€ osv_database.go          # OSV API integration
â”œâ”€â”€ github_database.go       # GitHub Advisory API integration
â”œâ”€â”€ manager.go               # Multi-database coordination
â”œâ”€â”€ integration_test.go      # Comprehensive tests
â””â”€â”€ database.go              # Original NVD integration

pkg/types/
â””â”€â”€ types.go                 # Enhanced vulnerability types

config/
â””â”€â”€ vulnerability_databases.yaml  # Configuration file

examples/
â””â”€â”€ vulnerability_integration.go   # Usage examples

docs/
â””â”€â”€ VULNERABILITY_DATABASES.md     # Detailed documentation
```

## ğŸ› ï¸ Installation & Setup

### 1. Dependencies

The integration adds new Go dependencies:

```bash
# Install new dependencies
go mod tidy
```

New dependencies include:
- `github.com/Masterminds/semver/v3` - Semantic version parsing
- `github.com/hashicorp/go-retryablehttp` - HTTP client utilities
- `github.com/package-url/packageurl-go` - Package URL handling

### 2. Configuration

Copy and customize the vulnerability database configuration:

```bash
cp config/vulnerability_databases.yaml config/vulnerability_databases_local.yaml
```

Edit the configuration file to add API keys and customize settings:

```yaml
vulnerability_databases:
  osv:
    enabled: true
    base_url: "https://api.osv.dev"
    timeout: 15s
    
  github:
    enabled: true
    base_url: "https://api.github.com"
    token: "your_github_token_here"  # Optional but recommended
    timeout: 20s
    
  nvd:
    enabled: true
    base_url: "https://services.nvd.nist.gov"
    api_key: "your_nvd_api_key_here"  # Optional but recommended
    timeout: 30s

manager:
  parallel_queries: true
  merge_results: true
  deduplicate_by_id: true
  priority: ["osv", "github", "nvd"]
  timeout: 60s
```

### 3. API Keys (Recommended)

#### GitHub Token
```bash
# Create a GitHub personal access token with 'public_repo' scope
# https://github.com/settings/tokens
export GITHUB_TOKEN="your_token_here"
```

#### NVD API Key
```bash
# Request an API key from NIST
# https://nvd.nist.gov/developers/request-an-api-key
export NVD_API_KEY="your_key_here"
```

## ğŸ”§ Usage

### Basic Usage

```go
package main

import (
    "fmt"
    "log"
    "time"
    
    "github.com/Alivanroy/Typosentinel/internal/vulnerability"
    "github.com/Alivanroy/Typosentinel/pkg/types"
)

func main() {
    // Create manager with default configuration
    config := &vulnerability.ManagerConfig{
        Databases: []types.VulnerabilityDatabaseConfig{
            {
                Type:    "osv",
                Enabled: true,
                Timeout: 15 * time.Second,
            },
            {
                Type:    "github",
                Enabled: true,
                Timeout: 20 * time.Second,
            },
        },
        ParallelQueries: true,
        MergeResults:    true,
        Timeout:         60 * time.Second,
    }
    
    manager := vulnerability.NewManager(config)
    
    // Check vulnerabilities for a package
    pkg := &types.Package{
        Name:     "lodash",
        Version:  "4.17.20",
        Registry: "npm",
    }
    
    vulnerabilities, err := manager.CheckVulnerabilities(pkg)
    if err != nil {
        log.Fatalf("Error checking vulnerabilities: %v", err)
    }
    
    fmt.Printf("Found %d vulnerabilities for %s@%s\n", 
        len(vulnerabilities), pkg.Name, pkg.Version)
    
    for _, vuln := range vulnerabilities {
        fmt.Printf("- %s: %s (Severity: %s, Source: %s)\n", 
            vuln.ID, vuln.Title, vuln.Severity, vuln.Source)
    }
}
```

### Advanced Usage

```go
// Individual database usage
osvDB := vulnerability.NewOSVDatabase()
githubDB := vulnerability.NewGitHubAdvisoryDatabase("your_token")

// Search vulnerabilities
vulns, err := manager.SearchVulnerabilities("npm:lodash")

// Get specific vulnerability
vuln, err := manager.GetVulnerabilityByID("GHSA-jf85-cpcp-j695")

// Dynamic database management
manager.AddDatabase("custom", customDB)
manager.RemoveDatabase("nvd")
```

### Command Line Integration

The vulnerability databases are automatically integrated into the main Typosentinel CLI:

```bash
# Scan with vulnerability checking
./typosentinel scan --project-path ./my-project --check-vulnerabilities

# Scan specific package with vulnerability details
./typosentinel scan --package lodash@4.17.20 --registry npm --verbose
```

## ğŸ§ª Testing

### Run Integration Tests

```bash
# Run all vulnerability integration tests
go test ./internal/vulnerability/ -v

# Run specific test
go test ./internal/vulnerability/ -run TestOSVDatabaseIntegration -v

# Run tests with short flag (skips integration tests)
go test ./internal/vulnerability/ -short

# Run benchmarks
go test ./internal/vulnerability/ -bench=. -benchmem
```

### Test Configuration

```bash
# Test with custom configuration
VULN_CONFIG_PATH=./config/vulnerability_databases_test.yaml go test ./internal/vulnerability/ -v
```

## ğŸ“Š Performance Considerations

### Parallel Queries
- **Enabled**: Queries multiple databases simultaneously (faster)
- **Disabled**: Queries databases sequentially (more reliable)

### Caching
- Results are cached to reduce API calls
- Cache TTL is configurable per database
- Redis support for distributed caching

### Rate Limiting
- Built-in rate limiting for each database
- Configurable requests per second
- Automatic backoff on rate limit errors

### Timeouts
- Individual database timeouts
- Overall manager timeout
- Configurable retry policies

## ğŸ” Monitoring & Debugging

### Logging

```go
// Enable debug logging
logger.SetLevel(logger.DebugLevel)

// Log vulnerability check details
manager.EnableDebugLogging(true)
```

### Metrics

```go
// Get database statistics
stats := manager.GetStatistics()
fmt.Printf("Total queries: %d\n", stats.TotalQueries)
fmt.Printf("Cache hits: %d\n", stats.CacheHits)
fmt.Printf("Average response time: %v\n", stats.AvgResponseTime)
```

### Health Checks

```go
// Check database health
healthStatus := manager.HealthCheck()
for dbName, status := range healthStatus {
    fmt.Printf("%s: %s\n", dbName, status)
}
```

## ğŸš¨ Error Handling

### Common Errors

1. **API Rate Limiting**
   ```
   Error: rate limit exceeded for github database
   Solution: Add API token or reduce query frequency
   ```

2. **Network Timeouts**
   ```
   Error: context deadline exceeded
   Solution: Increase timeout values in configuration
   ```

3. **Invalid Package Format**
   ```
   Error: unsupported registry type
   Solution: Check supported registries in documentation
   ```

### Error Recovery

```go
// Configure retry policies
config.RetryPolicy = &vulnerability.RetryPolicy{
    MaxRetries:    3,
    InitialDelay:  time.Second,
    MaxDelay:      30 * time.Second,
    Multiplier:    2.0,
}
```

## ğŸ”§ Customization

### Custom Database Implementation

```go
type CustomVulnDB struct {
    // Your implementation
}

func (db *CustomVulnDB) CheckVulnerabilities(pkg *types.Package) ([]*types.Vulnerability, error) {
    // Your logic here
    return vulnerabilities, nil
}

// Register custom database
manager.AddDatabase("custom", &CustomVulnDB{})
```

### Custom Severity Mapping

```go
// Override severity mapping
config.SeverityMapping = map[string]types.Severity{
    "low":      types.SeverityLow,
    "moderate": types.SeverityMedium,
    "high":     types.SeverityHigh,
    "critical": types.SeverityCritical,
}
```

## ğŸ“ˆ Best Practices

### 1. API Key Management
- Use environment variables for API keys
- Rotate keys regularly
- Monitor API usage quotas

### 2. Performance Optimization
- Enable parallel queries for faster results
- Use caching to reduce API calls
- Set appropriate timeouts

### 3. Error Handling
- Implement proper retry logic
- Log errors for debugging
- Have fallback strategies

### 4. Security
- Validate all input data
- Sanitize vulnerability data
- Use HTTPS for all API calls

### 5. Monitoring
- Track API usage and quotas
- Monitor response times
- Set up alerts for failures

## ğŸ¤ Contributing

### Adding New Databases

1. Implement the `VulnerabilityDatabase` interface
2. Add configuration support
3. Write comprehensive tests
4. Update documentation
5. Submit a pull request

### Testing Guidelines

- Write unit tests for all new functionality
- Include integration tests with real APIs
- Test error conditions and edge cases
- Benchmark performance-critical code

## ğŸ“š Additional Resources

- [OSV API Documentation](https://osv.dev/docs/)
- [GitHub Security Advisory API](https://docs.github.com/en/rest/security-advisories)
- [NIST NVD API Documentation](https://nvd.nist.gov/developers)
- [Typosentinel Main Documentation](./README.md)
- [Detailed Vulnerability Database Guide](./docs/VULNERABILITY_DATABASES.md)

## ğŸ› Troubleshooting

For common issues and solutions, see:
- [Troubleshooting Guide](./docs/TROUBLESHOOTING.md)
- [Debug Logging Guide](./docs/DEBUG_LOGGING.md)
- [GitHub Issues](https://github.com/Alivanroy/Typosentinel/issues)

## ğŸ“„ License

This integration is part of the Typosentinel project and is licensed under the same terms. See [LICENSE](./LICENSE) for details.

---

**Note**: This integration significantly enhances Typosentinel's vulnerability detection capabilities by providing access to multiple authoritative vulnerability databases. The implementation follows security best practices and provides comprehensive error handling and monitoring capabilities.