# Test configuration for Typosentinel
# This configuration is optimized for testing environments

app:
  name: "Typosentinel-Test"
  version: "test"
  environment: "testing"
  debug: true
  log_level: "debug"
  data_dir: "/tmp/typosentinel-test/data"
  temp_dir: "/tmp/typosentinel-test/tmp"
  max_workers: 2
  graceful_shutdown_timeout: "5s"

server:
  host: "localhost"
  port: 0  # Use random port for testing
  read_timeout: "5s"
  write_timeout: "5s"
  idle_timeout: "10s"
  shutdown_timeout: "5s"
  enable_cors: true
  cors_origins:
    - "http://localhost:*"
    - "http://127.0.0.1:*"
  enable_compression: false
  max_request_size: "1MB"

database:
  type: "sqlite"
  host: ""
  port: 0
  username: ""
  password: ""
  database: ":memory:"  # Use in-memory database for tests
  ssl_mode: "disable"
  max_open_conns: 5
  max_idle_conns: 2
  conn_max_lifetime: "5m"
  migrations_path: "./migrations"
  auto_migrate: true

redis:
  enabled: false  # Disable Redis for most tests
  host: "localhost"
  port: 6379
  password: ""
  database: 15  # Use test database
  pool_size: 5
  min_idle_conns: 1
  dial_timeout: "5s"
  read_timeout: "3s"
  write_timeout: "3s"
  pool_timeout: "4s"
  idle_timeout: "5m"
  max_retries: 1
  retry_delay: "1s"

logging:
  level: "debug"
  format: "text"  # Use text format for easier test debugging
  output: "stderr"
  caller: true
  timestamp: true
  file:
    enabled: false
    path: "/tmp/typosentinel-test.log"
    max_size: 10
    max_backups: 3
    max_age: 7
    compress: false

metrics:
  enabled: false  # Disable metrics for most tests
  type: "prometheus"
  address: ":0"  # Use random port
  path: "/metrics"
  namespace: "typosentinel_test"
  subsystem: ""
  collect_runtime: false
  collect_process: false

security:
  jwt:
    enabled: false
    secret: "test-jwt-secret-key-for-testing-only"
    issuer: "typosentinel-test"
    audience: "typosentinel-test"
    expiry: "1h"
    refresh_expiry: "24h"
    algorithm: "HS256"
  
  api_keys:
    enabled: false
    header_name: "X-API-Key"
    keys:
      - "test-api-key-1"
      - "test-api-key-2"
  
  encryption:
    key: "test-encryption-key-32-characters"  # 32 characters for AES-256
    algorithm: "aes-256-gcm"
  
  rate_limiting:
    enabled: false
    requests_per_minute: 1000
    burst: 100
    cleanup_interval: "1m"

ml:
  enabled: false  # Disable ML for most tests
  model_path: "/tmp/typosentinel-test/models"
  threshold: 0.5
  batch_size: 10
  timeout: "5s"
  max_retries: 1
  retry_delay: "1s"
  features:
    - "name_similarity"
    - "description_similarity"
    - "author_reputation"
    - "download_count"
    - "creation_date"

scanner:
  max_concurrency: 2
  timeout: "10s"
  retry_attempts: 1
  retry_delay: "1s"
  user_agent: "Typosentinel-Test/1.0"
  registries:
    npm:
      enabled: true
      base_url: "https://registry.npmjs.org"
      timeout: "10s"
      rate_limit: 10
    pypi:
      enabled: true
      base_url: "https://pypi.org"
      timeout: "10s"
      rate_limit: 10
    rubygems:
      enabled: false
      base_url: "https://rubygems.org"
      timeout: "10s"
      rate_limit: 10
  
  threat_detection:
    enabled: true
    algorithms:
      - "levenshtein"
      - "jaro_winkler"
      - "soundex"
    thresholds:
      levenshtein: 2
      jaro_winkler: 0.8
      soundex: 1.0
    
    typosquatting_patterns:
      - "character_substitution"
      - "character_insertion"
      - "character_deletion"
      - "character_transposition"
      - "subdomain_squatting"
      - "homograph_attack"

api:
  prefix: "/api"
  version: "v1"
  enable_docs: true
  docs_path: "/docs"
  enable_health: true
  health_path: "/health"
  enable_metrics: false
  metrics_path: "/metrics"
  
  endpoints:
    scan:
      enabled: true
      path: "/scan"
      methods: ["POST"]
      rate_limit: 100
    
    bulk_scan:
      enabled: true
      path: "/scan/bulk"
      methods: ["POST"]
      rate_limit: 10
      max_packages: 100
    
    project_scan:
      enabled: true
      path: "/scan/project"
      methods: ["POST"]
      rate_limit: 10
    
    threat_info:
      enabled: true
      path: "/threats"
      methods: ["GET"]
      rate_limit: 100

rate_limit:
  enabled: false  # Disable rate limiting for tests
  global:
    requests_per_minute: 1000
    burst: 100
  per_ip:
    requests_per_minute: 100
    burst: 20
  per_api_key:
    requests_per_minute: 500
    burst: 50
  cleanup_interval: "1m"
  storage: "memory"  # Use memory storage for tests

caching:
  enabled: false  # Disable caching for most tests
  type: "memory"  # Use memory cache for tests
  ttl: "5m"
  max_size: 1000
  cleanup_interval: "1m"
  
  redis:
    key_prefix: "typosentinel:test:"
    default_ttl: "5m"
  
  memory:
    max_entries: 1000
    cleanup_interval: "1m"

features:
  caching: false
  ml_scoring: false
  bulk_scanning: true
  project_scanning: true
  threat_database: true
  api_keys: false
  rate_limiting: false
  metrics: false
  health_checks: true
  graceful_shutdown: true
  request_logging: true
  error_tracking: true
  performance_monitoring: false

# Test-specific configurations
test:
  # Mock configurations
  use_mocks: true
  mock_delay: "0ms"  # No delay for faster tests
  
  # Test data
  fixtures_path: "./testdata/fixtures"
  test_packages:
    - name: "lodash"
      version: "4.17.21"
      registry: "npm"
      expected_safe: true
    - name: "lodash-test-typo"
      version: "1.0.0"
      registry: "npm"
      expected_safe: false
    - name: "requests"
      version: "2.28.1"
      registry: "pypi"
      expected_safe: true
    - name: "requsts"  # Typo of requests
      version: "1.0.0"
      registry: "pypi"
      expected_safe: false
  
  # Performance test configurations
  performance:
    max_scan_duration: "1s"
    max_bulk_scan_duration: "5s"
    max_project_scan_duration: "10s"
    memory_limit: "100MB"
    cpu_limit: "50%"
  
  # Integration test configurations
  integration:
    external_apis: false  # Don't call external APIs in tests
    database_cleanup: true
    cache_cleanup: true
    temp_file_cleanup: true
  
  # Load test configurations
  load:
    concurrent_users: 10
    requests_per_user: 100
    ramp_up_duration: "10s"
    test_duration: "1m"

# Environment-specific overrides
env_overrides:
  CI:
    logging:
      level: "info"
      format: "json"
    test:
      performance:
        max_scan_duration: "5s"
        max_bulk_scan_duration: "30s"
  
  GITHUB_ACTIONS:
    logging:
      level: "info"
      format: "json"
    metrics:
      enabled: false
    test:
      integration:
        external_apis: false