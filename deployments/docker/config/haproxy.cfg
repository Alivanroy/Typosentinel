global
    daemon
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option http-server-close
    timeout connect 5000
    timeout client 50000
    timeout server 50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Frontend for TypoSentinel API
frontend typosentinel_frontend
    bind *:80
    bind *:443
    
    # Health check endpoint
    acl health_check path_beg /health
    
    # API endpoints
    acl api_request path_beg /api/
    
    # Route to backend
    use_backend typosentinel_backend if api_request
    use_backend typosentinel_backend if health_check
    
    # Default backend
    default_backend typosentinel_backend

# Backend for TypoSentinel Scanner
backend typosentinel_backend
    balance roundrobin
    option httpchk GET /health
    
    # Health check configuration
    http-check expect status 200
    
    # Server configuration
    server scanner1 typosentinel-scanner:8080 check inter 10s fall 3 rise 2
    
    # Enable stats
    stats enable
    stats uri /haproxy-stats
    stats refresh 30s
    stats admin if TRUE

# Stats interface
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:enterprise123

# Frontend for monitoring services
frontend monitoring_frontend
    bind *:3000
    
    # Grafana
    acl grafana_request hdr_beg(host) -i grafana
    use_backend grafana_backend if grafana_request
    
    # Prometheus
    acl prometheus_request hdr_beg(host) -i prometheus
    use_backend prometheus_backend if prometheus_request
    
    # Kibana
    acl kibana_request hdr_beg(host) -i kibana
    use_backend kibana_backend if kibana_request

# Grafana backend
backend grafana_backend
    balance roundrobin
    server grafana1 enterprise-grafana:3000 check

# Prometheus backend  
backend prometheus_backend
    balance roundrobin
    server prometheus1 enterprise-prometheus:9090 check

# Kibana backend
backend kibana_backend
    balance roundrobin
    server kibana1 enterprise-kibana:5601 check