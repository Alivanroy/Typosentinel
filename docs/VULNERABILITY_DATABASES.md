# Open-Source Vulnerability Database Integration

Typosentinel now supports multiple open-source vulnerability databases to provide comprehensive security coverage for your packages. This integration enhances threat detection by leveraging the most up-to-date vulnerability information from trusted sources.

## Supported Databases

### 1. Google OSV (Open Source Vulnerabilities) Database
- **URL**: https://osv.dev/
- **API**: https://api.osv.dev/
- **Coverage**: Comprehensive open-source vulnerability database
- **Rate Limits**: Generous (600 requests/minute)
- **Authentication**: Not required
- **Ecosystems**: npm, PyPI, Go, Maven, NuGet, RubyGems, crates.io, and more

**Features:**
- Fast and reliable API
- Comprehensive vulnerability data
- Regular updates from multiple sources
- Structured vulnerability format
- No authentication required

### 2. GitHub Security Advisory Database
- **URL**: https://github.com/advisories
- **API**: https://api.github.com/advisories
- **Coverage**: GitHub's curated security advisory database
- **Rate Limits**: 60/hour (unauthenticated), 5000/hour (authenticated)
- **Authentication**: Optional GitHub token (recommended)
- **Ecosystems**: npm, PyPI, Go, Maven, NuGet, Composer, RubyGems, Cargo

**Features:**
- High-quality, curated vulnerability data
- Integration with GitHub ecosystem
- CVSS scoring
- Detailed remediation information
- Community-driven updates

### 3. NIST NVD (National Vulnerability Database)
- **URL**: https://nvd.nist.gov/
- **API**: https://services.nvd.nist.gov/rest/json/cves/2.0
- **Coverage**: Official US government vulnerability database
- **Rate Limits**: 5/30s (unauthenticated), 50/30s (authenticated)
- **Authentication**: Optional NVD API key (recommended)
- **Ecosystems**: All major package ecosystems

**Features:**
- Authoritative vulnerability information
- Detailed CVSS scoring
- Comprehensive CVE coverage
- Government-maintained

## Configuration

### Basic Setup

1. **Copy the configuration template:**
   ```bash
   cp config/vulnerability_databases.yaml.example config/vulnerability_databases.yaml
   ```

2. **Edit the configuration file:**
   ```yaml
   vulnerability_manager:
     parallel_queries: true
     timeout: 30s
     merge_results: true
     priority:
       - "osv"
       - "github"
       - "nvd"
   
     databases:
       - type: "osv"
         enabled: true
       - type: "github"
         enabled: true
         # api_key: "ghp_your_token_here"  # Optional but recommended
       - type: "nvd"
         enabled: true
         # api_key: "your_nvd_key_here"    # Optional but recommended
   ```

### API Keys (Recommended)

#### GitHub Token
1. Go to GitHub Settings → Developer settings → Personal access tokens
2. Generate a new token with `public_repo` scope
3. Add to configuration:
   ```yaml
   - type: "github"
     enabled: true
     api_key: "ghp_your_token_here"
   ```

#### NVD API Key
1. Request an API key from https://nvd.nist.gov/developers/request-an-api-key
2. Add to configuration:
   ```yaml
   - type: "nvd"
     enabled: true
     api_key: "your_nvd_key_here"
   ```

## Usage

### Programmatic Usage

```go
package main

import (
    "github.com/Alivanroy/Typosentinel/internal/vulnerability"
    "github.com/Alivanroy/Typosentinel/pkg/types"
)

func main() {
    // Create manager with configuration
    config := &vulnerability.ManagerConfig{
        Databases: []types.VulnerabilityDatabaseConfig{
            {Type: "osv", Enabled: true},
            {Type: "github", Enabled: true},
        },
        ParallelQueries: true,
        MergeResults: true,
    }
    
    manager := vulnerability.NewManager(config)
    
    // Check vulnerabilities for a package
    pkg := &types.Package{
        Name:     "lodash",
        Version:  "4.17.20",
        Registry: "npm",
    }
    
    vulns, err := manager.CheckVulnerabilities(pkg)
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("Found %d vulnerabilities\n", len(vulns))
    for _, vuln := range vulns {
        fmt.Printf("- %s: %s (Severity: %s)\n", 
            vuln.ID, vuln.Title, vuln.Severity)
    }
}
```

### Command Line Usage

The vulnerability databases are automatically integrated into the main Typosentinel CLI:

```bash
# Scan with vulnerability checking enabled
typosentinel scan --package lodash@4.17.20 --registry npm --check-vulnerabilities

# Scan project with vulnerability database integration
typosentinel scan --project-path ./my-project --enable-vulnerability-db
```

## Features

### Parallel Querying
Query multiple databases simultaneously for faster results:
```yaml
vulnerability_manager:
  parallel_queries: true  # Enable parallel database queries
  timeout: 30s           # Overall timeout for all queries
```

### Result Merging and Deduplication
Combine results from multiple databases and remove duplicates:
```yaml
vulnerability_manager:
  merge_results: true      # Merge results from all databases
  deduplicate_by_id: true  # Remove duplicate vulnerabilities
```

### Database Priority
Define which databases to query first:
```yaml
vulnerability_manager:
  priority:
    - "osv"      # Query OSV first (fastest)
    - "github"   # Then GitHub (comprehensive)
    - "nvd"      # Finally NVD (authoritative)
```

### Caching
Cache vulnerability data to reduce API calls:
```yaml
caching:
  enabled: true
  vulnerability_ttl: 24h
  backend: "memory"  # or "redis" or "file"
```

### Rate Limiting
Built-in rate limiting respects API limits:
```yaml
rate_limiting:
  osv:
    requests_per_minute: 600
  github:
    authenticated_requests_per_hour: 5000
  nvd:
    authenticated_requests_per_30_seconds: 50
```

## Performance Considerations

### Recommended Settings for Production

```yaml
vulnerability_manager:
  parallel_queries: true     # Faster results
  timeout: 30s              # Reasonable timeout
  cache_enabled: true       # Reduce API calls
  cache_ttl: 24h           # Daily cache refresh
  
  databases:
    - type: "osv"
      enabled: true
      timeout: 10s          # OSV is fastest
    - type: "github"
      enabled: true
      api_key: "your_token" # Higher rate limits
      timeout: 15s
    - type: "nvd"
      enabled: true
      api_key: "your_key"   # Higher rate limits
      timeout: 20s          # NVD can be slower
```

### Performance Tips

1. **Use API Keys**: Significantly higher rate limits
2. **Enable Caching**: Reduces redundant API calls
3. **Parallel Queries**: Faster overall response time
4. **Appropriate Timeouts**: Balance speed vs completeness
5. **Database Priority**: Query fastest databases first

## Monitoring and Alerting

### Metrics Collection
Enable metrics to monitor database performance:
```yaml
monitoring:
  metrics_enabled: true
  alerts:
    response_time_threshold: 10s
    error_rate_threshold: 0.1
    availability_threshold: 0.95
```

### Health Checks
Monitor database availability:
```bash
# Check database health
typosentinel health --check-vulnerability-databases

# Test specific database
typosentinel test-db --database osv
```

## Troubleshooting

### Common Issues

1. **Rate Limiting**
   - **Symptom**: HTTP 429 errors
   - **Solution**: Add API keys or reduce query frequency
   
2. **Timeout Errors**
   - **Symptom**: Context deadline exceeded
   - **Solution**: Increase timeout values in configuration
   
3. **Authentication Errors**
   - **Symptom**: HTTP 401/403 errors
   - **Solution**: Verify API keys are correct and have proper permissions

4. **Network Issues**
   - **Symptom**: Connection refused or DNS errors
   - **Solution**: Check network connectivity and firewall settings

### Debug Mode
Enable debug logging for troubleshooting:
```yaml
development:
  debug_logging: true
```

### Testing Configuration
Test your configuration:
```bash
# Test all configured databases
typosentinel test-vulnerability-config

# Test specific package lookup
typosentinel test-vulnerability --package lodash@4.17.20
```

## Migration from Single Database

If you're currently using only the NVD database:

1. **Backup current configuration**
2. **Add new database configurations**
3. **Test with a subset of packages**
4. **Gradually enable all databases**
5. **Monitor performance and adjust timeouts**

## Best Practices

1. **Use Multiple Databases**: Different databases have different coverage
2. **Enable Caching**: Reduces API calls and improves performance
3. **Set Appropriate Timeouts**: Balance speed vs completeness
4. **Monitor Performance**: Track response times and error rates
5. **Use API Keys**: Get higher rate limits and better reliability
6. **Regular Updates**: Keep vulnerability data fresh
7. **Test Configuration**: Verify setup before production deployment

## API Reference

### VulnerabilityDatabase Interface
```go
type VulnerabilityDatabase interface {
    CheckVulnerabilities(pkg *Package) ([]*Vulnerability, error)
    GetVulnerabilityByID(id string) (*Vulnerability, error)
    SearchVulnerabilities(query string) ([]*Vulnerability, error)
}
```

### Manager Methods
```go
// Create new manager
func NewManager(config *ManagerConfig) *Manager

// Check vulnerabilities across all databases
func (m *Manager) CheckVulnerabilities(pkg *Package) ([]*Vulnerability, error)

// Get specific vulnerability by ID
func (m *Manager) GetVulnerabilityByID(id string) (*Vulnerability, error)

// Search vulnerabilities by query
func (m *Manager) SearchVulnerabilities(query string) ([]*Vulnerability, error)

// Add/remove databases dynamically
func (m *Manager) AddDatabase(name string, db VulnerabilityDatabase)
func (m *Manager) RemoveDatabase(name string)
```

## Contributing

To add support for additional vulnerability databases:

1. Implement the `VulnerabilityDatabase` interface
2. Add database-specific configuration options
3. Update the manager to support the new database type
4. Add tests and documentation
5. Submit a pull request

## License

This vulnerability database integration is part of Typosentinel and follows the same license terms.