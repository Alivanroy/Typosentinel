# Enterprise Large-Scale Configuration
# Optimized for 1000+ repositories with high-performance requirements

# Repository scanning configuration
repository:
  connectors:
    github:
      enabled: true
      token: "${GITHUB_TOKEN}"
      base_url: "https://api.github.com"
      # Support for multiple organizations
      organizations: 
        - "company-frontend"
        - "company-backend"
        - "company-mobile"
        - "company-devops"
        - "company-data"
      discovery:
        enabled: true
        include_forks: false
        include_archived: false
        # Filter by languages to reduce scope
        languages: ["javascript", "typescript", "python", "go", "java", "csharp"]
        # Exclude test and documentation repositories
        exclude_patterns:
          - "*-test"
          - "*-docs"
          - "*-examples"
        # Only scan repositories with recent activity
        min_last_activity_days: 30
        # Batch processing for large organizations
        batch_size: 100
        rate_limit:
          requests_per_hour: 4000
          burst_limit: 100
    
    gitlab:
      enabled: true
      token: "${GITLAB_TOKEN}"
      base_url: "https://gitlab.company.com/api/v4"
      groups: ["engineering", "platform", "security"]
      discovery:
        enabled: true
        include_subgroups: true
        visibility: ["internal", "private"]
        min_access_level: "developer"
        batch_size: 50
    
    azure_devops:
      enabled: true
      token: "${AZURE_DEVOPS_TOKEN}"
      organization: "company"
      projects: ["Platform", "Applications", "Infrastructure"]
      discovery:
        enabled: true
        include_disabled: false
        batch_size: 25
    
    bitbucket:
      enabled: true
      username: "${BITBUCKET_USERNAME}"
      app_password: "${BITBUCKET_APP_PASSWORD}"
      workspaces: ["company-workspace"]
      discovery:
        enabled: true
        include_forks: false
        batch_size: 50

# High-performance scanning configuration
scanning:
  # Optimize for large-scale scanning
  concurrency: 50
  timeout: "45m"
  batch_size: 100
  
  # Memory and resource management
  memory_limit: "8GB"
  cpu_limit: 80  # Percentage
  
  # Advanced caching for performance
  cache:
    enabled: true
    type: "redis"
    redis:
      address: "redis://redis-cluster:6379"
      password: "${REDIS_PASSWORD}"
      db: 0
      pool_size: 100
      max_retries: 3
    ttl: "24h"
    max_size: "2GB"
  
  # Distributed scanning
  distributed:
    enabled: true
    worker_nodes: 5
    coordination:
      type: "redis"
      redis:
        address: "redis://redis-cluster:6379"
        channel: "typosentinel-coordination"
  
  # File processing optimization
  file_processing:
    max_file_size: "50MB"
    exclude_patterns:
      - "node_modules/**"
      - "vendor/**"
      - ".git/**"
      - "*.min.js"
      - "*.bundle.js"
      - "dist/**"
      - "build/**"
    
    # Parallel file processing
    file_workers: 20
    chunk_size: 1000

# Scheduler configuration for automated scanning
scheduler:
  enabled: true
  # Staggered scanning to distribute load
  schedules:
    - name: "critical-repos"
      cron: "0 1 * * *"  # Daily at 1 AM
      repositories:
        - pattern: "company-*/critical-*"
        - pattern: "*/production-*"
      priority: "high"
    
    - name: "regular-repos"
      cron: "0 3 * * 1,3,5"  # Monday, Wednesday, Friday at 3 AM
      repositories:
        - pattern: "company-*/*"
        - exclude: "*/test-*"
        - exclude: "*/demo-*"
      priority: "normal"
    
    - name: "experimental-repos"
      cron: "0 5 * * 0"  # Sunday at 5 AM
      repositories:
        - pattern: "*/experimental-*"
        - pattern: "*/prototype-*"
      priority: "low"
  
  timezone: "UTC"
  max_concurrent_scans: 10
  
  # Failure handling
  retry:
    max_attempts: 3
    backoff: "exponential"
    initial_delay: "5m"
    max_delay: "1h"

# Enterprise security and compliance
security:
  # Role-based access control
  rbac:
    enabled: true
    provider: "ldap"
    ldap:
      server: "ldaps://ldap.company.com:636"
      bind_dn: "cn=typosentinel,ou=services,dc=company,dc=com"
      bind_password: "${LDAP_PASSWORD}"
      user_base: "ou=users,dc=company,dc=com"
      user_filter: "(uid=%s)"
      group_base: "ou=groups,dc=company,dc=com"
      group_filter: "(member=%s)"
      
      # Role mapping
      role_mapping:
        "cn=security-admins,ou=groups,dc=company,dc=com": "administrator"
        "cn=security-managers,ou=groups,dc=company,dc=com": "security_manager"
        "cn=developers,ou=groups,dc=company,dc=com": "developer"
        "cn=auditors,ou=groups,dc=company,dc=com": "auditor"
  
  # Single Sign-On
  sso:
    enabled: true
    provider: "saml"
    saml:
      entity_id: "typosentinel-enterprise"
      sso_url: "https://sso.company.com/saml/sso"
      slo_url: "https://sso.company.com/saml/slo"
      certificate_file: "/etc/typosentinel/sso-cert.pem"
      private_key_file: "/etc/typosentinel/sso-key.pem"
      
      attribute_mapping:
        username: "NameID"
        email: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
        display_name: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"
        groups: "http://schemas.microsoft.com/ws/2008/06/identity/claims/groups"
  
  # Multi-factor authentication
  mfa:
    enabled: true
    providers: ["totp", "webauthn"]
    required_for_roles: ["administrator", "security_manager"]
    grace_period: "24h"

# Policy management
policies:
  enforcement:
    enabled: true
    mode: "strict"  # strict, permissive, audit
    
  # Security policies
  security:
    - id: "block-critical-threats"
      name: "Block Critical Security Threats"
      enabled: true
      conditions:
        - field: "threat.severity"
          operator: "eq"
          value: "critical"
      actions:
        - type: "block"
          message: "Critical security threat detected"
        - type: "notify"
          channels: ["security-team", "pagerduty"]
        - type: "create_ticket"
          system: "jira"
          project: "SEC"
    
    - id: "high-risk-approval"
      name: "Require Approval for High Risk Packages"
      enabled: true
      conditions:
        - field: "risk_score"
          operator: "gte"
          value: 0.8
      actions:
        - type: "require_approval"
          approvers: ["security-managers"]
          timeout: "24h"
        - type: "notify"
          channels: ["security-team"]
  
  # Compliance policies
  compliance:
    - id: "license-compliance"
      name: "License Compliance Check"
      enabled: true
      conditions:
        - field: "license"
          operator: "not_in"
          value: ["MIT", "Apache-2.0", "BSD-3-Clause", "ISC"]
      actions:
        - type: "require_approval"
          approvers: ["legal-team"]
        - type: "notify"
          channels: ["legal-team"]
    
    - id: "gdpr-compliance"
      name: "GDPR Data Processing Compliance"
      enabled: true
      conditions:
        - field: "package.categories"
          operator: "contains"
          value: "data-processing"
      actions:
        - type: "require_approval"
          approvers: ["privacy-team"]
        - type: "audit_log"
          retention: "7y"

# Advanced output and reporting
output:
  formats: ["sarif", "spdx", "cyclonedx", "json", "dashboard"]
  
  # Database storage for enterprise reporting
  storage:
    type: "postgresql"
    postgresql:
      host: "postgres-cluster.company.com"
      port: 5432
      database: "typosentinel"
      username: "typosentinel"
      password: "${POSTGRES_PASSWORD}"
      ssl_mode: "require"
      max_connections: 100
      connection_timeout: "30s"
    
    # Data retention
    retention:
      scan_results: "2y"
      audit_logs: "7y"
      metrics: "1y"
      reports: "5y"
  
  # Report generation
  reports:
    executive_dashboard:
      enabled: true
      schedule: "0 8 * * 1"  # Monday at 8 AM
      recipients: ["executives@company.com"]
      format: "html"
      include_trends: true
      time_range: "30d"
    
    security_summary:
      enabled: true
      schedule: "0 9 * * *"  # Daily at 9 AM
      recipients: ["security-team@company.com"]
      format: "json"
      include_details: true
    
    compliance_report:
      enabled: true
      schedule: "0 10 1 * *"  # First day of month at 10 AM
      recipients: ["compliance@company.com"]
      format: "pdf"
      include_evidence: true

# Monitoring and observability
monitoring:
  # Prometheus metrics
  prometheus:
    enabled: true
    port: 9090
    path: "/metrics"
    
    # Custom metrics
    custom_metrics:
      - name: "repositories_scanned_total"
        type: "counter"
        help: "Total number of repositories scanned"
        labels: ["platform", "organization"]
      
      - name: "scan_duration_seconds"
        type: "histogram"
        help: "Time taken to scan repositories"
        buckets: [1, 5, 10, 30, 60, 300, 600]
      
      - name: "threats_detected_total"
        type: "counter"
        help: "Total number of threats detected"
        labels: ["severity", "type"]
  
  # Health checks
  health:
    enabled: true
    port: 8081
    path: "/health"
    
    checks:
      - name: "database"
        type: "postgresql"
        timeout: "5s"
      
      - name: "redis"
        type: "redis"
        timeout: "3s"
      
      - name: "ldap"
        type: "ldap"
        timeout: "10s"
  
  # Alerting
  alerts:
    - name: "high_threat_detection_rate"
      condition: "rate(threats_detected_total[5m]) > 10"
      duration: "2m"
      severity: "critical"
      channels: ["pagerduty", "slack-security"]
      
    - name: "scan_failure_rate_high"
      condition: "rate(scan_failures_total[10m]) / rate(scans_total[10m]) > 0.1"
      duration: "5m"
      severity: "warning"
      channels: ["slack-engineering"]
      
    - name: "database_connection_issues"
      condition: "up{job=\"typosentinel-db\"} == 0"
      duration: "1m"
      severity: "critical"
      channels: ["pagerduty", "slack-infrastructure"]

# Integration with external systems
integrations:
  # SIEM integration
  siem:
    splunk:
      enabled: true
      endpoint: "https://splunk.company.com:8088/services/collector"
      token: "${SPLUNK_HEC_TOKEN}"
      index: "security"
      source: "typosentinel"
      sourcetype: "json"
      
      # High-performance streaming
      streaming:
        enabled: true
        batch_size: 1000
        flush_interval: "10s"
        compression: true
        
      # Event filtering
      filters:
        - field: "severity"
          operator: "in"
          value: ["high", "critical"]
  
  # Ticketing system
  ticketing:
    jira:
      enabled: true
      url: "https://company.atlassian.net"
      username: "${JIRA_USERNAME}"
      api_token: "${JIRA_API_TOKEN}"
      
      # Automatic ticket creation
      auto_create:
        enabled: true
        project: "SEC"
        issue_type: "Security Issue"
        priority_mapping:
          critical: "Highest"
          high: "High"
          medium: "Medium"
          low: "Low"
  
  # Notification systems
  notifications:
    slack:
      enabled: true
      webhook_url: "${SLACK_WEBHOOK_URL}"
      channels:
        security-team: "#security-alerts"
        engineering: "#engineering-alerts"
        executives: "#executive-summary"
    
    email:
      enabled: true
      smtp:
        host: "smtp.company.com"
        port: 587
        username: "${SMTP_USERNAME}"
        password: "${SMTP_PASSWORD}"
        tls: true
      
      templates:
        threat_detected: "/etc/typosentinel/templates/threat-email.html"
        scan_complete: "/etc/typosentinel/templates/scan-complete.html"
    
    pagerduty:
      enabled: true
      integration_key: "${PAGERDUTY_INTEGRATION_KEY}"
      severity_mapping:
        critical: "critical"
        high: "error"
        medium: "warning"
        low: "info"

# Performance optimization
performance:
  # Connection pooling
  connection_pools:
    database:
      max_connections: 100
      max_idle: 10
      max_lifetime: "1h"
    
    redis:
      max_connections: 200
      max_idle: 20
      max_lifetime: "30m"
    
    http:
      max_connections: 500
      max_idle_per_host: 50
      timeout: "30s"
  
  # Resource limits
  limits:
    memory: "16GB"
    cpu: "8"
    disk: "100GB"
    
    # Per-operation limits
    scan_timeout: "45m"
    analysis_timeout: "10m"
    report_timeout: "5m"
  
  # Optimization settings
  optimization:
    enable_compression: true
    enable_caching: true
    cache_compression: true
    
    # Garbage collection tuning
    gc:
      target_percentage: 100
      memory_limit: "12GB"

# Logging configuration
logging:
  level: "info"
  format: "json"
  
  outputs:
    - type: "file"
      path: "/var/log/typosentinel/app.log"
      max_size: "100MB"
      max_backups: 10
      max_age: 30
      compress: true
    
    - type: "syslog"
      network: "tcp"
      address: "syslog.company.com:514"
      facility: "local0"
    
    - type: "elasticsearch"
      addresses: ["elasticsearch-cluster.company.com:9200"]
      index: "typosentinel-logs"
      username: "${ELASTICSEARCH_USERNAME}"
      password: "${ELASTICSEARCH_PASSWORD}"
  
  # Structured logging
  fields:
    service: "typosentinel-enterprise"
    environment: "production"
    datacenter: "us-east-1"
    version: "${VERSION}"

# Audit configuration
audit:
  enabled: true
  
  # Audit events
  events:
    - "user.login"
    - "user.logout"
    - "policy.create"
    - "policy.update"
    - "policy.delete"
    - "scan.start"
    - "scan.complete"
    - "threat.detected"
    - "approval.granted"
    - "approval.denied"
  
  # Audit storage
  storage:
    type: "database"
    encryption: true
    retention: "7y"
    
  # Audit reporting
  reports:
    enabled: true
    schedule: "0 0 1 * *"  # Monthly
    recipients: ["audit@company.com"]
    format: "pdf"
    include_statistics: true