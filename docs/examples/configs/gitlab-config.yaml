# GitLab Platform Configuration Example
# This file demonstrates comprehensive GitLab integration for TypoSentinel

# GitLab Platform Configuration
gitlab:
  # GitLab API Configuration
  api:
    # Base URL for GitLab API (use https://gitlab.com/api/v4 for GitLab.com)
    base_url: "https://gitlab.com/api/v4"
    
    # API version
    version: "v4"
    
    # Request timeout
    timeout: "30s"
    
    # User agent for API requests
    user_agent: "TypoSentinel/1.0"

  # Authentication Configuration
  authentication:
    # Method 1: Personal Access Token (Recommended)
    personal_token:
      token: "${GITLAB_TOKEN}"
      scopes:
        - "read_api"
        - "read_repository"
        - "read_user"
        - "read_registry"
    
    # Method 2: OAuth2 Application
    oauth2:
      client_id: "${GITLAB_CLIENT_ID}"
      client_secret: "${GITLAB_CLIENT_SECRET}"
      redirect_uri: "${GITLAB_REDIRECT_URI}"
      scopes:
        - "read_api"
        - "read_repository"
    
    # Method 3: Deploy Token (for specific projects)
    deploy_token:
      username: "${GITLAB_DEPLOY_USERNAME}"
      token: "${GITLAB_DEPLOY_TOKEN}"
      scopes:
        - "read_repository"
        - "read_registry"

  # Rate Limiting Configuration
  rate_limit:
    # Requests per minute (GitLab default: 2000 for authenticated users)
    requests_per_minute: 2000
    
    # Burst capacity for short-term spikes
    burst: 50
    
    # Delay between retries when rate limited
    retry_delay: "5s"
    
    # Maximum number of retries
    max_retries: 3
    
    # Enable adaptive rate limiting
    adaptive: true

  # Repository Discovery Configuration
  discovery:
    # Groups to scan
    groups:
      - name: "mycompany"
        # Group-specific filters
        filters:
          include_private: true
          include_archived: false
          include_forks: false
          languages: ["JavaScript", "Python", "Go", "Java"]
          min_stars: 1
          topics: ["security", "api", "library"]
          exclude_patterns: ["test-*", "demo-*", "archived-*"]
          visibility: "private"  # private, internal, public
      
      - name: "security-team"
        filters:
          include_private: true
          languages: ["Python", "Go"]
          topics: ["security", "vulnerability"]
          visibility: "internal"
    
    # Individual users to scan
    users:
      - name: "security-engineer"
        filters:
          include_private: false
          languages: ["Python", "Go"]
          min_stars: 5
          visibility: "public"
    
    # Specific projects to include
    projects:
      - "mycompany/critical-app"
      - "mycompany/security-tools"
      - "security-team/vulnerability-scanner"
      - id: 12345  # Project ID
        name: "special-project"
    
    # Search queries for advanced discovery
    search_queries:
      - query: "group:mycompany language:go"
        description: "Go projects in mycompany group"
      - query: "topic:security"
        description: "Security-related projects"
      - query: "user:security-engineer language:python"
        description: "Python projects from security engineer"
    
    # Discovery scheduling
    schedule:
      # How often to run discovery
      interval: "1h"
      
      # Maximum projects to discover per run
      max_projects_per_run: 1000
      
      # Timeout for discovery operations
      timeout: "10m"

  # Webhook Configuration
  webhooks:
    enabled: true
    
    # Webhook endpoint URL
    endpoint: "https://typosentinel.example.com/webhooks/gitlab"
    
    # Webhook secret for validation
    secret: "${GITLAB_WEBHOOK_SECRET}"
    
    # SSL verification
    ssl_verification: true
    
    # Events to subscribe to
    events:
      - "push"
      - "merge_request"
      - "release"
      - "repository"
      - "pipeline"
      - "deployment"
    
    # Webhook security settings
    security:
      # Validate webhook signatures
      validate_signature: true
      
      # Allowed IP ranges (GitLab.com webhook IPs)
      allowed_ips:
        - "34.74.90.64/28"
        - "34.74.226.0/24"
        - "35.231.147.226/32"
      
      # Rate limiting for webhooks
      rate_limit: 100

  # GitLab Self-Hosted Configuration
  self_hosted:
    enabled: false
    
    # Self-hosted GitLab URL
    base_url: "https://gitlab.company.com/api/v4"
    
    # Self-hosted specific settings
    settings:
      # Skip SSL verification (for self-signed certificates)
      skip_ssl_verify: false
      
      # Custom CA certificate path
      ca_cert_path: "/path/to/ca-cert.pem"
      
      # Custom API version
      api_version: "v4"
      
      # Admin token for enhanced access
      admin_token: "${GITLAB_ADMIN_TOKEN}"

  # GitLab CI/CD Integration
  ci_cd:
    enabled: true
    
    # Pipeline triggers
    triggers:
      # Trigger scan on pipeline completion
      on_pipeline_success: true
      
      # Trigger scan on merge request
      on_merge_request: true
      
      # Trigger scan on release
      on_release: true
    
    # GitLab CI variables to set
    variables:
      TYPOSENTINEL_SCAN: "true"
      TYPOSENTINEL_ENDPOINT: "https://typosentinel.example.com"
    
    # Job configuration for GitLab CI
    job_template:
      stage: "security"
      image: "typosentinel/scanner:latest"
      script:
        - "typosentinel scan --format sarif --output security-report.sarif"
      artifacts:
        reports:
          sast: "security-report.sarif"
        expire_in: "1 week"

  # Scanning Configuration
  scanning:
    # Package managers to analyze
    package_managers:
      - "npm"
      - "pip"
      - "go"
      - "maven"
      - "nuget"
      - "composer"
      - "cargo"
      - "rubygems"
    
    # File patterns to include
    include_patterns:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/yarn.lock"
      - "**/requirements.txt"
      - "**/Pipfile"
      - "**/go.mod"
      - "**/go.sum"
      - "**/pom.xml"
      - "**/build.gradle"
      - "**/Cargo.toml"
      - "**/composer.json"
      - "**/Gemfile"
    
    # File patterns to exclude
    exclude_patterns:
      - "**/node_modules/**"
      - "**/vendor/**"
      - "**/.git/**"
      - "**/test/**"
      - "**/tests/**"
      - "**/__pycache__/**"
      - "**/target/**"
      - "**/build/**"
      - "**/dist/**"
    
    # Maximum file size to scan (in bytes)
    max_file_size: 10485760  # 10MB
    
    # Scan timeout per project
    timeout: "30m"
    
    # Concurrent scans
    concurrency: 5

  # GitLab Container Registry Integration
  container_registry:
    enabled: true
    
    # Registry URL
    url: "registry.gitlab.com"
    
    # Authentication for registry
    auth:
      username: "${GITLAB_REGISTRY_USERNAME}"
      password: "${GITLAB_REGISTRY_PASSWORD}"
    
    # Scan container images
    scan_images: true
    
    # Image patterns to scan
    image_patterns:
      - "*/security/*"
      - "*/production/*"
    
    # Exclude patterns
    exclude_patterns:
      - "*/test/*"
      - "*/dev/*"

  # Caching Configuration
  cache:
    enabled: true
    
    # Cache backend (redis, memory, file)
    backend: "redis"
    
    # Cache TTL for different data types
    ttl:
      projects: "24h"
      groups: "12h"
      users: "6h"
      search_results: "1h"
      pipelines: "30m"
    
    # Redis configuration (if using redis backend)
    redis:
      host: "localhost"
      port: 6379
      password: "${REDIS_PASSWORD}"
      database: 1
      pool_size: 10

  # Monitoring and Metrics
  monitoring:
    enabled: true
    
    # Metrics to collect
    metrics:
      - "api_requests_total"
      - "api_request_duration"
      - "rate_limit_remaining"
      - "projects_discovered"
      - "scan_duration"
      - "webhook_events_received"
      - "pipeline_triggers"
    
    # Health check configuration
    health_check:
      enabled: true
      interval: "5m"
      timeout: "30s"
      endpoints:
        - "https://gitlab.com/api/v4/version"

  # Logging Configuration
  logging:
    level: "info"
    
    # Log API requests and responses
    log_requests: false
    
    # Log webhook events
    log_webhooks: true
    
    # Log CI/CD events
    log_ci_events: true
    
    # Sensitive fields to redact from logs
    redact_fields:
      - "token"
      - "password"
      - "secret"
      - "private_key"

# Integration with TypoSentinel Core
integration:
  # Enable GitLab integration
  enabled: true
  
  # Priority for this platform (higher = more priority)
  priority: 2
  
  # Tags to apply to all GitLab projects
  tags:
    - "gitlab"
    - "git"
    - "source-control"
    - "ci-cd"
  
  # Custom metadata to include
  metadata:
    platform: "gitlab"
    source: "api"
    version: "v1"
    supports_ci: true