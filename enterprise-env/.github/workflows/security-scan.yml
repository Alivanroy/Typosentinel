name: Enterprise Security Scan

on:
  push:
    branches: [ main, develop, release/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM

jobs:
  security-scan:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [frontend, backend, auth-service, payment-service, notification-service, analytics-service]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      if: contains(matrix.service, 'frontend') || contains(matrix.service, 'service')
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup Go
      if: contains(matrix.service, 'backend') || contains(matrix.service, 'analytics')
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Download TypoSentinel
      run: |
        wget https://github.com/typosentinel/releases/latest/download/typosentinel-linux
        chmod +x typosentinel-linux
        
    - name: Run Security Scan
      run: |
        ./typosentinel-linux scan ${{ matrix.service }} \
          --output json \
          --deep-analysis \
          --include-dev-dependencies \
          --vulnerability-check \
          --supply-chain-analysis \
          > security-report-${{ matrix.service }}.json
          
    - name: Run Edge Algorithm Analysis
      run: |
        ./typosentinel-linux edge aicc ${{ matrix.service }} \
          --include-correlation \
          --adaptive \
          --output json \
          > edge-analysis-${{ matrix.service }}.json
          
    - name: Generate Dependency Graph
      run: |
        ./typosentinel-linux graph generate ${{ matrix.service }} \
          --format svg \
          --include-dev \
          --max-depth 5 \
          > dependency-graph-${{ matrix.service }}.svg
          
    - name: Upload Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports-${{ matrix.service }}
        path: |
          security-report-${{ matrix.service }}.json
          edge-analysis-${{ matrix.service }}.json
          dependency-graph-${{ matrix.service }}.svg
          
    - name: Check for Critical Threats
      run: |
        CRITICAL_COUNT=$(jq '.summary.critical_threats' security-report-${{ matrix.service }}.json)
        HIGH_COUNT=$(jq '.summary.high_threats' security-report-${{ matrix.service }}.json)
        
        if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 5 ]; then
          echo "❌ Security scan failed: Found $CRITICAL_COUNT critical and $HIGH_COUNT high threats"
          exit 1
        else
          echo "✅ Security scan passed: $CRITICAL_COUNT critical, $HIGH_COUNT high threats"
        fi
        
    - name: Post to Slack
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: 'Security scan failed for ${{ matrix.service }}'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  aggregate-results:
    needs: security-scan
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: Aggregate Security Reports
      run: |
        echo '{"enterprise_security_summary": {' > enterprise-security-summary.json
        echo '"scan_timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",' >> enterprise-security-summary.json
        echo '"services": [' >> enterprise-security-summary.json
        
        for service in frontend backend auth-service payment-service notification-service analytics-service; do
          if [ -f "security-reports-$service/security-report-$service.json" ]; then
            echo "\"$service\": $(cat security-reports-$service/security-report-$service.json)," >> enterprise-security-summary.json
          fi
        done
        
        echo ']}}' >> enterprise-security-summary.json
        
    - name: Upload Aggregated Report
      uses: actions/upload-artifact@v3
      with:
        name: enterprise-security-summary
        path: enterprise-security-summary.json
        
    - name: Send Enterprise Security Report
      run: |
        curl -X POST "${{ secrets.SECURITY_WEBHOOK_URL }}" \
          -H "Content-Type: application/json" \
          -d @enterprise-security-summary.json