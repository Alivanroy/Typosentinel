# Bitbucket Platform Configuration Example
# This file demonstrates comprehensive Bitbucket integration for TypoSentinel

# Bitbucket Platform Configuration
bitbucket:
  # Bitbucket API Configuration
  api:
    # Base URL for Bitbucket API (use https://api.bitbucket.org/2.0 for Bitbucket Cloud)
    base_url: "https://api.bitbucket.org/2.0"
    
    # API version
    version: "2.0"
    
    # Request timeout
    timeout: "30s"
    
    # User agent for API requests
    user_agent: "TypoSentinel/1.0"

  # Authentication Configuration
  authentication:
    # Method 1: App Password (Recommended for Bitbucket Cloud)
    app_password:
      username: "${BITBUCKET_USERNAME}"
      password: "${BITBUCKET_APP_PASSWORD}"
      permissions:
        - "repositories:read"
        - "account:read"
        - "team:read"
        - "pullrequests:read"
    
    # Method 2: OAuth2 Consumer
    oauth2:
      client_id: "${BITBUCKET_CLIENT_ID}"
      client_secret: "${BITBUCKET_CLIENT_SECRET}"
      redirect_uri: "${BITBUCKET_REDIRECT_URI}"
      scopes:
        - "repositories"
        - "account"
        - "team"
    
    # Method 3: Repository Access Token (for specific repositories)
    repository_token:
      token: "${BITBUCKET_REPO_TOKEN}"
      repository: "myworkspace/myrepo"
      permissions:
        - "repository:read"
        - "pullrequest:read"

  # Rate Limiting Configuration
  rate_limit:
    # Requests per hour (Bitbucket default: 1000 for authenticated users)
    requests_per_hour: 1000
    
    # Burst capacity for short-term spikes
    burst: 25
    
    # Delay between retries when rate limited
    retry_delay: "10s"
    
    # Maximum number of retries
    max_retries: 3
    
    # Enable adaptive rate limiting
    adaptive: true

  # Repository Discovery Configuration
  discovery:
    # Workspaces to scan (Bitbucket Cloud)
    workspaces:
      - name: "myworkspace"
        # Workspace-specific filters
        filters:
          include_private: true
          include_forks: false
          languages: ["JavaScript", "Python", "Go", "Java"]
          exclude_patterns: ["test-*", "demo-*", "archived-*"]
          project_keys: ["PROJ1", "PROJ2"]  # Specific projects within workspace
      
      - name: "security-workspace"
        filters:
          include_private: true
          languages: ["Python", "Go"]
          project_keys: ["SEC"]
    
    # Individual users to scan
    users:
      - name: "security-engineer"
        filters:
          include_private: false
          languages: ["Python", "Go"]
    
    # Specific repositories to include
    repositories:
      - "myworkspace/critical-app"
      - "myworkspace/security-tools"
      - "security-workspace/vulnerability-scanner"
    
    # Discovery scheduling
    schedule:
      # How often to run discovery
      interval: "2h"
      
      # Maximum repositories to discover per run
      max_repos_per_run: 500
      
      # Timeout for discovery operations
      timeout: "15m"

  # Webhook Configuration
  webhooks:
    enabled: true
    
    # Webhook endpoint URL
    endpoint: "https://typosentinel.example.com/webhooks/bitbucket"
    
    # Webhook secret for validation
    secret: "${BITBUCKET_WEBHOOK_SECRET}"
    
    # Events to subscribe to
    events:
      - "repo:push"
      - "pullrequest:created"
      - "pullrequest:updated"
      - "pullrequest:approved"
      - "pullrequest:merged"
      - "repo:created"
      - "repo:updated"
    
    # Webhook security settings
    security:
      # Validate webhook signatures
      validate_signature: true
      
      # Allowed IP ranges (Bitbucket Cloud webhook IPs)
      allowed_ips:
        - "104.192.143.0/24"
        - "34.198.203.127/32"
        - "34.198.178.64/32"
        - "34.198.32.85/32"
      
      # Rate limiting for webhooks
      rate_limit: 50

  # Bitbucket Server Configuration (On-Premise)
  server:
    enabled: false
    
    # Bitbucket Server URL
    base_url: "https://bitbucket.company.com/rest/api/1.0"
    
    # Server-specific settings
    settings:
      # Skip SSL verification (for self-signed certificates)
      skip_ssl_verify: false
      
      # Custom CA certificate path
      ca_cert_path: "/path/to/ca-cert.pem"
      
      # API version for Bitbucket Server
      api_version: "1.0"
    
    # Authentication for Bitbucket Server
    authentication:
      # HTTP Basic Authentication
      basic_auth:
        username: "${BITBUCKET_SERVER_USERNAME}"
        password: "${BITBUCKET_SERVER_PASSWORD}"
      
      # Personal Access Token (Bitbucket Server 5.5+)
      personal_token:
        token: "${BITBUCKET_SERVER_TOKEN}"
        permissions:
          - "PROJECT_READ"
          - "REPO_READ"

  # Bitbucket Pipelines Integration
  pipelines:
    enabled: true
    
    # Pipeline triggers
    triggers:
      # Trigger scan on pipeline completion
      on_pipeline_success: true
      
      # Trigger scan on pull request
      on_pull_request: true
      
      # Trigger scan on deployment
      on_deployment: true
    
    # Pipeline variables to set
    variables:
      TYPOSENTINEL_SCAN: "true"
      TYPOSENTINEL_ENDPOINT: "https://typosentinel.example.com"
    
    # Pipeline configuration template
    pipeline_template:
      image: "typosentinel/scanner:latest"
      script:
        - "typosentinel scan --format sarif --output security-report.sarif"
      artifacts:
        - "security-report.sarif"
      caches:
        - "node"
        - "pip"

  # Scanning Configuration
  scanning:
    # Package managers to analyze
    package_managers:
      - "npm"
      - "pip"
      - "go"
      - "maven"
      - "nuget"
      - "composer"
      - "cargo"
      - "rubygems"
    
    # File patterns to include
    include_patterns:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/yarn.lock"
      - "**/requirements.txt"
      - "**/Pipfile"
      - "**/go.mod"
      - "**/go.sum"
      - "**/pom.xml"
      - "**/build.gradle"
      - "**/Cargo.toml"
      - "**/composer.json"
      - "**/Gemfile"
    
    # File patterns to exclude
    exclude_patterns:
      - "**/node_modules/**"
      - "**/vendor/**"
      - "**/.git/**"
      - "**/test/**"
      - "**/tests/**"
      - "**/__pycache__/**"
      - "**/target/**"
      - "**/build/**"
      - "**/dist/**"
    
    # Maximum file size to scan (in bytes)
    max_file_size: 10485760  # 10MB
    
    # Scan timeout per repository
    timeout: "30m"
    
    # Concurrent scans
    concurrency: 3

  # Pull Request Integration
  pull_requests:
    enabled: true
    
    # Automatic scanning on PR creation/update
    auto_scan: true
    
    # Comment on PRs with scan results
    comment_results: true
    
    # Block PRs with critical vulnerabilities
    block_on_critical: true
    
    # PR comment template
    comment_template: |
      ## TypoSentinel Security Scan Results
      
      **Scan Status**: {{.Status}}
      **Threats Found**: {{.ThreatsCount}}
      **Risk Level**: {{.RiskLevel}}
      
      {{if .Threats}}
      ### Detected Threats
      {{range .Threats}}
      - **{{.Type}}**: {{.Description}} (Severity: {{.Severity}})
      {{end}}
      {{end}}
      
      [View Full Report]({{.ReportURL}})

  # Caching Configuration
  cache:
    enabled: true
    
    # Cache backend (redis, memory, file)
    backend: "redis"
    
    # Cache TTL for different data types
    ttl:
      repositories: "24h"
      workspaces: "12h"
      users: "6h"
      pull_requests: "1h"
      pipelines: "30m"
    
    # Redis configuration (if using redis backend)
    redis:
      host: "localhost"
      port: 6379
      password: "${REDIS_PASSWORD}"
      database: 2
      pool_size: 10

  # Monitoring and Metrics
  monitoring:
    enabled: true
    
    # Metrics to collect
    metrics:
      - "api_requests_total"
      - "api_request_duration"
      - "rate_limit_remaining"
      - "repositories_discovered"
      - "scan_duration"
      - "webhook_events_received"
      - "pipeline_triggers"
      - "pull_request_scans"
    
    # Health check configuration
    health_check:
      enabled: true
      interval: "5m"
      timeout: "30s"
      endpoints:
        - "https://api.bitbucket.org/2.0/user"

  # Logging Configuration
  logging:
    level: "info"
    
    # Log API requests and responses
    log_requests: false
    
    # Log webhook events
    log_webhooks: true
    
    # Log pipeline events
    log_pipeline_events: true
    
    # Log pull request events
    log_pr_events: true
    
    # Sensitive fields to redact from logs
    redact_fields:
      - "password"
      - "token"
      - "secret"
      - "client_secret"

# Integration with TypoSentinel Core
integration:
  # Enable Bitbucket integration
  enabled: true
  
  # Priority for this platform (higher = more priority)
  priority: 3
  
  # Tags to apply to all Bitbucket repositories
  tags:
    - "bitbucket"
    - "git"
    - "source-control"
    - "atlassian"
  
  # Custom metadata to include
  metadata:
    platform: "bitbucket"
    source: "api"
    version: "v1"
    supports_pipelines: true