# Multi-Platform Configuration Example
# This file demonstrates how to configure TypoSentinel for multiple platforms simultaneously

# Global Configuration
global:
  # Application settings
  app:
    name: "TypoSentinel Enterprise"
    version: "1.0.0"
    environment: "production"
  
  # Global timeouts
  timeouts:
    api_request: "30s"
    scan_operation: "30m"
    discovery: "15m"
  
  # Global rate limiting
  rate_limit:
    global_requests_per_hour: 10000
    adaptive_limiting: true
    burst_capacity: 200
  
  # Global caching
  cache:
    enabled: true
    backend: "redis"
    redis:
      host: "${REDIS_HOST:localhost}"
      port: 6379
      password: "${REDIS_PASSWORD}"
      database: 0
      pool_size: 20
    ttl:
      default: "1h"
      repositories: "24h"
      organizations: "12h"
      users: "6h"

# Platform Configurations
platforms:
  # GitHub Configuration
  github:
    enabled: true
    priority: 1
    
    api:
      base_url: "https://api.github.com"
      version: "2022-11-28"
      timeout: "30s"
    
    authentication:
      method: "personal_token"  # personal_token, github_app, oauth
      personal_token:
        token: "${GITHUB_TOKEN}"
        scopes: ["repo", "read:org", "read:user", "read:packages"]
    
    rate_limit:
      requests_per_hour: 5000
      burst: 100
      retry_delay: "5s"
      max_retries: 3
    
    discovery:
      organizations: ["mycompany", "security-team"]
      users: ["security-engineer"]
      repositories: ["mycompany/critical-app"]
      search_queries:
        - "org:mycompany language:go stars:>10"
        - "org:mycompany topic:security"
      schedule:
        interval: "1h"
        max_repos_per_run: 1000
    
    webhooks:
      enabled: true
      endpoint: "https://typosentinel.example.com/webhooks/github"
      secret: "${GITHUB_WEBHOOK_SECRET}"
      events: ["push", "pull_request", "release"]
  
  # GitLab Configuration
  gitlab:
    enabled: true
    priority: 2
    
    api:
      base_url: "https://gitlab.com/api/v4"
      version: "v4"
      timeout: "30s"
    
    authentication:
      method: "personal_token"
      personal_token:
        token: "${GITLAB_TOKEN}"
        scopes: ["read_api", "read_repository", "read_user"]
    
    rate_limit:
      requests_per_minute: 2000
      burst: 50
      retry_delay: "5s"
      max_retries: 3
    
    discovery:
      groups: ["mycompany", "security-team"]
      users: ["security-engineer"]
      projects: ["mycompany/critical-app"]
      search_queries:
        - "group:mycompany language:go"
        - "topic:security"
      schedule:
        interval: "1h"
        max_projects_per_run: 1000
    
    webhooks:
      enabled: true
      endpoint: "https://typosentinel.example.com/webhooks/gitlab"
      secret: "${GITLAB_WEBHOOK_SECRET}"
      events: ["push", "merge_request", "release"]
  
  # Bitbucket Configuration
  bitbucket:
    enabled: true
    priority: 3
    
    api:
      base_url: "https://api.bitbucket.org/2.0"
      version: "2.0"
      timeout: "30s"
    
    authentication:
      method: "app_password"
      app_password:
        username: "${BITBUCKET_USERNAME}"
        password: "${BITBUCKET_APP_PASSWORD}"
        permissions: ["repositories:read", "account:read", "team:read"]
    
    rate_limit:
      requests_per_hour: 1000
      burst: 25
      retry_delay: "10s"
      max_retries: 3
    
    discovery:
      workspaces: ["myworkspace", "security-workspace"]
      users: ["security-engineer"]
      repositories: ["myworkspace/critical-app"]
      schedule:
        interval: "2h"
        max_repos_per_run: 500
    
    webhooks:
      enabled: true
      endpoint: "https://typosentinel.example.com/webhooks/bitbucket"
      secret: "${BITBUCKET_WEBHOOK_SECRET}"
      events: ["repo:push", "pullrequest:created", "pullrequest:merged"]
  
  # Azure DevOps Configuration
  azuredevops:
    enabled: true
    priority: 4
    
    api:
      base_url: "https://dev.azure.com"
      version: "7.0"
      timeout: "30s"
    
    authentication:
      method: "personal_token"
      personal_token:
        token: "${AZURE_DEVOPS_TOKEN}"
        scopes: ["vso.code", "vso.project", "vso.build"]
    
    rate_limit:
      requests_per_hour: 3600
      burst: 100
      retry_delay: "5s"
      max_retries: 3
    
    discovery:
      organizations: ["myorganization", "security-org"]
      projects:
        - organization: "myorganization"
          name: "MyProject"
        - organization: "security-org"
          name: "SecurityProject"
      repositories: ["myorganization/MyProject/main-app"]
      schedule:
        interval: "1h"
        max_repos_per_run: 1000
    
    webhooks:
      enabled: true
      endpoint: "https://typosentinel.example.com/webhooks/azuredevops"
      secret: "${AZURE_DEVOPS_WEBHOOK_SECRET}"
      events: ["git.push", "git.pullrequest.created", "build.complete"]

# Repository Discovery Configuration
discovery:
  # Global discovery settings
  global:
    enabled: true
    interval: "1h"
    max_total_repos: 5000
    workers: 8
    timeout: "15m"
  
  # Global filters applied to all platforms
  filters:
    include_private: true
    include_archived: false
    include_forks: false
    min_stars: 1
    languages:
      - "JavaScript"
      - "TypeScript"
      - "Python"
      - "Go"
      - "Java"
      - "C#"
      - "Rust"
      - "PHP"
    exclude_patterns:
      - "test-*"
      - "demo-*"
      - "example-*"
      - "archived-*"
      - "legacy-*"
    topics:
      - "security"
      - "api"
      - "library"
      - "framework"
  
  # Platform-specific discovery overrides
  platform_overrides:
    github:
      max_repos_per_run: 2000
      additional_filters:
        min_stars: 5
    
    gitlab:
      max_repos_per_run: 1500
      additional_filters:
        visibility: "internal"
    
    bitbucket:
      max_repos_per_run: 800
      interval: "2h"
    
    azuredevops:
      max_repos_per_run: 1200
      additional_filters:
        repository_types: ["Git"]

# Scanning Configuration
scanning:
  # Global scanning settings
  global:
    enabled: true
    concurrency: 10
    timeout: "30m"
    retry_attempts: 3
    retry_delay: "5s"
  
  # Package managers to analyze
  package_managers:
    - "npm"
    - "pip"
    - "go"
    - "maven"
    - "nuget"
    - "composer"
    - "cargo"
    - "rubygems"
    - "cocoapods"
  
  # Scan types to perform
  scan_types:
    - "dependency"
    - "vulnerability"
    - "license"
    - "secret"
    - "typosquatting"
    - "malicious_package"
  
  # File patterns
  include_patterns:
    - "**/package.json"
    - "**/package-lock.json"
    - "**/yarn.lock"
    - "**/requirements.txt"
    - "**/Pipfile"
    - "**/go.mod"
    - "**/go.sum"
    - "**/pom.xml"
    - "**/build.gradle"
    - "**/Cargo.toml"
    - "**/composer.json"
    - "**/Gemfile"
    - "**/*.csproj"
    - "**/packages.config"
  
  exclude_patterns:
    - "**/node_modules/**"
    - "**/vendor/**"
    - "**/.git/**"
    - "**/test/**"
    - "**/tests/**"
    - "**/__pycache__/**"
    - "**/target/**"
    - "**/build/**"
    - "**/dist/**"
    - "**/bin/**"
    - "**/obj/**"
  
  # File size limits
  max_file_size: 10485760  # 10MB
  
  # Scanning policies
  policies:
    - name: "critical_vulnerabilities"
      description: "Block repositories with critical vulnerabilities"
      enabled: true
      conditions:
        - field: "vulnerability_severity"
          operator: "eq"
          value: "critical"
      actions:
        - type: "block"
          parameters:
            message: "Critical vulnerabilities detected"
    
    - name: "license_compliance"
      description: "Warn about copyleft licenses"
      enabled: true
      conditions:
        - field: "license_type"
          operator: "in"
          value: ["GPL", "AGPL"]
      actions:
        - type: "warn"
          parameters:
            message: "Copyleft license detected"

# Webhook Configuration
webhooks:
  # Global webhook settings
  global:
    enabled: true
    timeout: "30s"
    retry_attempts: 3
    retry_delay: "5s"
  
  # Security settings
  security:
    validate_signatures: true
    rate_limit: 500
    allowed_ips:
      # GitHub IPs
      - "192.30.252.0/22"
      - "185.199.108.0/22"
      # GitLab IPs
      - "34.74.90.64/28"
      - "34.74.226.0/24"
      # Bitbucket IPs
      - "104.192.143.0/24"
      - "34.198.203.127/32"
  
  # Event processing
  processing:
    async: true
    queue_size: 1000
    workers: 5
    batch_size: 10

# Output Configuration
output:
  # Supported formats
  formats:
    - "json"
    - "sarif"
    - "spdx"
    - "cyclonedx"
    - "csv"
    - "xml"
  
  # Default format
  default_format: "sarif"
  
  # Output destinations
  destinations:
    - type: "file"
      path: "/var/log/typosentinel/"
      format: "json"
    
    - type: "s3"
      bucket: "typosentinel-reports"
      prefix: "scans/"
      format: "sarif"
      credentials:
        access_key: "${AWS_ACCESS_KEY}"
        secret_key: "${AWS_SECRET_KEY}"
        region: "us-east-1"
    
    - type: "webhook"
      url: "https://siem.company.com/api/security-events"
      format: "json"
      headers:
        Authorization: "Bearer ${SIEM_TOKEN}"
        Content-Type: "application/json"

# Monitoring and Alerting
monitoring:
  # Metrics collection
  metrics:
    enabled: true
    interval: "1m"
    retention: "30d"
    
    # Prometheus integration
    prometheus:
      enabled: true
      endpoint: "/metrics"
      port: 9090
    
    # Custom metrics
    custom_metrics:
      - "platform_scan_duration"
      - "threats_detected_by_platform"
      - "api_rate_limit_usage"
      - "webhook_processing_time"
  
  # Health checks
  health_checks:
    enabled: true
    interval: "5m"
    timeout: "30s"
    endpoints:
      - name: "github"
        url: "https://api.github.com/rate_limit"
      - name: "gitlab"
        url: "https://gitlab.com/api/v4/version"
      - name: "bitbucket"
        url: "https://api.bitbucket.org/2.0/user"
      - name: "azuredevops"
        url: "https://dev.azure.com/_apis/profile/profiles/me"
  
  # Alerting
  alerting:
    enabled: true
    
    # Alert channels
    channels:
      - type: "email"
        recipients: ["security-team@company.com"]
        smtp:
          host: "smtp.company.com"
          port: 587
          username: "${SMTP_USERNAME}"
          password: "${SMTP_PASSWORD}"
      
      - type: "slack"
        webhook_url: "${SLACK_WEBHOOK_URL}"
        channel: "#security-alerts"
      
      - type: "pagerduty"
        integration_key: "${PAGERDUTY_INTEGRATION_KEY}"
    
    # Alert rules
    rules:
      - name: "critical_threats"
        condition: "threats.severity == 'critical'"
        channels: ["email", "slack", "pagerduty"]
      
      - name: "platform_down"
        condition: "health_check.status == 'down'"
        channels: ["email", "pagerduty"]
      
      - name: "rate_limit_exceeded"
        condition: "rate_limit.remaining < 100"
        channels: ["slack"]

# Logging Configuration
logging:
  level: "info"
  format: "json"
  
  # Log destinations
  destinations:
    - type: "file"
      path: "/var/log/typosentinel/app.log"
      max_size: "100MB"
      max_backups: 10
      max_age: "30d"
    
    - type: "syslog"
      network: "udp"
      address: "localhost:514"
      facility: "local0"
    
    - type: "elasticsearch"
      url: "https://elasticsearch.company.com:9200"
      index: "typosentinel-logs"
      username: "${ELASTICSEARCH_USERNAME}"
      password: "${ELASTICSEARCH_PASSWORD}"
  
  # Log filtering
  filters:
    # Sensitive fields to redact
    redact_fields:
      - "token"
      - "password"
      - "secret"
      - "private_key"
      - "client_secret"
    
    # Log levels by component
    component_levels:
      github: "info"
      gitlab: "info"
      bitbucket: "debug"
      azuredevops: "info"
      scanner: "info"
      webhook: "debug"

# Security Configuration
security:
  # Encryption
  encryption:
    enabled: true
    algorithm: "AES-256-GCM"
    key: "${ENCRYPTION_KEY}"
  
  # API security
  api:
    rate_limiting: true
    cors:
      enabled: true
      allowed_origins: ["https://dashboard.company.com"]
      allowed_methods: ["GET", "POST", "PUT", "DELETE"]
      allowed_headers: ["Authorization", "Content-Type"]
    
    authentication:
      required: true
      methods: ["bearer_token", "api_key"]
      token_expiry: "24h"
  
  # Data retention
  data_retention:
    scan_results: "90d"
    logs: "30d"
    metrics: "30d"
    cache: "7d"