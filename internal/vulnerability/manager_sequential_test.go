package vulnerability

import (
    "testing"
    "github.com/Alivanroy/Typosentinel/pkg/types"
    "github.com/stretchr/testify/require"
    "github.com/stretchr/testify/assert"
)

type stubDB struct{ out []*types.Vulnerability }
func (s *stubDB) CheckVulnerabilities(pkg *types.Package)([]*types.Vulnerability,error){ return s.out, nil }
func (s *stubDB) GetVulnerabilityByID(id string)(*types.Vulnerability,error){ for _,v:=range s.out{ if v.ID==id{ return v,nil } } ; return nil,nil }
func (s *stubDB) SearchVulnerabilities(q string)([]*types.Vulnerability,error){ return s.out, nil }

func TestSequentialCheck(t *testing.T){
    cfg := &ManagerConfig{ ParallelQueries: false, MergeResults: true, DeduplicateByID: true }
    mgr := NewManager(cfg)
    mgr.databases = map[string]types.VulnerabilityDatabase{
        "a": &stubDB{ out: []*types.Vulnerability{{ID:"A"}} },
        "b": &stubDB{ out: []*types.Vulnerability{{ID:"B"}} },
    }
    pkg := &types.Package{Name:"express", Version:"1.0.0", Registry:"npm"}
    res, err := mgr.CheckVulnerabilities(pkg)
    require.NoError(t, err)
    assert.Equal(t, 2, len(res))
}
