package vulnerability

import (
    "errors"
    "testing"
    "github.com/Alivanroy/Typosentinel/pkg/types"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/require"
)

type mockDB struct{
    name string
    vulns []*types.Vulnerability
    err error
}

func (m *mockDB) CheckVulnerabilities(pkg *types.Package) ([]*types.Vulnerability, error){
    if m.err != nil { return nil, m.err }
    return m.vulns, nil
}
func (m *mockDB) GetVulnerabilityByID(id string) (*types.Vulnerability, error){
    if m.err != nil { return nil, m.err }
    for _, v := range m.vulns { if v.ID == id { return v, nil } }
    return nil, errors.New("not found")
}
func (m *mockDB) SearchVulnerabilities(query string) ([]*types.Vulnerability, error){
    if m.err != nil { return nil, m.err }
    return m.vulns, nil
}

func TestManager_CheckVulnerabilities_MergeDeduplicate(t *testing.T){
    cfg := &ManagerConfig{ ParallelQueries: true, MergeResults: true, DeduplicateByID: true, Priority: []string{"osv","github"} }
    mgr := NewManager(cfg)
    mgr.databases = map[string]types.VulnerabilityDatabase{
        "osv": &mockDB{name:"osv", vulns: []*types.Vulnerability{{ID:"CVE-1", Title:"t1"}}},
        "github": &mockDB{name:"github", vulns: []*types.Vulnerability{{ID:"CVE-1", Title:"t1"},{ID:"CVE-2", Title:"t2"}}},
    }
    pkg := &types.Package{Name:"express", Version:"1.0.0", Registry:"npm"}
    vulns, err := mgr.CheckVulnerabilities(pkg)
    require.NoError(t, err)
    assert.Equal(t, 2, len(vulns))
}

func TestManager_GetVulnerabilityByID_Priority(t *testing.T){
    cfg := &ManagerConfig{ Priority: []string{"github","osv"} }
    mgr := NewManager(cfg)
    mgr.databases = map[string]types.VulnerabilityDatabase{
        "osv": &mockDB{name:"osv", vulns: []*types.Vulnerability{{ID:"X", Title:"t"}}},
        "github": &mockDB{name:"github", vulns: []*types.Vulnerability{{ID:"X", Title:"t"}}},
    }
    v, err := mgr.GetVulnerabilityByID("X")
    require.NoError(t, err)
    assert.NotNil(t, v)
    assert.True(t, v.Source == "github" || v.Source == "osv")
}

func TestManager_SearchVulnerabilities(t *testing.T){
    cfg := &ManagerConfig{ MergeResults: true, DeduplicateByID: true }
    mgr := NewManager(cfg)
    mgr.databases = map[string]types.VulnerabilityDatabase{
        "osv": &mockDB{name:"osv", vulns: []*types.Vulnerability{{ID:"A", Title:"a"}}},
        "github": &mockDB{name:"github", vulns: []*types.Vulnerability{{ID:"B", Title:"b"}}},
    }
    res, err := mgr.SearchVulnerabilities("express")
    require.NoError(t, err)
    assert.Equal(t, 2, len(res))
}
