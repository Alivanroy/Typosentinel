package vulnerability

import (
	"github.com/Alivanroy/Typosentinel/pkg/types"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestMapRegistryToEcosystem(t *testing.T) {
	db := NewOSVDatabase()
	cases := map[string]string{
		"npm": "npm", "pypi": "PyPI", "go": "Go", "maven": "Maven", "nuget": "NuGet", "packagist": "Packagist", "rubygems": "RubyGems", "crates.io": "crates.io", "unknown": "",
	}
	for k, v := range cases {
		assert.Equal(t, v, db.mapRegistryToEcosystem(k))
	}
}

func TestExtractSeverityFromCVSS(t *testing.T) {
	db := NewOSVDatabase()
	assert.Equal(t, types.SeverityHigh, db.extractSeverityFromCVSS("CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"))
	assert.Equal(t, types.SeverityMedium, db.extractSeverityFromCVSS("CVSS:3.1/AV:L/AC:H/PR:H/UI:R/S:U/C:L/I:L/A:L"))
	assert.Equal(t, types.SeverityLow, db.extractSeverityFromCVSS("CVSS:3.1/AV:P/AC:H/PR:H/UI:R/S:U/C:L/I:L/A:L"))
}

func TestConvertOSVToVulnerability(t *testing.T) {
	db := NewOSVDatabase()
	osv := OSVVulnerability{
		ID:         "X",
		Summary:    "sum",
		Details:    "det",
		Aliases:    []string{"A1"},
		Modified:   "2025-01-01T00:00:00Z",
		Published:  "2025-01-01T00:00:00Z",
		References: []OSVReference{{Type: "WEB", URL: "https://example.com"}},
		Severity:   []OSVSeverity{{Type: "CVSS_V3", Score: "CVSS:3.1/AV:N/AC:L"}},
		Affected:   []OSVAffected{{Package: OSVPackage{Name: "express", Ecosystem: "npm"}, Versions: []string{"1.0.0"}}},
	}
	v := db.convertOSVToVulnerability(osv)
	assert.Equal(t, "X", v.ID)
	assert.Equal(t, "osv", v.Source)
	assert.Equal(t, 1, len(v.References))
	assert.Equal(t, 1, len(v.AffectedPackages))
}
