/*
Enhanced YARA Rules for TypoSentinel
Designed to detect sophisticated malware patterns in packages
*/

rule Obfuscated_JavaScript {
    meta:
        description = "Detects obfuscated JavaScript code"
        severity = "high"
        confidence = 0.95
    strings:
        $hex_encoded = /\\x[0-9a-fA-F]{2}/
        $unicode_escape = /\\u[0-9a-fA-F]{4}/
        $eval_obfusc = /(eval|Function)\s*\(\s*["'][^"']*["']\s*\)/
        $base64_decode = /atob\s*\(/
        $string_fromcharcode = /String\.fromCharCode/
        $split_join = /\.split\s*\(.*\)\.join\s*\(/
        $char_code_array = /\[\s*\d+\s*(,\s*\d+\s*){5,}\]/
        $dynamic_eval = /(new\s+Function|eval)\s*\(.*\+.*\)/
        $encoded_strings = /["'][A-Za-z0-9+/]{20,}={0,2}["']/
    condition:
        2 of them
}

rule Suspicious_Network_Activity {
    meta:
        description = "Detects suspicious network operations"
        severity = "high"
        confidence = 0.9
    strings:
        $http_request = /(fetch|XMLHttpRequest|axios|request)\s*\(/
        $suspicious_url = /(https?:\/\/[^\s"']+\.(tk|ml|ga|cf|bit\.ly|tinyurl|000webhostapp|herokuapp))/
        $ip_address = /https?:\/\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/
        $websocket = /new\s+WebSocket\s*\(/
        $dns_lookup = /(dns\.lookup|dns\.resolve)/
        $crypto_mining = /(stratum\+tcp|mining|hashrate|cryptonight)/
        $c2_communication = /(beacon|heartbeat|checkin).*http/
        $data_exfiltration = /(upload|exfil|steal).*\.(zip|tar|rar)/
    condition:
        any of them
}

rule File_System_Manipulation {
    meta:
        description = "Detects suspicious file system operations"
        severity = "medium"
        confidence = 0.8
    strings:
        $file_write = /(fs\.writeFile|fs\.appendFile|fs\.createWriteStream)/
        $file_delete = /(fs\.unlink|fs\.rmdir|rimraf)/
        $file_chmod = /(fs\.chmod|chmod)/
        $temp_file = /(\/tmp\/|\/var\/tmp\/|%TEMP%|%TMP%)/
        $hidden_file = /\.[a-zA-Z0-9_-]+\.(js|py|sh|exe|bat)/
        $system_dir = /(\/etc\/|\/usr\/|\/bin\/|C:\\Windows\\|C:\\Program Files)/
    condition:
        any of them
}

rule Process_Execution {
    meta:
        description = "Detects process execution and command injection"
        severity = "high"
        confidence = 0.9
    strings:
        $child_process = /(child_process\.(exec|spawn|fork)|exec\s*\()/
        $shell_command = /(sh\s+-c|cmd\s+\/c|powershell\s+-)/
        $system_call = /(system\s*\(|os\.system|subprocess)/
        $eval_injection = /eval\s*\(.*process\./
        $dangerous_commands = /(rm\s+-rf|del\s+\/s|format\s+c:)/
    condition:
        any of them
}

rule Credential_Harvesting {
    meta:
        description = "Detects credential harvesting attempts"
        severity = "critical"
        confidence = 0.95
    strings:
        $env_vars = /(process\.env\.(AWS_|GITHUB_|NPM_|API_|SECRET_|TOKEN_|KEY_))/
        $ssh_keys = /(\.ssh\/|id_rsa|id_dsa|authorized_keys)/
        $browser_data = /(Login\s+Data|Cookies|Web\s+Data|History)/
        $password_files = /(\.password|\.passwd|credentials\.json)/
        $keychain = /(Keychain|keyring|gnome-keyring)/
    condition:
        any of them
}

rule Cryptocurrency_Mining {
    meta:
        description = "Detects cryptocurrency mining activities"
        severity = "high"
        confidence = 0.85
    strings:
        $mining_pools = /(pool\.minergate|stratum\+tcp|mining\.pool)/
        $mining_software = /(xmrig|cpuminer|cgminer|bfgminer)/
        $crypto_addresses = /([13][a-km-zA-HJ-NP-Z1-9]{25,34}|0x[a-fA-F0-9]{40})/
        $mining_config = /(algo|difficulty|intensity|threads)/
    condition:
        any of them
}

rule Persistence_Mechanisms {
    meta:
        description = "Detects persistence mechanisms"
        severity = "high"
        confidence = 0.8
    strings:
        $cron_job = /(crontab|@reboot|@daily|@hourly)/
        $startup_folder = /(Startup|autostart|\.bashrc|\.profile)/
        $registry_run = /(HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run)/
        $service_install = /(sc\s+create|systemctl\s+enable|launchctl\s+load)/
        $scheduled_task = /(schtasks|at\s+\d|Task\s+Scheduler)/
    condition:
        any of them
}

rule Anti_Analysis {
    meta:
        description = "Detects anti-analysis techniques"
        severity = "high"
        confidence = 0.9
    strings:
        $debugger_check = /(debugger|IsDebuggerPresent|CheckRemoteDebuggerPresent)/
        $vm_detection = /(VirtualBox|VMware|QEMU|Xen|Hyper-V)/
        $sandbox_evasion = /(sleep|setTimeout|delay)\s*\(\s*[0-9]{4,}/
        $environment_check = /(USER|USERNAME|COMPUTERNAME|HOSTNAME)/
        $time_check = /(Date\.now|performance\.now|new\s+Date)/
    condition:
        any of them
}

rule Typosquatting_Indicators {
    meta:
        description = "Detects potential typosquatting patterns"
        severity = "medium"
        confidence = 0.7
    strings:
        $similar_names = /(lodahs|reqeust|colros|nodmeon|expres|reactt|angualr)/
        $homoglyphs = /[а-я]/ // Cyrillic characters in package names
        $unicode_tricks = /[\u200B-\u200D\uFEFF]/ // Zero-width characters
        $number_substitution = /(l0dash|requ3st|c0lors|n0demon)/
    condition:
        any of them
}

rule Malicious_Postinstall {
    meta:
        description = "Detects malicious postinstall scripts"
        severity = "critical"
        confidence = 0.95
    strings:
        $postinstall_script = /"postinstall"\s*:\s*"[^"]*"/
        $suspicious_postinstall = /(curl|wget|nc|telnet).*\|\s*(sh|bash|python)/
        $base64_postinstall = /echo\s+[A-Za-z0-9+\/=]{20,}\s*\|\s*base64\s+-d/
        $download_execute = /(curl|wget).*-o.*&&.*(sh|bash|python|node)/
    condition:
        any of them
}

rule Data_Exfiltration {
    meta:
        description = "Detects data exfiltration attempts"
        severity = "critical"
        confidence = 0.9
    strings:
        $http_post = /(POST|PUT).*\/upload|\/submit|\/send/
        $file_upload = /(FormData|multipart\/form-data|file.*upload)/
        $data_steal = /(steal|exfil|leak).*data/
        $credential_harvest = /(password|token|key|secret).*collect/
    condition:
        any of them
}

rule Typosquatting_Detection {
    meta:
        description = "Detects potential typosquatting packages"
        severity = "high"
        confidence = 0.85
    strings:
        $popular_npm = /(react|angular|vue|express|lodash|axios|moment|webpack|babel)/
        $popular_pypi = /(numpy|pandas|requests|django|flask|tensorflow|pytorch|scikit-learn)/
        $suspicious_chars = /[0-9]{2,}|[il1]{2,}|[o0]{2,}/
        $homoglyph = /[а-я]|[αβγδε]|[ａ-ｚ]/  // Cyrillic, Greek, fullwidth
    condition:
        ($popular_npm or $popular_pypi) and ($suspicious_chars or $homoglyph)
}

rule Package_Metadata_Manipulation {
    meta:
        description = "Detects suspicious package metadata"
        severity = "medium"
        confidence = 0.8
    strings:
        $fake_author = /"author"\s*:\s*"(microsoft|google|facebook|amazon|apple)/
        $suspicious_repo = /"repository"\s*:\s*"[^"]*github\.com\/(microsoft|google|facebook)/
        $typo_description = /"description"\s*:\s*"[^"]*official[^"]*package/
        $misleading_keywords = /"keywords"\s*:\s*\[[^\]]*"(official|microsoft|google)"/
    condition:
        any of them
}

rule Cryptocurrency_Mining {
    meta:
        description = "Detects cryptocurrency mining code"
        severity = "high"
        confidence = 0.9
    strings:
        $mining_pool = /(stratum\+tcp|mining\.pool|pool\.mining)/
        $crypto_algo = /(cryptonight|scrypt|sha256|ethash|equihash)/
        $miner_binary = /(xmrig|ccminer|cgminer|bfgminer)/
        $wallet_address = /[13][a-km-zA-HJ-NP-Z1-9]{25,34}|0x[a-fA-F0-9]{40}/
        $mining_config = /(hashrate|difficulty|nonce|target)/
    condition:
        2 of them
        $env_vars = /(process\.env|os\.environ).*\.(HOME|USER|PATH|TOKEN|KEY|SECRET)/
        $credential_theft = /(password|token|key|secret|credential).*\.(send|post|upload)/
    condition:
        any of them
}

rule Typosquatting_Detection {
    meta:
        description = "Enhanced typosquatting detection for popular packages"
        severity = "high"
        confidence = 0.95
    strings:
        // Common typos of popular packages
        $lodash_typos = /(lodahs|lodsh|lodas|loodash|lodashh)/
        $express_typos = /(expres|expresss|exppress|exprss)/
        $react_typos = /(recat|reactt|raect|reat)/
        $jquery_typos = /(jquerry|jqeury|jquey|jqueri)/
        $axios_typos = /(axois|axioss|axos|axius)/
        $webpack_typos = /(webpac|webpackk|webpak|wepback)/
        $babel_typos = /(bable|babble|babel-)/
        $eslint_typos = /(eslit|eslint-|eslin)/
        // Suspicious package patterns
        $underscore_prefix = /^_[a-z]/
        $dash_suffix = /[a-z]-$/
        $number_suffix = /[a-z]\d+$/
        $extra_chars = /[a-z]{2,}[0-9]{1,2}$/
    condition:
        any of them
}

rule Package_Confusion_Attack {
    meta:
        description = "Detects dependency confusion attacks"
        severity = "critical"
        confidence = 0.9
    strings:
        $internal_scope = /@(company|internal|private|corp)/
        $suspicious_version = /"version"\s*:\s*"(999|1000|9999)\./
        $high_version = /"version"\s*:\s*"[1-9]\d{2,}\./
        $prerelease_abuse = /"version"\s*:\s*".*-(alpha|beta|rc|dev)\d{3,}/
    condition:
        any of them
}
        $data_compression = /(zip|tar|gzip|compress).*\|.*(curl|wget)/
        $steganography = /(steghide|outguess|jsteg)/
        $dns_exfiltration = /nslookup.*\$\(/
    condition:
        any of them
}