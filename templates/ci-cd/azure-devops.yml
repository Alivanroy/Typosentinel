# Azure DevOps Pipeline Template for Typosentinel
# This template provides automated security scanning for your repositories

trigger:
  branches:
    include:
      - main
      - master
      - develop
      - release/*
      - hotfix/*
  paths:
    include:
      - package.json
      - package-lock.json
      - yarn.lock
      - pnpm-lock.yaml
      - requirements.txt
      - Pipfile
      - Pipfile.lock
      - composer.json
      - composer.lock
      - Gemfile
      - Gemfile.lock
      - go.mod
      - go.sum
      - Cargo.toml
      - Cargo.lock
      - pom.xml
      - build.gradle
      - build.gradle.kts

pr:
  branches:
    include:
      - main
      - master
      - develop
  paths:
    include:
      - package.json
      - package-lock.json
      - yarn.lock
      - pnpm-lock.yaml
      - requirements.txt
      - Pipfile
      - Pipfile.lock
      - composer.json
      - composer.lock
      - Gemfile
      - Gemfile.lock
      - go.mod
      - go.sum
      - Cargo.toml
      - Cargo.lock
      - pom.xml
      - build.gradle
      - build.gradle.kts

schedules:
  - cron: "0 2 * * *"
    displayName: Daily security scan
    branches:
      include:
        - main
        - master
    always: true

variables:
  # Typosentinel Configuration
  TYPOSENTINEL_API_URL: 'https://api.typosentinel.com'
  TYPOSENTINEL_CLI_VERSION: 'latest'
  SCAN_TIMEOUT: '1800'
  NODE_VERSION: '20.x'
  
  # Pipeline Configuration
  RESULTS_DIR: 'typosentinel-results'
  ARTIFACT_NAME: 'typosentinel-scan-results'
  
  # Default scan parameters
  SCAN_TYPE: ${{ coalesce(parameters.scanType, 'auto') }}
  SEVERITY_THRESHOLD: ${{ coalesce(parameters.severityThreshold, 'medium') }}
  BLOCK_ON_CRITICAL: ${{ coalesce(parameters.blockOnCritical, true) }}
  CREATE_WORK_ITEMS: ${{ coalesce(parameters.createWorkItems, false) }}
  NOTIFY_TEAMS: ${{ coalesce(parameters.notifyTeams, true) }}

parameters:
  - name: scanType
    displayName: 'Scan Type'
    type: string
    default: 'auto'
    values:
      - 'auto'
      - 'full'
      - 'incremental'
      - 'targeted'
  
  - name: severityThreshold
    displayName: 'Severity Threshold'
    type: string
    default: 'medium'
    values:
      - 'low'
      - 'medium'
      - 'high'
      - 'critical'
  
  - name: blockOnCritical
    displayName: 'Block Pipeline on Critical Threats'
    type: boolean
    default: true
  
  - name: createWorkItems
    displayName: 'Create Work Items for Critical Threats'
    type: boolean
    default: false
  
  - name: notifyTeams
    displayName: 'Send Teams Notifications'
    type: boolean
    default: true

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: SecurityScan
    displayName: 'Security Scanning'
    jobs:
      - job: PrepareScan
        displayName: 'Prepare Scan Environment'
        steps:
          - checkout: self
            fetchDepth: 0
            displayName: 'Checkout source code'
          
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: '$(NODE_VERSION)'
              checkLatest: true
          
          - task: Cache@2
            displayName: 'Cache Node modules'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: '$(npm_config_cache)'
          
          - task: Cache@2
            displayName: 'Cache Typosentinel results'
            inputs:
              key: 'typosentinel | "$(Agent.OS)" | "$(Build.SourceVersion)"'
              restoreKeys: |
                typosentinel | "$(Agent.OS)"
              path: '$(RESULTS_DIR)'
          
          - script: |
              echo "üîß Installing dependencies..."
              npm ci --audit=false
              npm install -g @typosentinel/cli@$(TYPOSENTINEL_CLI_VERSION)
              mkdir -p $(RESULTS_DIR)
            displayName: 'Install dependencies'
          
          - script: |
              echo "üìù Creating Typosentinel configuration..."
              
              # Determine scan type based on trigger
              DETERMINED_SCAN_TYPE="$(SCAN_TYPE)"
              if [ "$DETERMINED_SCAN_TYPE" = "auto" ]; then
                if [ "$(Build.Reason)" = "Schedule" ]; then
                  DETERMINED_SCAN_TYPE="full"
                elif [ "$(Build.Reason)" = "PullRequest" ]; then
                  DETERMINED_SCAN_TYPE="incremental"
                elif [ "$(Build.SourceBranch)" = "refs/heads/main" ] || [ "$(Build.SourceBranch)" = "refs/heads/master" ]; then
                  DETERMINED_SCAN_TYPE="full"
                else
                  DETERMINED_SCAN_TYPE="incremental"
                fi
              fi
              
              echo "##vso[task.setvariable variable=DETERMINED_SCAN_TYPE]$DETERMINED_SCAN_TYPE"
              echo "Determined scan type: $DETERMINED_SCAN_TYPE"
              
              cat > .typosentinel.yml << EOF
              api:
                url: $(TYPOSENTINEL_API_URL)
                key: \$(TYPOSENTINEL_API_KEY)
                timeout: $(SCAN_TIMEOUT)
              
              scan:
                type: $DETERMINED_SCAN_TYPE
                severity_threshold: $(SEVERITY_THRESHOLD)
                include_dev_dependencies: true
                max_depth: 5
                parallel_scans: 4
                exclude_patterns:
                  - "**/node_modules/**"
                  - "**/vendor/**"
                  - "**/.git/**"
              
              reporting:
                formats:
                  - json
                  - junit
                  - html
                  - sarif
                output_dir: ./$(RESULTS_DIR)
                upload_artifacts: true
              
              policies:
                block_on_critical: $(BLOCK_ON_CRITICAL)
                block_on_high: false
                require_approval_on_medium: true
                auto_quarantine: true
              
              integrations:
                azure_devops:
                  create_work_items: $(CREATE_WORK_ITEMS)
                  area_path: "Security"
                  iteration_path: "Security\\Current"
                teams:
                  webhook_url: \$(TEAMS_WEBHOOK_URL)
                  notify_on_threats: $(NOTIFY_TEAMS)
              EOF
            displayName: 'Create scan configuration'
            env:
              TYPOSENTINEL_API_KEY: $(TYPOSENTINEL_API_KEY)
              TEAMS_WEBHOOK_URL: $(TEAMS_WEBHOOK_URL)
      
      - job: ExecuteScan
        displayName: 'Execute Security Scan'
        dependsOn: PrepareScan
        variables:
          DETERMINED_SCAN_TYPE: $[ dependencies.PrepareScan.outputs['setvarStep.DETERMINED_SCAN_TYPE'] ]
        steps:
          - checkout: self
            fetchDepth: 0
            displayName: 'Checkout source code'
          
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: '$(NODE_VERSION)'
          
          - task: Cache@2
            displayName: 'Restore Node modules cache'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              path: '$(npm_config_cache)'
          
          - task: Cache@2
            displayName: 'Restore Typosentinel cache'
            inputs:
              key: 'typosentinel | "$(Agent.OS)" | "$(Build.SourceVersion)"'
              path: '$(RESULTS_DIR)'
          
          - script: |
              echo "üîß Installing dependencies..."
              npm ci --audit=false
              npm install -g @typosentinel/cli@$(TYPOSENTINEL_CLI_VERSION)
              mkdir -p $(RESULTS_DIR)
            displayName: 'Install dependencies'
          
          - script: |
              echo "üîç Starting Typosentinel security scan..."
              echo "Scan type: $(DETERMINED_SCAN_TYPE)"
              echo "Severity threshold: $(SEVERITY_THRESHOLD)"
              
              # Execute scan based on type
              if [ "$(DETERMINED_SCAN_TYPE)" = "incremental" ] && [ "$(Build.Reason)" = "PullRequest" ]; then
                echo "Running incremental scan for PR..."
                typosentinel scan \
                  --config .typosentinel.yml \
                  --type incremental \
                  --base-ref origin/$(System.PullRequest.TargetBranch) \
                  --head-ref $(Build.SourceVersion) \
                  --output-format json,junit,html,sarif \
                  --output-dir $(RESULTS_DIR) \
                  --verbose
              else
                echo "Running full scan..."
                typosentinel scan \
                  --config .typosentinel.yml \
                  --type full \
                  --output-format json,junit,html,sarif \
                  --output-dir $(RESULTS_DIR) \
                  --verbose
              fi
              
              SCAN_EXIT_CODE=$?
              echo "##vso[task.setvariable variable=SCAN_EXIT_CODE]$SCAN_EXIT_CODE"
              
              # Parse results
              if [ -f "$(RESULTS_DIR)/scan-results.json" ]; then
                THREAT_COUNT=$(jq -r '.summary.total_threats // 0' $(RESULTS_DIR)/scan-results.json)
                CRITICAL_COUNT=$(jq -r '.summary.critical_threats // 0' $(RESULTS_DIR)/scan-results.json)
                HIGH_COUNT=$(jq -r '.summary.high_threats // 0' $(RESULTS_DIR)/scan-results.json)
                MEDIUM_COUNT=$(jq -r '.summary.medium_threats // 0' $(RESULTS_DIR)/scan-results.json)
                LOW_COUNT=$(jq -r '.summary.low_threats // 0' $(RESULTS_DIR)/scan-results.json)
                
                echo "##vso[task.setvariable variable=THREAT_COUNT]$THREAT_COUNT"
                echo "##vso[task.setvariable variable=CRITICAL_COUNT]$CRITICAL_COUNT"
                echo "##vso[task.setvariable variable=HIGH_COUNT]$HIGH_COUNT"
                echo "##vso[task.setvariable variable=MEDIUM_COUNT]$MEDIUM_COUNT"
                echo "##vso[task.setvariable variable=LOW_COUNT]$LOW_COUNT"
                
                if [ "$CRITICAL_COUNT" -gt 0 ]; then
                  echo "##vso[task.setvariable variable=SCAN_STATUS]failed"
                  echo "‚ùå Critical security threats detected!"
                  echo "##vso[task.logissue type=error]Critical threats detected: $CRITICAL_COUNT"
                elif [ "$HIGH_COUNT" -gt 0 ]; then
                  echo "##vso[task.setvariable variable=SCAN_STATUS]warning"
                  echo "‚ö†Ô∏è High severity threats detected"
                  echo "##vso[task.logissue type=warning]High severity threats detected: $HIGH_COUNT"
                else
                  echo "##vso[task.setvariable variable=SCAN_STATUS]passed"
                  echo "‚úÖ No critical threats detected"
                fi
                
                echo "üìä Scan Summary:"
                echo "  Total threats: $THREAT_COUNT"
                echo "  Critical: $CRITICAL_COUNT"
                echo "  High: $HIGH_COUNT"
                echo "  Medium: $MEDIUM_COUNT"
                echo "  Low: $LOW_COUNT"
              else
                echo "##vso[task.setvariable variable=SCAN_STATUS]error"
                echo "‚ùå Scan failed to complete"
                echo "##vso[task.logissue type=error]Scan failed to complete"
                exit 1
              fi
            displayName: 'Execute security scan'
            env:
              TYPOSENTINEL_API_KEY: $(TYPOSENTINEL_API_KEY)
          
          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '$(RESULTS_DIR)/junit-report.xml'
              testRunTitle: 'Typosentinel Security Scan'
              failTaskOnFailedTests: false
          
          - script: |
              echo "üìä Generating comprehensive reports..."
              
              # Generate Azure DevOps summary
              cat > $(RESULTS_DIR)/azure-summary.md << EOF
              # üõ°Ô∏è Typosentinel Security Scan Results
              
              ## üìä Summary
              
              | Metric | Value |
              |--------|-------|
              | **Status** | $(SCAN_STATUS) |
              | **Total Threats** | $(THREAT_COUNT) |
              | **Critical** | $(CRITICAL_COUNT) |
              | **High** | $(HIGH_COUNT) |
              | **Medium** | $(MEDIUM_COUNT) |
              | **Low** | $(LOW_COUNT) |
              
              ## üîç Scan Details
              
              - **Scan Type**: $(DETERMINED_SCAN_TYPE)
              - **Severity Threshold**: $(SEVERITY_THRESHOLD)
              - **Build**: [$(Build.BuildNumber)]($(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId))
              - **Branch**: $(Build.SourceBranchName)
              - **Commit**: $(Build.SourceVersion)
              - **Triggered By**: $(Build.RequestedFor)
              
              ## üö® Status
              
              EOF
              
              if [ "$(CRITICAL_COUNT)" -gt 0 ]; then
                echo "‚ùå **CRITICAL THREATS DETECTED!**" >> $(RESULTS_DIR)/azure-summary.md
                echo "" >> $(RESULTS_DIR)/azure-summary.md
                echo "This build contains $(CRITICAL_COUNT) critical security threats that must be addressed immediately." >> $(RESULTS_DIR)/azure-summary.md
                echo "**Do not deploy to production until all critical threats are resolved.**" >> $(RESULTS_DIR)/azure-summary.md
              elif [ "$(HIGH_COUNT)" -gt 0 ]; then
                echo "‚ö†Ô∏è **High severity threats detected**" >> $(RESULTS_DIR)/azure-summary.md
                echo "" >> $(RESULTS_DIR)/azure-summary.md
                echo "This build contains $(HIGH_COUNT) high severity threats. Review recommended before deployment." >> $(RESULTS_DIR)/azure-summary.md
              else
                echo "‚úÖ **No critical threats detected**" >> $(RESULTS_DIR)/azure-summary.md
                echo "" >> $(RESULTS_DIR)/azure-summary.md
                echo "This build passed security scanning with no critical or high severity threats." >> $(RESULTS_DIR)/azure-summary.md
              fi
              
              echo "" >> $(RESULTS_DIR)/azure-summary.md
              echo "---" >> $(RESULTS_DIR)/azure-summary.md
              echo "*Scan performed by [Typosentinel](https://typosentinel.com) on $(date)*" >> $(RESULTS_DIR)/azure-summary.md
              
              # Generate HTML report
              cat > $(RESULTS_DIR)/security-report.html << EOF
              <!DOCTYPE html>
              <html>
              <head>
                  <title>Typosentinel Security Report</title>
                  <style>
                      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f5f5f5; }
                      .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                      .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 8px; margin-bottom: 30px; }
                      .header h1 { margin: 0; font-size: 2.5em; }
                      .status-passed { color: #28a745; font-weight: bold; }
                      .status-warning { color: #ffc107; font-weight: bold; }
                      .status-failed { color: #dc3545; font-weight: bold; }
                      .threat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
                      .threat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #dee2e6; }
                      .threat-card.critical { border-left-color: #dc3545; background: #f8d7da; }
                      .threat-card.high { border-left-color: #fd7e14; background: #fff3cd; }
                      .threat-card.medium { border-left-color: #20c997; background: #d1ecf1; }
                      .threat-card.low { border-left-color: #6f42c1; background: #d4edda; }
                      .threat-number { font-size: 2.5em; font-weight: bold; margin-bottom: 10px; }
                      .threat-label { font-size: 1.1em; text-transform: uppercase; letter-spacing: 1px; }
                      .details-table { width: 100%; border-collapse: collapse; margin: 30px 0; }
                      .details-table th, .details-table td { padding: 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
                      .details-table th { background-color: #f8f9fa; font-weight: 600; }
                      .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #dee2e6; color: #6c757d; }
                  </style>
              </head>
              <body>
                  <div class="container">
                      <div class="header">
                          <h1>üõ°Ô∏è Typosentinel Security Report</h1>
                          <p style="margin: 10px 0 0 0; font-size: 1.2em;">Build $(Build.BuildNumber) ‚Ä¢ $(date)</p>
                      </div>
                      
                      <div class="threat-grid">
                          <div class="threat-card critical">
                              <div class="threat-number">$(CRITICAL_COUNT)</div>
                              <div class="threat-label">Critical</div>
                          </div>
                          <div class="threat-card high">
                              <div class="threat-number">$(HIGH_COUNT)</div>
                              <div class="threat-label">High</div>
                          </div>
                          <div class="threat-card medium">
                              <div class="threat-number">$(MEDIUM_COUNT)</div>
                              <div class="threat-label">Medium</div>
                          </div>
                          <div class="threat-card low">
                              <div class="threat-number">$(LOW_COUNT)</div>
                              <div class="threat-label">Low</div>
                          </div>
                      </div>
                      
                      <table class="details-table">
                          <tr><th>Build Details</th><th>Value</th></tr>
                          <tr><td>Build Number</td><td>$(Build.BuildNumber)</td></tr>
                          <tr><td>Branch</td><td>$(Build.SourceBranchName)</td></tr>
                          <tr><td>Commit</td><td>$(Build.SourceVersion)</td></tr>
                          <tr><td>Triggered By</td><td>$(Build.RequestedFor)</td></tr>
                          <tr><td>Scan Type</td><td>$(DETERMINED_SCAN_TYPE)</td></tr>
                          <tr><td>Status</td><td><span class="status-$(SCAN_STATUS)">$(SCAN_STATUS)</span></td></tr>
                          <tr><td>Total Threats</td><td><strong>$(THREAT_COUNT)</strong></td></tr>
                      </table>
                      
                      <div class="footer">
                          <p><em>Generated by <a href="https://typosentinel.com">Typosentinel</a> ‚Ä¢ Azure DevOps Integration</em></p>
                      </div>
                  </div>
              </body>
              </html>
              EOF
            displayName: 'Generate reports'
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish scan artifacts'
            condition: always()
            inputs:
              pathToPublish: '$(RESULTS_DIR)'
              artifactName: '$(ARTIFACT_NAME)'
              publishLocation: 'Container'
          
          - task: PublishHtmlReport@1
            displayName: 'Publish HTML report'
            condition: always()
            inputs:
              reportDir: '$(RESULTS_DIR)'
              tabName: 'Security Report'
  
  - stage: SecurityPolicy
    displayName: 'Security Policy Enforcement'
    dependsOn: SecurityScan
    condition: and(succeeded(), gt(dependencies.SecurityScan.outputs['ExecuteScan.CRITICAL_COUNT'], 0))
    variables:
      CRITICAL_COUNT: $[ stageDependencies.SecurityScan.ExecuteScan.outputs['CRITICAL_COUNT'] ]
      THREAT_COUNT: $[ stageDependencies.SecurityScan.ExecuteScan.outputs['THREAT_COUNT'] ]
      SCAN_STATUS: $[ stageDependencies.SecurityScan.ExecuteScan.outputs['SCAN_STATUS'] ]
    jobs:
      - job: CreateWorkItems
        displayName: 'Create Work Items'
        condition: eq(variables['CREATE_WORK_ITEMS'], true)
        steps:
          - script: |
              echo "üö® Creating work item for critical security threats..."
              
              # This would typically use Azure DevOps REST API or CLI
              # For now, we'll create a template that can be used
              
              cat > work-item-template.json << EOF
              {
                "op": "add",
                "path": "/fields/System.Title",
                "value": "üö® Critical Security Threats - Build $(Build.BuildNumber)"
              },
              {
                "op": "add",
                "path": "/fields/System.Description",
                "value": "Critical security threats detected by Typosentinel:\n\nBuild Details:\n- Build: $(Build.BuildNumber)\n- Branch: $(Build.SourceBranchName)\n- Commit: $(Build.SourceVersion)\n\nThreat Summary:\n- Total threats: $(THREAT_COUNT)\n- Critical threats: $(CRITICAL_COUNT)\n\nAction Required:\n- Review scan results immediately\n- Address all critical threats\n- Do not deploy to production until resolved\n\nView full report: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
              },
              {
                "op": "add",
                "path": "/fields/System.AreaPath",
                "value": "$(System.TeamProject)\\Security"
              },
              {
                "op": "add",
                "path": "/fields/Microsoft.VSTS.Common.Priority",
                "value": 1
              },
              {
                "op": "add",
                "path": "/fields/Microsoft.VSTS.Common.Severity",
                "value": "1 - Critical"
              },
              {
                "op": "add",
                "path": "/fields/System.Tags",
                "value": "security; typosentinel; critical; build-$(Build.BuildNumber)"
              }
              EOF
              
              echo "Work item template created. In a real implementation, this would create an actual work item."
            displayName: 'Create security work item'
      
      - job: BlockDeployment
        displayName: 'Block Deployment'
        condition: eq(variables['BLOCK_ON_CRITICAL'], true)
        steps:
          - script: |
              echo "‚ùå BLOCKING PIPELINE: Critical security threats detected!"
              echo "Critical threats: $(CRITICAL_COUNT)"
              echo "Total threats: $(THREAT_COUNT)"
              echo ""
              echo "This pipeline is blocked due to critical security threats."
              echo "Please address all critical threats before proceeding with deployment."
              echo ""
              echo "View the security report for detailed information."
              exit 1
            displayName: 'Block pipeline on critical threats'
  
  - stage: Notifications
    displayName: 'Notifications'
    dependsOn: SecurityScan
    condition: always()
    variables:
      CRITICAL_COUNT: $[ stageDependencies.SecurityScan.ExecuteScan.outputs['CRITICAL_COUNT'] ]
      HIGH_COUNT: $[ stageDependencies.SecurityScan.ExecuteScan.outputs['HIGH_COUNT'] ]
      THREAT_COUNT: $[ stageDependencies.SecurityScan.ExecuteScan.outputs['THREAT_COUNT'] ]
      SCAN_STATUS: $[ stageDependencies.SecurityScan.ExecuteScan.outputs['SCAN_STATUS'] ]
    jobs:
      - job: TeamsNotification
        displayName: 'Teams Notification'
        condition: and(eq(variables['NOTIFY_TEAMS'], true), ne(variables['TEAMS_WEBHOOK_URL'], ''))
        steps:
          - script: |
              echo "üì¢ Sending Teams notification..."
              
              # Determine notification color and message
              if [ "$(SCAN_STATUS)" = "failed" ]; then
                COLOR="attention"
                STATUS_EMOJI="‚ùå"
                STATUS_TEXT="FAILED"
              elif [ "$(SCAN_STATUS)" = "warning" ]; then
                COLOR="warning"
                STATUS_EMOJI="‚ö†Ô∏è"
                STATUS_TEXT="WARNING"
              else
                COLOR="good"
                STATUS_EMOJI="‚úÖ"
                STATUS_TEXT="PASSED"
              fi
              
              # Create Teams message payload
              cat > teams-message.json << EOF
              {
                "@type": "MessageCard",
                "@context": "https://schema.org/extensions",
                "summary": "Typosentinel Security Scan Results",
                "themeColor": "$COLOR",
                "sections": [
                  {
                    "activityTitle": "üõ°Ô∏è Typosentinel Security Scan Results",
                    "activitySubtitle": "Build $(Build.BuildNumber) ‚Ä¢ $(Build.SourceBranchName)",
                    "facts": [
                      {
                        "name": "Status",
                        "value": "$STATUS_EMOJI $STATUS_TEXT"
                      },
                      {
                        "name": "Total Threats",
                        "value": "$(THREAT_COUNT)"
                      },
                      {
                        "name": "Critical",
                        "value": "$(CRITICAL_COUNT)"
                      },
                      {
                        "name": "High",
                        "value": "$(HIGH_COUNT)"
                      },
                      {
                        "name": "Branch",
                        "value": "$(Build.SourceBranchName)"
                      },
                      {
                        "name": "Triggered By",
                        "value": "$(Build.RequestedFor)"
                      }
                    ],
                    "markdown": true
                  }
                ],
                "potentialAction": [
                  {
                    "@type": "OpenUri",
                    "name": "View Build",
                    "targets": [
                      {
                        "os": "default",
                        "uri": "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
                      }
                    ]
                  },
                  {
                    "@type": "OpenUri",
                    "name": "View Security Report",
                    "targets": [
                      {
                        "os": "default",
                        "uri": "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts"
                      }
                    ]
                  }
                ]
              }
              EOF
              
              # Send to Teams webhook
              curl -H "Content-Type: application/json" \
                   -d @teams-message.json \
                   "$(TEAMS_WEBHOOK_URL)"
              
              echo "Teams notification sent successfully"
            displayName: 'Send Teams notification'
            env:
              TEAMS_WEBHOOK_URL: $(TEAMS_WEBHOOK_URL)
      
      - job: EmailNotification
        displayName: 'Email Notification'
        condition: or(eq(variables['SCAN_STATUS'], 'failed'), eq(variables['SCAN_STATUS'], 'error'))
        steps:
          - script: |
              echo "üìß Preparing email notification for critical threats..."
              
              # In a real implementation, this would send an email
              # For now, we'll create the email template
              
              cat > email-template.html << EOF
              <!DOCTYPE html>
              <html>
              <head>
                  <title>Typosentinel Security Alert</title>
                  <style>
                      body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                      .header { background: #dc3545; color: white; padding: 20px; text-align: center; }
                      .content { padding: 20px; }
                      .alert { background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin: 20px 0; }
                      .summary { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }
                      .button { display: inline-block; background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 10px 5px; }
                  </style>
              </head>
              <body>
                  <div class="header">
                      <h1>üö® Typosentinel Security Alert</h1>
                      <p>Critical security threats detected in build $(Build.BuildNumber)</p>
                  </div>
                  
                  <div class="content">
                      <div class="alert">
                          <strong>‚ö†Ô∏è Immediate Action Required</strong><br>
                          Critical security threats have been detected in your build and must be addressed before deployment.
                      </div>
                      
                      <h2>Build Details</h2>
                      <ul>
                          <li><strong>Build:</strong> $(Build.BuildNumber)</li>
                          <li><strong>Branch:</strong> $(Build.SourceBranchName)</li>
                          <li><strong>Commit:</strong> $(Build.SourceVersion)</li>
                          <li><strong>Triggered By:</strong> $(Build.RequestedFor)</li>
                      </ul>
                      
                      <div class="summary">
                          <h3>Threat Summary</h3>
                          <ul>
                              <li><strong>Total Threats:</strong> $(THREAT_COUNT)</li>
                              <li><strong>Critical:</strong> $(CRITICAL_COUNT)</li>
                              <li><strong>High:</strong> $(HIGH_COUNT)</li>
                          </ul>
                      </div>
                      
                      <h3>Next Steps</h3>
                      <ol>
                          <li>Review the detailed security report</li>
                          <li>Address all critical threats immediately</li>
                          <li>Do not deploy to production until resolved</li>
                          <li>Re-run the security scan after fixes</li>
                      </ol>
                      
                      <p>
                          <a href="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)" class="button">View Build</a>
                          <a href="$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts" class="button">View Security Report</a>
                      </p>
                  </div>
              </body>
              </html>
              EOF
              
              echo "Email template created. In a real implementation, this would send an email to the security team."
            displayName: 'Prepare email notification'
      
      - job: PRComment
        displayName: 'PR Comment'
        condition: eq(variables['Build.Reason'], 'PullRequest')
        steps:
          - script: |
              echo "üí¨ Adding comment to pull request..."
              
              # Determine comment content based on scan results
              if [ "$(SCAN_STATUS)" = "failed" ]; then
                COMMENT_HEADER="## ‚ùå Security Scan Failed"
                COMMENT_MESSAGE="Critical security threats detected! This PR should not be merged until all threats are resolved."
              elif [ "$(SCAN_STATUS)" = "warning" ]; then
                COMMENT_HEADER="## ‚ö†Ô∏è Security Scan Warning"
                COMMENT_MESSAGE="High severity threats detected. Please review before merging."
              else
                COMMENT_HEADER="## ‚úÖ Security Scan Passed"
                COMMENT_MESSAGE="No critical threats detected. This PR is safe to merge from a security perspective."
              fi
              
              # Create PR comment
              cat > pr-comment.md << EOF
              $COMMENT_HEADER
              
              üõ°Ô∏è **Typosentinel Security Scan Results**
              
              $COMMENT_MESSAGE
              
              ### üìä Threat Summary
              
              | Severity | Count |
              |----------|-------|
              | Critical | $(CRITICAL_COUNT) |
              | High | $(HIGH_COUNT) |
              | Medium | $(MEDIUM_COUNT) |
              | Low | $(LOW_COUNT) |
              | **Total** | **$(THREAT_COUNT)** |
              
              ### üîç Scan Details
              
              - **Build**: [$(Build.BuildNumber)]($(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId))
              - **Scan Type**: Incremental
              - **Severity Threshold**: $(SEVERITY_THRESHOLD)
              
              EOF
              
              if [ "$(CRITICAL_COUNT)" -gt 0 ]; then
                echo "### üö® Critical Threats" >> pr-comment.md
                echo "" >> pr-comment.md
                echo "This PR introduces $(CRITICAL_COUNT) critical security threats that must be addressed before merging." >> pr-comment.md
                echo "" >> pr-comment.md
                echo "**Action Required:**" >> pr-comment.md
                echo "1. Review the [detailed security report]($(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)&view=artifacts)" >> pr-comment.md
                echo "2. Address all critical threats" >> pr-comment.md
                echo "3. Re-run the security scan" >> pr-comment.md
                echo "4. Do not merge until all critical threats are resolved" >> pr-comment.md
              fi
              
              echo "" >> pr-comment.md
              echo "---" >> pr-comment.md
              echo "*Automated security scan by [Typosentinel](https://typosentinel.com)*" >> pr-comment.md
              
              echo "PR comment prepared. In a real implementation, this would be posted to the PR."
              cat pr-comment.md
            displayName: 'Prepare PR comment'