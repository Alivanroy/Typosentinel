# GitLab CI/CD Pipeline for ACME Enterprise
# Comprehensive Typosentinel Security Scanning Integration
# Supports multi-registry vulnerability detection and enterprise compliance

stages:
  - validate
  - security-scan
  - analysis
  - report
  - deploy

variables:
  TYPOSENTINEL_VERSION: "latest"
  SCAN_TIMEOUT: "1800"
  ARTIFACT_RETENTION: "30 days"
  REGISTRY_CONFIG_PATH: "./tests/acme-enterprise/registry-config"
  SECURITY_THRESHOLD: "medium"
  ENTERPRISE_MODE: "true"
  PARALLEL_SCANS: "3"
  
  # Docker images for different environments
  SCANNER_IMAGE: "ubuntu:22.04"
  NODE_IMAGE: "node:18-alpine"
  PYTHON_IMAGE: "python:3.11-slim"
  JAVA_IMAGE: "openjdk:17-jdk-slim"
  DOTNET_IMAGE: "mcr.microsoft.com/dotnet/sdk:6.0"
  RUBY_IMAGE: "ruby:3.2-alpine"
  GO_IMAGE: "golang:1.21-alpine"

# Global before_script for common setup
before_script:
  - echo "üöÄ Starting ACME Enterprise Security Pipeline"
  - echo "Pipeline ID: $CI_PIPELINE_ID"
  - echo "Commit SHA: $CI_COMMIT_SHA"
  - echo "Branch: $CI_COMMIT_REF_NAME"
  - mkdir -p reports logs artifacts

# Cache configuration for dependencies
cache:
  key: "${CI_COMMIT_REF_SLUG}-${CI_JOB_NAME}"
  paths:
    - .npm/
    - .pip-cache/
    - .m2/
    - .nuget/
    - .bundle/
    - .go-cache/
  policy: pull-push

# ============================================================================
# VALIDATION STAGE
# ============================================================================

validate-environment:
  stage: validate
  image: $SCANNER_IMAGE
  script:
    - echo "üîç Validating pipeline environment"
    - apt-get update && apt-get install -y curl jq git
    
    # Detect project structure and registries
    - |
      echo "Detecting project registries..."
      REGISTRIES="[]"
      
      if [ -f "package.json" ] || [ -f "package-lock.json" ] || [ -f "yarn.lock" ]; then
        REGISTRIES=$(echo $REGISTRIES | jq '. + ["npm"]')
        echo "‚úÖ NPM detected"
      fi
      
      if [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ] || [ -f "Pipfile" ]; then
        REGISTRIES=$(echo $REGISTRIES | jq '. + ["pypi"]')
        echo "‚úÖ PyPI detected"
      fi
      
      if [ -f "pom.xml" ] || [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
        REGISTRIES=$(echo $REGISTRIES | jq '. + ["maven"]')
        echo "‚úÖ Maven detected"
      fi
      
      if find . -name "*.csproj" -o -name "*.sln" -o -name "packages.config" | grep -q .; then
        REGISTRIES=$(echo $REGISTRIES | jq '. + ["nuget"]')
        echo "‚úÖ NuGet detected"
      fi
      
      if [ -f "Gemfile" ] || [ -f "Gemfile.lock" ] || find . -name "*.gemspec" | grep -q .; then
        REGISTRIES=$(echo $REGISTRIES | jq '. + ["rubygems"]')
        echo "‚úÖ RubyGems detected"
      fi
      
      if [ -f "go.mod" ] || [ -f "go.sum" ]; then
        REGISTRIES=$(echo $REGISTRIES | jq '. + ["go"]')
        echo "‚úÖ Go modules detected"
      fi
      
      echo "DETECTED_REGISTRIES=$REGISTRIES" > registry-config.env
      echo "Detected registries: $REGISTRIES"
    
    # Generate scan configuration
    - |
      cat > scan-config.json << EOF
      {
        "pipeline_id": "$CI_PIPELINE_ID",
        "commit_sha": "$CI_COMMIT_SHA",
        "branch": "$CI_COMMIT_REF_NAME",
        "scan_type": "comprehensive",
        "severity_threshold": "$SECURITY_THRESHOLD",
        "enterprise_mode": $ENTERPRISE_MODE,
        "parallel_scans": $PARALLEL_SCANS,
        "timeout": $SCAN_TIMEOUT,
        "features": {
          "typosquatting_detection": true,
          "dependency_confusion": true,
          "supply_chain_analysis": true,
          "zero_day_detection": true,
          "compliance_reporting": true,
          "threat_intelligence": true
        },
        "policies": {
          "fail_on_critical": true,
          "fail_on_high": false,
          "allow_dev_dependencies": true,
          "enforce_license_compliance": true
        },
        "reporting": {
          "formats": ["json", "sarif", "html", "pdf"],
          "include_remediation": true,
          "include_risk_assessment": true
        }
      }
      EOF
      
      echo "üìã Scan configuration generated"
      cat scan-config.json
  
  artifacts:
    reports:
      dotenv: registry-config.env
    paths:
      - scan-config.json
      - registry-config.env
    expire_in: $ARTIFACT_RETENTION
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"

validate-secrets:
  stage: validate
  image: $SCANNER_IMAGE
  script:
    - echo "üîê Validating required secrets and configuration"
    - apt-get update && apt-get install -y curl
    
    # Check required environment variables
    - |
      MISSING_VARS=""
      
      if [ -z "$TYPOSENTINEL_API_TOKEN" ]; then
        MISSING_VARS="$MISSING_VARS TYPOSENTINEL_API_TOKEN"
      fi
      
      if [ -z "$TYPOSENTINEL_ENTERPRISE_LICENSE" ]; then
        echo "‚ö†Ô∏è  Warning: TYPOSENTINEL_ENTERPRISE_LICENSE not set (enterprise features disabled)"
      fi
      
      if [ -n "$MISSING_VARS" ]; then
        echo "‚ùå Missing required variables:$MISSING_VARS"
        exit 1
      fi
      
      echo "‚úÖ All required secrets are configured"
    
    # Test API connectivity
    - |
      if [ -n "$TYPOSENTINEL_API_ENDPOINT" ]; then
        echo "üåê Testing API connectivity..."
        if curl -f -H "Authorization: Bearer $TYPOSENTINEL_API_TOKEN" "$TYPOSENTINEL_API_ENDPOINT/health" >/dev/null 2>&1; then
          echo "‚úÖ API connectivity verified"
        else
          echo "‚ö†Ô∏è  Warning: API connectivity test failed"
        fi
      fi
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"

# ============================================================================
# SECURITY SCAN STAGE
# ============================================================================

# NPM Security Scan
scan-npm:
  stage: security-scan
  image: $NODE_IMAGE
  needs: ["validate-environment"]
  variables:
    REGISTRY: "npm"
  before_script:
    - echo "üì¶ Setting up NPM scanning environment"
    - apk add --no-cache curl jq bash openssl ca-certificates
    - npm config set cache /cache/.npm
    - npm config set audit-level moderate
  script:
    - echo "üîç Starting NPM security scan"
    
    # Install Typosentinel
    - |
      echo "üì• Installing Typosentinel..."
      if [ "$TYPOSENTINEL_VERSION" = "latest" ]; then
        DOWNLOAD_URL="https://github.com/typosentinel/typosentinel/releases/latest/download/typosentinel-linux-amd64"
      else
        DOWNLOAD_URL="https://github.com/typosentinel/typosentinel/releases/download/$TYPOSENTINEL_VERSION/typosentinel-linux-amd64"
      fi
      
      curl -L "$DOWNLOAD_URL" -o typosentinel
      chmod +x typosentinel
      mv typosentinel /usr/local/bin/
      typosentinel --version
    
    # Configure Typosentinel
    - |
      mkdir -p ~/.typosentinel
      cat > ~/.typosentinel/config.yaml << EOF
      api:
        endpoint: "${TYPOSENTINEL_API_ENDPOINT:-https://api.typosentinel.com}"
        token: "$TYPOSENTINEL_API_TOKEN"
        timeout: 300
      
      scanning:
        registry: "npm"
        parallel_workers: $PARALLEL_SCANS
        timeout: $SCAN_TIMEOUT
        deep_analysis: true
      
      detection:
        typosquatting:
          enabled: true
          algorithms: ["levenshtein", "jaro_winkler", "soundex"]
          threshold: 0.8
        dependency_confusion:
          enabled: true
          check_internal_packages: true
        supply_chain:
          enabled: true
          check_maintainer_changes: true
        zero_day:
          enabled: true
          ml_models: true
      
      policies:
        severity_threshold: "$SECURITY_THRESHOLD"
        fail_on_critical: true
      
      enterprise:
        license_key: "$TYPOSENTINEL_ENTERPRISE_LICENSE"
        compliance_mode: true
      EOF
    
    # Run NPM-specific preparation
    - |
      if [ -f "package.json" ]; then
        echo "üìã Installing NPM dependencies..."
        npm ci --audit=false || npm install --no-audit
        
        echo "üîç Running NPM audit..."
        npm audit --audit-level=moderate --json > reports/npm-audit.json || true
        
        echo "üìä Generating dependency tree..."
        npm list --json > reports/npm-dependencies.json || true
      fi
    
    # Run Typosentinel scan
    - |
      echo "üöÄ Running Typosentinel NPM scan..."
      typosentinel scan \
        --registry npm \
        --config ~/.typosentinel/config.yaml \
        --output-dir ./reports \
        --format json,sarif,html \
        --severity-threshold "$SECURITY_THRESHOLD" \
        --timeout $SCAN_TIMEOUT \
        --enterprise \
        --verbose \
        . || echo "Scan completed with findings"
    
    # Process results
    - |
      if [ -f "reports/scan-results.json" ]; then
        echo "üìà Processing scan results..."
        
        # Extract metrics
        TOTAL_PACKAGES=$(jq '.summary.total_packages // 0' reports/scan-results.json)
        VULNERABILITIES=$(jq '.summary.vulnerabilities // 0' reports/scan-results.json)
        CRITICAL=$(jq '.summary.critical_vulnerabilities // 0' reports/scan-results.json)
        
        echo "NPM_TOTAL_PACKAGES=$TOTAL_PACKAGES" >> npm-metrics.env
        echo "NPM_VULNERABILITIES=$VULNERABILITIES" >> npm-metrics.env
        echo "NPM_CRITICAL=$CRITICAL" >> npm-metrics.env
        
        echo "üìä NPM Scan Results:"
        echo "  - Total Packages: $TOTAL_PACKAGES"
        echo "  - Vulnerabilities: $VULNERABILITIES"
        echo "  - Critical: $CRITICAL"
        
        # Check for critical findings
        if [ "$CRITICAL" -gt 0 ]; then
          echo "‚ùå Critical vulnerabilities found in NPM packages"
          echo "NPM_SCAN_STATUS=failed" >> npm-metrics.env
        else
          echo "‚úÖ No critical vulnerabilities found in NPM packages"
          echo "NPM_SCAN_STATUS=passed" >> npm-metrics.env
        fi
      fi
  
  artifacts:
    reports:
      dotenv: npm-metrics.env
      junit: reports/npm-junit.xml
    paths:
      - reports/
      - npm-metrics.env
    expire_in: $ARTIFACT_RETENTION
    when: always
  
  rules:
    - if: $DETECTED_REGISTRIES =~ /npm/

# Python/PyPI Security Scan
scan-pypi:
  stage: security-scan
  image: $PYTHON_IMAGE
  needs: ["validate-environment"]
  variables:
    REGISTRY: "pypi"
  before_script:
    - echo "üêç Setting up Python scanning environment"
    - apt-get update && apt-get install -y curl jq git build-essential
    - pip install --upgrade pip setuptools wheel
    - pip install safety bandit pip-audit
  script:
    - echo "üîç Starting PyPI security scan"
    
    # Install Typosentinel
    - |
      echo "üì• Installing Typosentinel..."
      if [ "$TYPOSENTINEL_VERSION" = "latest" ]; then
        DOWNLOAD_URL="https://github.com/typosentinel/typosentinel/releases/latest/download/typosentinel-linux-amd64"
      else
        DOWNLOAD_URL="https://github.com/typosentinel/typosentinel/releases/download/$TYPOSENTINEL_VERSION/typosentinel-linux-amd64"
      fi
      
      curl -L "$DOWNLOAD_URL" -o typosentinel
      chmod +x typosentinel
      mv typosentinel /usr/local/bin/
      typosentinel --version
    
    # Configure Typosentinel for PyPI
    - |
      mkdir -p ~/.typosentinel
      cat > ~/.typosentinel/config.yaml << EOF
      api:
        endpoint: "${TYPOSENTINEL_API_ENDPOINT:-https://api.typosentinel.com}"
        token: "$TYPOSENTINEL_API_TOKEN"
      
      scanning:
        registry: "pypi"
        parallel_workers: $PARALLEL_SCANS
        timeout: $SCAN_TIMEOUT
      
      detection:
        typosquatting:
          enabled: true
          check_popular_packages: true
        dependency_confusion:
          enabled: true
        supply_chain:
          enabled: true
      
      enterprise:
        license_key: "$TYPOSENTINEL_ENTERPRISE_LICENSE"
      EOF
    
    # Run Python-specific security tools
    - |
      if [ -f "requirements.txt" ]; then
        echo "üîç Running Safety scan..."
        safety check --json --output reports/safety-report.json || true
        
        echo "üîç Running pip-audit..."
        pip-audit --format=json --output=reports/pip-audit.json || true
        
        echo "üìã Installing dependencies for analysis..."
        pip install -r requirements.txt --dry-run > reports/pip-install-log.txt 2>&1 || true
      fi
      
      if [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
        echo "üîç Running Bandit security scan..."
        bandit -r . -f json -o reports/bandit-report.json || true
      fi
    
    # Run Typosentinel scan
    - |
      echo "üöÄ Running Typosentinel PyPI scan..."
      typosentinel scan \
        --registry pypi \
        --config ~/.typosentinel/config.yaml \
        --output-dir ./reports \
        --format json,sarif,html \
        --severity-threshold "$SECURITY_THRESHOLD" \
        --timeout $SCAN_TIMEOUT \
        --enterprise \
        --verbose \
        . || echo "Scan completed with findings"
    
    # Process results
    - |
      if [ -f "reports/scan-results.json" ]; then
        TOTAL_PACKAGES=$(jq '.summary.total_packages // 0' reports/scan-results.json)
        VULNERABILITIES=$(jq '.summary.vulnerabilities // 0' reports/scan-results.json)
        CRITICAL=$(jq '.summary.critical_vulnerabilities // 0' reports/scan-results.json)
        
        echo "PYPI_TOTAL_PACKAGES=$TOTAL_PACKAGES" >> pypi-metrics.env
        echo "PYPI_VULNERABILITIES=$VULNERABILITIES" >> pypi-metrics.env
        echo "PYPI_CRITICAL=$CRITICAL" >> pypi-metrics.env
        
        if [ "$CRITICAL" -gt 0 ]; then
          echo "‚ùå Critical vulnerabilities found in PyPI packages"
          echo "PYPI_SCAN_STATUS=failed" >> pypi-metrics.env
        else
          echo "‚úÖ No critical vulnerabilities found in PyPI packages"
          echo "PYPI_SCAN_STATUS=passed" >> pypi-metrics.env
        fi
      fi
  
  artifacts:
    reports:
      dotenv: pypi-metrics.env
    paths:
      - reports/
      - pypi-metrics.env
    expire_in: $ARTIFACT_RETENTION
    when: always
  
  rules:
    - if: $DETECTED_REGISTRIES =~ /pypi/

# Maven Security Scan
scan-maven:
  stage: security-scan
  image: $JAVA_IMAGE
  needs: ["validate-environment"]
  variables:
    REGISTRY: "maven"
    MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  before_script:
    - echo "‚òï Setting up Maven scanning environment"
    - apt-get update && apt-get install -y curl jq git
    - curl -fsSL https://archive.apache.org/dist/maven/maven-3/3.9.5/binaries/apache-maven-3.9.5-bin.tar.gz | tar xz -C /opt
    - ln -s /opt/apache-maven-3.9.5/bin/mvn /usr/local/bin/mvn
  script:
    - echo "üîç Starting Maven security scan"
    
    # Install Typosentinel
    - |
      echo "üì• Installing Typosentinel..."
      if [ "$TYPOSENTINEL_VERSION" = "latest" ]; then
        DOWNLOAD_URL="https://github.com/typosentinel/typosentinel/releases/latest/download/typosentinel-linux-amd64"
      else
        DOWNLOAD_URL="https://github.com/typosentinel/typosentinel/releases/download/$TYPOSENTINEL_VERSION/typosentinel-linux-amd64"
      fi
      
      curl -L "$DOWNLOAD_URL" -o typosentinel
      chmod +x typosentinel
      mv typosentinel /usr/local/bin/
      typosentinel --version
    
    # Configure Typosentinel for Maven
    - |
      mkdir -p ~/.typosentinel
      cat > ~/.typosentinel/config.yaml << EOF
      api:
        endpoint: "${TYPOSENTINEL_API_ENDPOINT:-https://api.typosentinel.com}"
        token: "$TYPOSENTINEL_API_TOKEN"
      
      scanning:
        registry: "maven"
        parallel_workers: $PARALLEL_SCANS
        timeout: $SCAN_TIMEOUT
      
      detection:
        typosquatting:
          enabled: true
        dependency_confusion:
          enabled: true
          check_group_ids: true
        supply_chain:
          enabled: true
      
      enterprise:
        license_key: "$TYPOSENTINEL_ENTERPRISE_LICENSE"
      EOF
    
    # Run Maven-specific security tools
    - |
      if [ -f "pom.xml" ]; then
        echo "üìã Resolving Maven dependencies..."
        mvn dependency:resolve -q
        
        echo "üîç Running OWASP Dependency Check..."
        mvn org.owasp:dependency-check-maven:check \
          -Dformat=JSON \
          -DoutputDirectory=reports \
          -DsuppressionsFile=false || true
        
        echo "üìä Generating dependency tree..."
        mvn dependency:tree -DoutputFile=reports/maven-dependencies.txt || true
      fi
    
    # Run Typosentinel scan
    - |
      echo "üöÄ Running Typosentinel Maven scan..."
      typosentinel scan \
        --registry maven \
        --config ~/.typosentinel/config.yaml \
        --output-dir ./reports \
        --format json,sarif,html \
        --severity-threshold "$SECURITY_THRESHOLD" \
        --timeout $SCAN_TIMEOUT \
        --enterprise \
        --verbose \
        . || echo "Scan completed with findings"
    
    # Process results
    - |
      if [ -f "reports/scan-results.json" ]; then
        TOTAL_PACKAGES=$(jq '.summary.total_packages // 0' reports/scan-results.json)
        VULNERABILITIES=$(jq '.summary.vulnerabilities // 0' reports/scan-results.json)
        CRITICAL=$(jq '.summary.critical_vulnerabilities // 0' reports/scan-results.json)
        
        echo "MAVEN_TOTAL_PACKAGES=$TOTAL_PACKAGES" >> maven-metrics.env
        echo "MAVEN_VULNERABILITIES=$VULNERABILITIES" >> maven-metrics.env
        echo "MAVEN_CRITICAL=$CRITICAL" >> maven-metrics.env
        
        if [ "$CRITICAL" -gt 0 ]; then
          echo "‚ùå Critical vulnerabilities found in Maven packages"
          echo "MAVEN_SCAN_STATUS=failed" >> maven-metrics.env
        else
          echo "‚úÖ No critical vulnerabilities found in Maven packages"
          echo "MAVEN_SCAN_STATUS=passed" >> maven-metrics.env
        fi
      fi
  
  artifacts:
    reports:
      dotenv: maven-metrics.env
    paths:
      - reports/
      - maven-metrics.env
    expire_in: $ARTIFACT_RETENTION
    when: always
  
  rules:
    - if: $DETECTED_REGISTRIES =~ /maven/

# Zero-day scenario testing
zero-day-scenarios:
  stage: security-scan
  image: $SCANNER_IMAGE
  needs: ["validate-environment"]
  script:
    - echo "üéØ Running zero-day attack scenarios"
    - apt-get update && apt-get install -y curl jq nodejs npm python3 python3-pip ruby
    
    # Install Typosentinel
    - |
      if [ "$TYPOSENTINEL_VERSION" = "latest" ]; then
        DOWNLOAD_URL="https://github.com/typosentinel/typosentinel/releases/latest/download/typosentinel-linux-amd64"
      else
        DOWNLOAD_URL="https://github.com/typosentinel/typosentinel/releases/download/$TYPOSENTINEL_VERSION/typosentinel-linux-amd64"
      fi
      
      curl -L "$DOWNLOAD_URL" -o typosentinel
      chmod +x typosentinel
      mv typosentinel /usr/local/bin/
    
    # Run zero-day scenarios
    - |
      if [ -d "./tests/acme-enterprise/zero-day-scenarios" ]; then
        echo "üöÄ Executing zero-day attack simulations..."
        cd ./tests/acme-enterprise/zero-day-scenarios
        
        # Make scripts executable
        chmod +x *.sh *.js *.py *.rb
        
        # Run all scenarios
        ./run-all-scenarios.sh --output-dir "../../../reports/zero-day" --format json
        
        cd -
        
        # Test Typosentinel detection against generated scenarios
        echo "üîç Testing Typosentinel detection capabilities..."
        typosentinel test-scenarios \
          --scenarios-dir ./reports/zero-day \
          --output-dir ./reports \
          --format json,html \
          --enterprise || true
      else
        echo "‚ö†Ô∏è  Zero-day scenarios not found, skipping"
      fi
  
  artifacts:
    paths:
      - reports/
    expire_in: $ARTIFACT_RETENTION
    when: always
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - when: manual
      allow_failure: true

# ============================================================================
# ANALYSIS STAGE
# ============================================================================

aggregate-results:
  stage: analysis
  image: $SCANNER_IMAGE
  needs:
    - job: validate-environment
      artifacts: true
    - job: scan-npm
      artifacts: true
      optional: true
    - job: scan-pypi
      artifacts: true
      optional: true
    - job: scan-maven
      artifacts: true
      optional: true
    - job: zero-day-scenarios
      artifacts: true
      optional: true
  script:
    - echo "üìä Aggregating security scan results"
    - apt-get update && apt-get install -y jq python3 python3-pip
    - pip3 install jinja2
    
    # Combine all scan results
    - |
      echo "üîÑ Combining scan results..."
      mkdir -p aggregated-reports
      
      # Initialize combined results
      cat > aggregated-reports/combined-results.json << EOF
      {
        "pipeline_id": "$CI_PIPELINE_ID",
        "commit_sha": "$CI_COMMIT_SHA",
        "branch": "$CI_COMMIT_REF_NAME",
        "scan_date": "$(date -Iseconds)",
        "scans": []
      }
      EOF
      
      # Merge individual scan results
      for report_dir in reports/*/; do
        if [ -d "$report_dir" ] && [ -f "$report_dir/scan-results.json" ]; then
          registry=$(basename "$report_dir")
          echo "üìã Processing $registry results..."
          
          # Add registry info and merge
          jq --arg registry "$registry" '. + {"registry": $registry}' \
            "$report_dir/scan-results.json" > "temp-$registry.json"
          
          jq --slurpfile scan "temp-$registry.json" '.scans += $scan' \
            aggregated-reports/combined-results.json > temp-combined.json
          mv temp-combined.json aggregated-reports/combined-results.json
          
          rm "temp-$registry.json"
        fi
      done
    
    # Generate executive summary
    - |
      echo "üìà Generating executive summary..."
      python3 << 'EOF'
      import json
      import os
      from datetime import datetime
      
      # Load combined results
      with open('aggregated-reports/combined-results.json', 'r') as f:
          data = json.load(f)
      
      # Calculate metrics
      total_packages = 0
      total_vulnerabilities = 0
      total_critical = 0
      total_high = 0
      registries = []
      
      for scan in data.get('scans', []):
          summary = scan.get('summary', {})
          total_packages += summary.get('total_packages', 0)
          total_vulnerabilities += summary.get('vulnerabilities', 0)
          total_critical += summary.get('critical_vulnerabilities', 0)
          total_high += summary.get('high_vulnerabilities', 0)
          registries.append(scan.get('registry', 'unknown'))
      
      # Generate summary
      summary = {
          'pipeline_id': data.get('pipeline_id'),
          'commit_sha': data.get('commit_sha'),
          'branch': data.get('branch'),
          'scan_date': data.get('scan_date'),
          'registries_scanned': registries,
          'total_packages': total_packages,
          'total_vulnerabilities': total_vulnerabilities,
          'critical_vulnerabilities': total_critical,
          'high_vulnerabilities': total_high,
          'risk_score': min(100, total_critical * 10 + total_high * 5),
          'compliance_status': 'PASS' if total_critical == 0 else 'FAIL'
      }
      
      with open('aggregated-reports/executive-summary.json', 'w') as f:
          json.dump(summary, f, indent=2)
      
      # Set GitLab variables
      with open('summary-metrics.env', 'w') as f:
          f.write(f"TOTAL_PACKAGES={total_packages}\n")
          f.write(f"TOTAL_VULNERABILITIES={total_vulnerabilities}\n")
          f.write(f"CRITICAL_VULNERABILITIES={total_critical}\n")
          f.write(f"COMPLIANCE_STATUS={summary['compliance_status']}\n")
          f.write(f"RISK_SCORE={summary['risk_score']}\n")
      
      print(f"Executive summary generated:")
      print(f"- Total packages: {total_packages}")
      print(f"- Total vulnerabilities: {total_vulnerabilities}")
      print(f"- Critical: {total_critical}")
      print(f"- Compliance: {summary['compliance_status']}")
      EOF
    
    # Generate HTML report
    - |
      echo "üé® Generating HTML report..."
      python3 << 'EOF'
      import json
      
      with open('aggregated-reports/executive-summary.json', 'r') as f:
          summary = json.load(f)
      
      html = f'''
      <!DOCTYPE html>
      <html>
      <head>
          <title>ACME Enterprise Security Report</title>
          <style>
              body {{ font-family: Arial, sans-serif; margin: 40px; }}
              .header {{ background: #f8f9fa; padding: 20px; border-radius: 8px; }}
              .metric {{ display: inline-block; margin: 20px; text-align: center; }}
              .metric-value {{ font-size: 2em; font-weight: bold; }}
              .critical {{ color: #dc3545; }}
              .pass {{ color: #28a745; }}
              .fail {{ color: #dc3545; }}
          </style>
      </head>
      <body>
          <div class="header">
              <h1>üîç ACME Enterprise Security Report</h1>
              <p>Pipeline: {summary['pipeline_id']} | Branch: {summary['branch']}</p>
              <p>Scan Date: {summary['scan_date']}</p>
          </div>
          
          <h2>üìä Summary</h2>
          <div class="metrics">
              <div class="metric">
                  <div class="metric-value">{summary['total_packages']}</div>
                  <div>Packages Scanned</div>
              </div>
              <div class="metric">
                  <div class="metric-value">{summary['total_vulnerabilities']}</div>
                  <div>Total Vulnerabilities</div>
              </div>
              <div class="metric">
                  <div class="metric-value critical">{summary['critical_vulnerabilities']}</div>
                  <div>Critical</div>
              </div>
              <div class="metric">
                  <div class="metric-value {summary['compliance_status'].lower()}">{summary['compliance_status']}</div>
                  <div>Compliance</div>
              </div>
          </div>
          
          <h2>üéØ Registries Scanned</h2>
          <ul>
      '''
      
      for registry in summary['registries_scanned']:
          html += f'<li>{registry.upper()}</li>'
      
      html += '''
          </ul>
          <p><em>Generated by ACME Enterprise Security Pipeline</em></p>
      </body>
      </html>
      '''
      
      with open('aggregated-reports/security-report.html', 'w') as f:
          f.write(html)
      EOF
  
  artifacts:
    reports:
      dotenv: summary-metrics.env
    paths:
      - aggregated-reports/
      - summary-metrics.env
    expire_in: $ARTIFACT_RETENTION

# ============================================================================
# REPORTING STAGE
# ============================================================================

generate-compliance-report:
  stage: report
  image: $SCANNER_IMAGE
  needs:
    - job: aggregate-results
      artifacts: true
  script:
    - echo "üìã Generating compliance reports"
    - apt-get update && apt-get install -y jq python3 python3-pip wkhtmltopdf
    - pip3 install weasyprint
    
    # Generate compliance report
    - |
      echo "üìä Creating compliance documentation..."
      
      if [ -f "aggregated-reports/executive-summary.json" ]; then
        python3 << 'EOF'
        import json
        from datetime import datetime
        
        with open('aggregated-reports/executive-summary.json', 'r') as f:
            summary = json.load(f)
        
        # Generate compliance report
        compliance = {
            'report_date': datetime.now().isoformat(),
            'compliance_framework': 'ACME Enterprise Security Standards',
            'scan_coverage': {
                'registries': summary['registries_scanned'],
                'packages_scanned': summary['total_packages']
            },
            'security_posture': {
                'overall_status': summary['compliance_status'],
                'risk_score': summary['risk_score'],
                'critical_findings': summary['critical_vulnerabilities'],
                'high_findings': summary['high_vulnerabilities']
            },
            'recommendations': [],
            'next_scan_date': 'Scheduled daily at 02:00 UTC'
        }
        
        # Add recommendations
        if summary['critical_vulnerabilities'] > 0:
            compliance['recommendations'].append({
                'priority': 'HIGH',
                'action': 'Immediately remediate critical vulnerabilities',
                'timeline': '24 hours'
            })
        
        if summary['total_vulnerabilities'] > 50:
            compliance['recommendations'].append({
                'priority': 'MEDIUM',
                'action': 'Review dependency management practices',
                'timeline': '1 week'
            })
        
        with open('aggregated-reports/compliance-report.json', 'w') as f:
            json.dump(compliance, f, indent=2)
        
        print("Compliance report generated")
        EOF
      fi
    
    # Convert HTML to PDF
    - |
      if [ -f "aggregated-reports/security-report.html" ]; then
        echo "üìÑ Converting HTML report to PDF..."
        wkhtmltopdf aggregated-reports/security-report.html aggregated-reports/security-report.pdf || \
        python3 -c "import weasyprint; weasyprint.HTML(filename='aggregated-reports/security-report.html').write_pdf('aggregated-reports/security-report.pdf')"
      fi
  
  artifacts:
    paths:
      - aggregated-reports/
    expire_in: $ARTIFACT_RETENTION

# ============================================================================
# NOTIFICATION AND DEPLOYMENT
# ============================================================================

notify-teams:
  stage: report
  image: $SCANNER_IMAGE
  needs:
    - job: aggregate-results
      artifacts: true
  script:
    - echo "üì¢ Sending notifications"
    - apt-get update && apt-get install -y curl jq
    
    # Send Slack notification
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ] && [ -f "aggregated-reports/executive-summary.json" ]; then
        echo "üì± Sending Slack notification..."
        
        summary=$(cat aggregated-reports/executive-summary.json)
        compliance_status=$(echo "$summary" | jq -r '.compliance_status')
        critical_count=$(echo "$summary" | jq -r '.critical_vulnerabilities')
        total_vulns=$(echo "$summary" | jq -r '.total_vulnerabilities')
        
        if [ "$compliance_status" = "FAIL" ]; then
          color="danger"
          emoji="üö®"
        else
          color="good"
          emoji="‚úÖ"
        fi
        
        payload=$(cat << EOF
        {
          "text": "$emoji ACME Enterprise Security Scan Report",
          "attachments": [
            {
              "color": "$color",
              "fields": [
                {
                  "title": "Status",
                  "value": "$compliance_status",
                  "short": true
                },
                {
                  "title": "Critical",
                  "value": "$critical_count",
                  "short": true
                },
                {
                  "title": "Total Vulnerabilities",
                  "value": "$total_vulns",
                  "short": true
                },
                {
                  "title": "Pipeline",
                  "value": "<$CI_PIPELINE_URL|$CI_PIPELINE_ID>",
                  "short": true
                }
              ]
            }
          ]
        }
        EOF
        )
        
        curl -X POST -H 'Content-type: application/json' \
          --data "$payload" \
          "$SLACK_WEBHOOK_URL"
      fi
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $COMPLIANCE_STATUS == "FAIL"
    - when: manual
      allow_failure: true

# Fail pipeline on critical findings
fail-on-critical:
  stage: report
  image: $SCANNER_IMAGE
  needs:
    - job: aggregate-results
      artifacts: true
  script:
    - echo "üîç Checking for critical security findings"
    
    - |
      if [ "$COMPLIANCE_STATUS" = "FAIL" ]; then
        echo "‚ùå Pipeline failed due to critical security findings"
        echo "Critical vulnerabilities found: $CRITICAL_VULNERABILITIES"
        echo "Please review the security report and address critical issues."
        exit 1
      else
        echo "‚úÖ No critical security findings detected"
      fi
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deploy security dashboard (optional)
deploy-dashboard:
  stage: deploy
  image: $SCANNER_IMAGE
  needs:
    - job: generate-compliance-report
      artifacts: true
  script:
    - echo "üöÄ Deploying security dashboard"
    
    # Deploy to internal security dashboard
    - |
      if [ -n "$SECURITY_DASHBOARD_URL" ] && [ -n "$SECURITY_DASHBOARD_TOKEN" ]; then
        echo "üìä Uploading results to security dashboard..."
        
        curl -X POST \
          -H "Authorization: Bearer $SECURITY_DASHBOARD_TOKEN" \
          -H "Content-Type: application/json" \
          -d @aggregated-reports/executive-summary.json \
          "$SECURITY_DASHBOARD_URL/api/scans"
      fi
  
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - when: manual
      allow_failure: true