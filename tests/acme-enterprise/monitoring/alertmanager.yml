# ACME Enterprise AlertManager Configuration
# Comprehensive alert routing and notification management

global:
  # SMTP configuration for email alerts
  smtp_smarthost: 'smtp.acme.com:587'
  smtp_from: 'alerts@acme.com'
  smtp_auth_username: 'alerts@acme.com'
  smtp_auth_password: 'smtp_password_2024'
  smtp_require_tls: true
  
  # Slack API URL
  slack_api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX'
  
  # PagerDuty integration key
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'
  
  # Microsoft Teams webhook
  teams_webhook_url: 'https://acme.webhook.office.com/webhookb2/xxx'
  
  # Resolve timeout
  resolve_timeout: 5m

# Templates for custom alert formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Alert routing configuration
route:
  # Default receiver for unmatched alerts
  receiver: 'default-notifications'
  
  # Group alerts by these labels
  group_by: ['alertname', 'cluster', 'service']
  
  # Wait time before sending initial notification
  group_wait: 30s
  
  # Wait time before sending additional notifications for new alerts in group
  group_interval: 5m
  
  # Wait time before sending repeat notifications
  repeat_interval: 4h
  
  # Child routes for specific alert types
  routes:
    # Critical Security Alerts - Immediate response
    - match:
        alert_type: security
        severity: critical
      receiver: 'security-critical'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 30m
      continue: true
    
    # High Security Alerts
    - match:
        alert_type: security
        severity: high
      receiver: 'security-high'
      group_wait: 30s
      group_interval: 2m
      repeat_interval: 1h
      continue: true
    
    # Zero-Day Threats - Highest priority
    - match:
        alert_type: zero_day
      receiver: 'zero-day-response'
      group_wait: 0s
      group_interval: 30s
      repeat_interval: 15m
      continue: true
    
    # Compliance Violations
    - match:
        alert_type: compliance
      receiver: 'compliance-team'
      group_wait: 1m
      group_interval: 5m
      repeat_interval: 2h
    
    # Operational Alerts
    - match:
        alert_type: operational
        severity: critical
      receiver: 'ops-critical'
      group_wait: 30s
      group_interval: 2m
      repeat_interval: 1h
    
    # Performance Alerts
    - match:
        alert_type: performance
      receiver: 'ops-performance'
      group_wait: 2m
      group_interval: 5m
      repeat_interval: 2h
    
    # Resource Alerts
    - match:
        alert_type: resource
      receiver: 'ops-resources'
      group_wait: 5m
      group_interval: 10m
      repeat_interval: 4h
    
    # Database Alerts
    - match:
        service: postgresql
      receiver: 'database-team'
      group_wait: 1m
      group_interval: 3m
      repeat_interval: 1h
    
    # Registry Alerts
    - match:
        service: registry
      receiver: 'registry-team'
      group_wait: 2m
      group_interval: 5m
      repeat_interval: 2h
    
    # Development Environment (lower priority)
    - match:
        environment: development
      receiver: 'dev-notifications'
      group_wait: 10m
      group_interval: 30m
      repeat_interval: 12h
    
    # Staging Environment
    - match:
        environment: staging
      receiver: 'staging-notifications'
      group_wait: 5m
      group_interval: 15m
      repeat_interval: 6h

# Inhibition rules to suppress redundant alerts
inhibit_rules:
  # Suppress warning alerts when critical alerts are firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'cluster', 'service']
  
  # Suppress high alerts when critical alerts are firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'high'
    equal: ['alertname', 'cluster', 'service']
  
  # Suppress operational alerts when security alerts are firing
  - source_match:
      alert_type: 'security'
    target_match:
      alert_type: 'operational'
    equal: ['service']
  
  # Suppress individual service alerts when cluster-wide alerts are firing
  - source_match:
      alertname: 'ClusterDown'
    target_match_re:
      alertname: '.*ServiceDown.*'
    equal: ['cluster']

# Notification receivers
receivers:
  # Default notifications
  - name: 'default-notifications'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#alerts-general'
        title: 'ACME Enterprise Alert'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          {{ end }}
        send_resolved: true
    
    email_configs:
      - to: 'ops-team@acme.com'
        subject: '[ACME] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          Service: {{ .Labels.service }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}

  # Critical Security Alerts
  - name: 'security-critical'
    pagerduty_configs:
      - routing_key: 'security-critical-key'
        description: '{{ .GroupLabels.alertname }}: {{ .Annotations.summary }}'
        severity: 'critical'
        details:
          alert_type: '{{ .Labels.alert_type }}'
          service: '{{ .Labels.service }}'
          registry: '{{ .Labels.registry }}'
          runbook: '{{ .Annotations.runbook_url }}'
    
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#security-critical'
        title: 'üö® CRITICAL SECURITY ALERT'
        color: 'danger'
        text: |
          {{ range .Alerts }}
          *CRITICAL SECURITY THREAT DETECTED*
          
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Registry:* {{ .Labels.registry }}
          *Package:* {{ .Labels.package_name }}{{ if .Labels.package_version }}@{{ .Labels.package_version }}{{ end }}
          *Threat Type:* {{ .Labels.attack_type }}{{ .Labels.threat_type }}
          *Runbook:* {{ .Annotations.runbook_url }}
          *Dashboard:* {{ .Annotations.dashboard_url }}
          
          @channel @security-team
          {{ end }}
        send_resolved: true
    
    email_configs:
      - to: 'security-team@acme.com, ciso@acme.com, incident-response@acme.com'
        subject: 'üö® [CRITICAL SECURITY] {{ .GroupLabels.alertname }}'
        body: |
          CRITICAL SECURITY ALERT - IMMEDIATE ACTION REQUIRED
          
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Registry: {{ .Labels.registry }}
          Package: {{ .Labels.package_name }}{{ if .Labels.package_version }}@{{ .Labels.package_version }}{{ end }}
          Threat Type: {{ .Labels.attack_type }}{{ .Labels.threat_type }}
          
          Runbook: {{ .Annotations.runbook_url }}
          Dashboard: {{ .Annotations.dashboard_url }}
          
          This alert requires immediate investigation and response.
          {{ end }}
    
    webhook_configs:
      - url: 'https://api.acme.com/security/alerts/webhook'
        http_config:
          bearer_token: 'security_webhook_token'
        send_resolved: true

  # High Security Alerts
  - name: 'security-high'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#security-alerts'
        title: '‚ö†Ô∏è High Security Alert'
        color: 'warning'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Registry:* {{ .Labels.registry }}
          *Severity:* {{ .Labels.severity }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
    
    email_configs:
      - to: 'security-team@acme.com'
        subject: '[HIGH SECURITY] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Registry: {{ .Labels.registry }}
          Severity: {{ .Labels.severity }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}

  # Zero-Day Response Team
  - name: 'zero-day-response'
    pagerduty_configs:
      - routing_key: 'zero-day-response-key'
        description: 'ZERO-DAY THREAT: {{ .Annotations.summary }}'
        severity: 'critical'
        details:
          threat_type: '{{ .Labels.threat_type }}'
          threat_signature: '{{ .Labels.threat_signature }}'
          registry: '{{ .Labels.registry }}'
          package: '{{ .Labels.package_name }}'
    
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#zero-day-response'
        title: 'üî• ZERO-DAY THREAT DETECTED'
        color: 'danger'
        text: |
          {{ range .Alerts }}
          *ZERO-DAY THREAT DETECTED*
          
          *Threat:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Threat Type:* {{ .Labels.threat_type }}
          *Signature:* {{ .Labels.threat_signature }}
          *Registry:* {{ .Labels.registry }}
          *Package:* {{ .Labels.package_name }}
          
          @channel @zero-day-team @security-lead
          {{ end }}
        send_resolved: true
    
    webhook_configs:
      - url: 'https://api.acme.com/security/zero-day/webhook'
        http_config:
          bearer_token: 'zero_day_webhook_token'

  # Compliance Team
  - name: 'compliance-team'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#compliance-alerts'
        title: 'üìã Compliance Alert'
        color: 'warning'
        text: |
          {{ range .Alerts }}
          *Compliance Issue:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Policy:* {{ .Labels.policy }}
          *Registry:* {{ .Labels.registry }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true
    
    email_configs:
      - to: 'compliance@acme.com, legal@acme.com'
        subject: '[COMPLIANCE] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Compliance Issue: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Policy: {{ .Labels.policy }}
          Registry: {{ .Labels.registry }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}

  # Operations Critical
  - name: 'ops-critical'
    pagerduty_configs:
      - routing_key: 'ops-critical-key'
        description: '{{ .GroupLabels.alertname }}: {{ .Annotations.summary }}'
        severity: 'critical'
    
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#ops-critical'
        title: 'üö® Critical Operational Alert'
        color: 'danger'
        text: |
          {{ range .Alerts }}
          *Service Down:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          *Instance:* {{ .Labels.instance }}
          *Runbook:* {{ .Annotations.runbook_url }}
          
          @channel @ops-oncall
          {{ end }}
        send_resolved: true

  # Operations Performance
  - name: 'ops-performance'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#ops-performance'
        title: '‚ö° Performance Alert'
        color: 'warning'
        text: |
          {{ range .Alerts }}
          *Performance Issue:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          *Metric:* {{ .Labels.alertname }}
          {{ end }}
        send_resolved: true

  # Operations Resources
  - name: 'ops-resources'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#ops-resources'
        title: 'üíæ Resource Alert'
        text: |
          {{ range .Alerts }}
          *Resource Issue:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Instance:* {{ .Labels.instance }}
          *Resource:* {{ .Labels.alertname }}
          {{ end }}
        send_resolved: true

  # Database Team
  - name: 'database-team'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#database-alerts'
        title: 'üóÑÔ∏è Database Alert'
        text: |
          {{ range .Alerts }}
          *Database Issue:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Database:* {{ .Labels.datname }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}
        send_resolved: true
    
    email_configs:
      - to: 'dba-team@acme.com'
        subject: '[DATABASE] {{ .GroupLabels.alertname }}'

  # Registry Team
  - name: 'registry-team'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#registry-alerts'
        title: 'üì¶ Registry Alert'
        text: |
          {{ range .Alerts }}
          *Registry Issue:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Registry:* {{ .Labels.instance }}
          {{ end }}
        send_resolved: true

  # Development Environment
  - name: 'dev-notifications'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#dev-alerts'
        title: 'üîß Development Alert'
        text: |
          {{ range .Alerts }}
          *Dev Alert:* {{ .Annotations.summary }}
          *Service:* {{ .Labels.service }}
          {{ end }}
        send_resolved: true

  # Staging Environment
  - name: 'staging-notifications'
    slack_configs:
      - api_url: '{{ .slack_api_url }}'
        channel: '#staging-alerts'
        title: 'üé≠ Staging Alert'
        text: |
          {{ range .Alerts }}
          *Staging Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          {{ end }}
        send_resolved: true
    
    email_configs:
      - to: 'staging-team@acme.com'
        subject: '[STAGING] {{ .GroupLabels.alertname }}'

# Silence configuration
silences:
  # Example: Silence maintenance windows
  - matchers:
      - name: alertname
        value: MaintenanceWindow
    starts_at: '2024-01-01T02:00:00Z'
    ends_at: '2024-01-01T06:00:00Z'
    created_by: 'ops-team@acme.com'
    comment: 'Scheduled maintenance window'

# Time intervals for different notification schedules
time_intervals:
  - name: business-hours
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '17:00'
        weekdays: ['monday:friday']
        location: 'America/New_York'
  
  - name: after-hours
    time_intervals:
      - times:
          - start_time: '17:01'
            end_time: '08:59'
        weekdays: ['monday:friday']
        location: 'America/New_York'
      - weekdays: ['saturday', 'sunday']
        location: 'America/New_York'