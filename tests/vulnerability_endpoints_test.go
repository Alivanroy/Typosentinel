package tests

import (
    "bytes"
    "context"
    "net/http"
    "testing"
    "time"
    "os"
    "github.com/Alivanroy/Typosentinel/internal/api/rest"
    "github.com/Alivanroy/Typosentinel/internal/config"
)

func TestVulnerabilityEndpointsAlignment(t *testing.T) {
    os.Setenv("TYPOSENTINEL_ENVIRONMENT", "development")
    cfg := config.RESTAPIConfig{Enabled: true, Host: "127.0.0.1", Port: 8091, BasePath: "/api", Versioning: config.APIVersioning{Enabled: true, Strategy: "path", DefaultVersion: "v1", SupportedVersions: []string{"v1"}}}
    srv := rest.NewServer(cfg, nil, nil)
    go func() { _ = srv.Start(context.Background()) }()
    defer func() { _ = srv.Stop(context.Background()) }()

    deadline := time.Now().Add(30 * time.Second)
    for {
        if time.Now().After(deadline) { t.Fatalf("server not ready") }
        r, err := http.Get("http://127.0.0.1:8091/health")
        if err == nil && r.StatusCode == 200 { r.Body.Close(); break }
        time.Sleep(100 * time.Millisecond)
    }

    bodyScan := []byte(`{"ecosystem":"npm","name":"express","version":"latest"}`)
    r, err := http.Post("http://127.0.0.1:8091/api/v1/vulnerabilities/scan", "application/json", bytes.NewReader(bodyScan))
    if err != nil { t.Fatalf("scan err: %v", err) }
    if r.StatusCode != 200 { t.Fatalf("scan status: %d", r.StatusCode) }
    r.Body.Close()

    bodyPath := []byte(`{"version":"latest"}`)
    r, err = http.Post("http://127.0.0.1:8091/api/v1/vulnerabilities/scan/npm/express", "application/json", bytes.NewReader(bodyPath))
    if err != nil { t.Fatalf("scan path err: %v", err) }
    if r.StatusCode != 200 { t.Fatalf("scan path status: %d", r.StatusCode) }
    r.Body.Close()

    batch := []byte(`{"packages":[{"ecosystem":"npm","name":"express","version":"latest"},{"ecosystem":"npm","name":"lodash","version":"4.17.21"}]}`)
    r, err = http.Post("http://127.0.0.1:8091/api/v1/vulnerabilities/batch-scan", "application/json", bytes.NewReader(batch))
    if err != nil { t.Fatalf("batch err: %v", err) }
    if r.StatusCode != 200 { t.Fatalf("batch status: %d", r.StatusCode) }
    r.Body.Close()
}