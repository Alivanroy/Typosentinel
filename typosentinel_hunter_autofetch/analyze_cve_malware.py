#!/usr/bin/env python3
"""
CVE Candidate Malware Analysis
Analyzes the high-risk packages found during CVE hunting for malicious content
"""

import json
import sys
import os
from pathlib import Path
from malware_multi_ecosystem import MultiEcosystemMalwareAnalyzer

def main():
    # High-risk CVE candidates to analyze
    high_risk_candidates = [
        {"name": "jsonwebtokens", "ecosystem": "npm", "risk": 0.72, "priority": "CRITICAL"},
        {"name": "sjonwebtoken", "ecosystem": "npm", "risk": 0.72, "priority": "CRITICAL"},
        {"name": "m0cha", "ecosystem": "npm", "risk": 0.72, "priority": "CRITICAL"},
        {"name": "xaios", "ecosystem": "npm", "risk": 0.72, "priority": "CRITICAL"},
        {"name": "momentx", "ecosystem": "npm", "risk": 0.72, "priority": "HIGH"},
        {"name": "concurrentl", "ecosystem": "npm", "risk": 0.72, "priority": "HIGH"},
        {"name": "fs-extr@", "ecosystem": "npm", "risk": 0.72, "priority": "HIGH"},
        {"name": "prettier-test", "ecosystem": "npm", "risk": 0.72, "priority": "HIGH"},
        # Additional suspicious PyPI packages
        {"name": "lib-crypto", "ecosystem": "pypi", "risk": 0.0, "priority": "MEDIUM"},
        {"name": "crypto-dev", "ecosystem": "pypi", "risk": 0.0, "priority": "MEDIUM"},
        {"name": "pytests", "ecosystem": "pypi", "risk": 0.0, "priority": "MEDIUM"},
        {"name": "sqlalchemys", "ecosystem": "pypi", "risk": 0.0, "priority": "MEDIUM"},
    ]
    
    print("ðŸ” Starting CVE Candidate Malware Analysis")
    print("=" * 60)
    
    analyzer = MultiEcosystemMalwareAnalyzer()
    results = []
    
    for i, candidate in enumerate(high_risk_candidates, 1):
        print(f"\n[{i}/{len(high_risk_candidates)}] Analyzing: {candidate['name']} ({candidate['ecosystem']})")
        print(f"Priority: {candidate['priority']} | Risk Score: {candidate['risk']}")
        print("-" * 50)
        
        try:
            # Analyze the package
            success, findings = analyzer.analyze_package(
                candidate['name'], 
                candidate['ecosystem']
            )
            
            if success:
                # Count findings by severity
                critical_count = len([f for f in findings if f['severity'] == 'CRITICAL'])
                high_count = len([f for f in findings if f['severity'] == 'HIGH'])
                medium_count = len([f for f in findings if f['severity'] == 'MEDIUM'])
                low_count = len([f for f in findings if f['severity'] == 'LOW'])
                
                result = {
                    'package_name': candidate['name'],
                    'ecosystem': candidate['ecosystem'],
                    'priority': candidate['priority'],
                    'cve_risk_score': candidate['risk'],
                    'analysis_success': True,
                    'total_findings': len(findings),
                    'critical_findings': critical_count,
                    'high_findings': high_count,
                    'medium_findings': medium_count,
                    'low_findings': low_count,
                    'findings': findings
                }
                
                results.append(result)
                
                # Print summary
                print(f"âœ… Analysis complete for {candidate['name']}")
                print(f"   Total findings: {len(findings)}")
                print(f"   Critical: {critical_count}")
                print(f"   High: {high_count}")
                print(f"   Medium: {medium_count}")
                
                if critical_count > 0:
                    print(f"ðŸš¨ CRITICAL MALWARE DETECTED in {candidate['name']}!")
                elif high_count > 0:
                    print(f"âš ï¸  HIGH-RISK patterns found in {candidate['name']}")
                elif medium_count > 0:
                    print(f"âš ï¸  Medium-risk patterns found in {candidate['name']}")
                else:
                    print(f"âœ… No suspicious patterns found in {candidate['name']}")
                    
            else:
                print(f"âŒ Failed to analyze {candidate['name']}")
                # Still add to results for tracking
                results.append({
                    'package_name': candidate['name'],
                    'ecosystem': candidate['ecosystem'],
                    'priority': candidate['priority'],
                    'cve_risk_score': candidate['risk'],
                    'analysis_success': False,
                    'total_findings': 0,
                    'critical_findings': 0,
                    'high_findings': 0,
                    'medium_findings': 0,
                    'low_findings': 0,
                    'findings': []
                })
                
        except Exception as e:
            print(f"âŒ Error analyzing {candidate['name']}: {e}")
            # Add failed analysis to results
            results.append({
                'package_name': candidate['name'],
                'ecosystem': candidate['ecosystem'],
                'priority': candidate['priority'],
                'cve_risk_score': candidate['risk'],
                'analysis_success': False,
                'error': str(e),
                'total_findings': 0,
                'critical_findings': 0,
                'high_findings': 0,
                'medium_findings': 0,
                'low_findings': 0,
                'findings': []
            })
            continue
    
    # Save results
    output_dir = Path("cve_malware_analysis_results")
    output_dir.mkdir(exist_ok=True)
    
    # Save detailed results
    results_file = output_dir / "cve_malware_analysis.json"
    with open(results_file, 'w') as f:
        json.dump(results, f, indent=2)
    
    # Generate summary report
    generate_summary_report(results, output_dir)
    
    print(f"\nðŸŽ¯ CVE Malware Analysis Complete!")
    print(f"ðŸ“ Results saved to: {output_dir}")
    print(f"ðŸ“Š Analyzed {len(results)} packages")
    
    # Print critical findings summary
    critical_packages = [r for r in results if r.get('critical_findings', 0) > 0]
    high_risk_packages = [r for r in results if r.get('high_findings', 0) > 0]
    
    if critical_packages:
        print(f"\nðŸš¨ CRITICAL MALWARE FOUND in {len(critical_packages)} packages:")
        for pkg in critical_packages:
            print(f"   - {pkg['package_name']} ({pkg['ecosystem']})")
    
    if high_risk_packages:
        print(f"\nâš ï¸  HIGH-RISK patterns in {len(high_risk_packages)} packages:")
        for pkg in high_risk_packages:
            print(f"   - {pkg['package_name']} ({pkg['ecosystem']})")

def generate_summary_report(results, output_dir):
    """Generate a markdown summary report"""
    from datetime import datetime
    
    report_content = """# CVE Candidate Malware Analysis Report

## Executive Summary

This report contains the malware analysis results for high-risk CVE candidates identified during our security hunt.

## Analysis Overview

"""
    
    total_packages = len(results)
    successful_analyses = len([r for r in results if r.get('analysis_success', False)])
    critical_count = len([r for r in results if r.get('critical_findings', 0) > 0])
    high_count = len([r for r in results if r.get('high_findings', 0) > 0])
    medium_count = len([r for r in results if r.get('medium_findings', 0) > 0])
    clean_count = total_packages - critical_count - high_count - medium_count
    
    report_content += f"""
- **Total Packages Analyzed**: {total_packages}
- **Critical Malware**: {critical_count}
- **High-Risk Patterns**: {high_count}
- **Medium-Risk Patterns**: {medium_count}
- **Clean Packages**: {clean_count}

## Detailed Results

"""
    
    # Sort by priority and findings
    sorted_results = sorted(results, key=lambda x: (
        x.get('critical_findings', 0) * 1000 + 
        x.get('high_findings', 0) * 100 + 
        x.get('medium_findings', 0)
    ), reverse=True)
    
    for result in sorted_results:
        name = result.get('package_name', 'Unknown')
        ecosystem = result.get('ecosystem', 'Unknown')
        priority = result.get('priority', 'Unknown')
        cve_risk = result.get('cve_risk_score', 0)
        
        critical = result.get('critical_findings', 0)
        high = result.get('high_findings', 0)
        medium = result.get('medium_findings', 0)
        total = result.get('total_findings', 0)
        
        status = "ðŸŸ¢ CLEAN"
        if critical > 0:
            status = "ðŸ”´ CRITICAL MALWARE"
        elif high > 0:
            status = "ðŸŸ¡ HIGH-RISK"
        elif medium > 0:
            status = "ðŸŸ  MEDIUM-RISK"
        
        report_content += f"""
### {name} ({ecosystem})

- **Status**: {status}
- **Priority**: {priority}
- **CVE Risk Score**: {cve_risk}
- **Total Findings**: {total}
  - Critical: {critical}
  - High: {high}
  - Medium: {medium}

"""
        
        # Add specific findings if any
        if total > 0:
            findings = result.get('findings', [])
            if findings:
                report_content += "**Key Findings:**\n"
                for finding in findings[:5]:  # Show top 5 findings
                    severity = finding.get('severity', 'unknown')
                    pattern_type = finding.get('pattern_type', 'unknown')
                    file_path = finding.get('file', 'unknown')
                    report_content += f"- {severity.upper()}: {pattern_type} in {file_path}\n"
                
                if len(findings) > 5:
                    report_content += f"- ... and {len(findings) - 5} more findings\n"
                
                report_content += "\n"
    
    report_content += """
## Recommendations

1. **Critical Packages**: Immediately block and investigate packages with critical malware
2. **High-Risk Packages**: Review and potentially block packages with high-risk patterns
3. **Medium-Risk Packages**: Monitor and investigate further
4. **CVE Reporting**: Create CVE reports for packages with confirmed malicious behavior

## Next Steps

1. Report critical findings to security teams
2. Create detection rules for identified patterns
3. Monitor for similar typosquatting campaigns
4. Update security policies based on findings

---
*Report generated by CVE Malware Analysis Tool*
"""
    
    report_file = output_dir / "cve_malware_analysis_report.md"
    with open(report_file, 'w') as f:
        f.write(report_content)
    
    print(f"ðŸ“‹ Summary report saved to: {report_file}")

if __name__ == "__main__":
    main()