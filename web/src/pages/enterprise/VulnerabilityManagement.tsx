import React, { useState, useEffect } from 'react';
import {
  Box,
  Grid,
  Card,
  CardContent,
  Typography,
  Button,
  Chip,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  IconButton,
  Tooltip,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Tabs,
  Tab,
  LinearProgress,
  Alert,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  List,
  ListItem,
  ListItemText,
  ListItemIcon,
  Divider,
  Avatar,
  AvatarGroup,
} from '@mui/material';
import {
  ExpandMore as ExpandMoreIcon,
  Security as SecurityIcon,
  Warning as WarningIcon,
  Error as ErrorIcon,
  CheckCircle as CheckCircleIcon,
  Schedule as ScheduleIcon,
  Assignment as AssignmentIcon,
  Person as PersonIcon,
  CalendarToday as CalendarIcon,
  TrendingUp as TrendingUpIcon,
  TrendingDown as TrendingDownIcon,
  FilterList as FilterIcon,
  Search as SearchIcon,
  GetApp as ExportIcon,
  Refresh as RefreshIcon,
  BugReport as BugIcon,
  Shield as ShieldIcon,
  Link as LinkIcon,
} from '@mui/icons-material';
import { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, ResponsiveContainer, LineChart, Line } from 'recharts';

interface Vulnerability {
  id: string;
  title: string;
  description: string;
  severity: 'critical' | 'high' | 'medium' | 'low';
  status: 'open' | 'in-progress' | 'resolved' | 'false-positive';
  category: 'typosquatting' | 'malware' | 'supply-chain' | 'dependency' | 'configuration';
  cve?: string;
  cvss?: number;
  package: {
    name: string;
    version: string;
    ecosystem: string;
  };
  discoveredAt: Date;
  lastUpdated: Date;
  assignee?: {
    name: string;
    email: string;
    avatar?: string;
  };
  reporter: {
    name: string;
    source: 'scan' | 'manual' | 'external';
  };
  affectedProjects: string[];
  remediation: {
    recommendation: string;
    effort: 'low' | 'medium' | 'high';
    priority: number;
  };
  references: Array<{
    type: 'cve' | 'advisory' | 'blog' | 'documentation';
    url: string;
    title: string;
  }>;
  timeline: Array<{
    date: Date;
    action: string;
    user: string;
    details?: string;
  }>;
}

const VulnerabilityManagement: React.FC = () => {
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedTab, setSelectedTab] = useState(0);
  const [filterStatus, setFilterStatus] = useState<string>('all');
  const [filterSeverity, setFilterSeverity] = useState<string>('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedVulnerability, setSelectedVulnerability] = useState<Vulnerability | null>(null);
  const [detailsDialogOpen, setDetailsDialogOpen] = useState(false);

  useEffect(() => {
    loadVulnerabilities();
  }, []);

  const loadVulnerabilities = async () => {
    try {
      // Simulate API call - replace with actual API
      const mockVulnerabilities: Vulnerability[] = [
        {
          id: '1',
          title: 'Typosquatting Attack: lodahs Package',
          description: 'Package "lodahs" appears to be typosquatting the popular "lodash" library. Contains malicious code that exfiltrates environment variables.',
          severity: 'critical',
          status: 'open',
          category: 'typosquatting',
          cve: 'CVE-2025-12345',
          cvss: 9.1,
          package: {
            name: 'lodahs',
            version: '1.0.0',
            ecosystem: 'npm',
          },
          discoveredAt: new Date('2025-06-14T10:30:00'),
          lastUpdated: new Date('2025-06-14T14:20:00'),
          assignee: {
            name: 'Sarah Chen',
            email: 'sarah.chen@company.com',
            avatar: '/avatars/sarah.jpg',
          },
          reporter: {
            name: 'TypoSentinel Scanner',
            source: 'scan',
          },
          affectedProjects: ['web-frontend', 'api-gateway', 'mobile-app'],
          remediation: {
            recommendation: 'Remove the malicious package immediately and replace with legitimate lodash. Audit all code that may have been affected.',
            effort: 'high',
            priority: 1,
          },
          references: [
            {
              type: 'cve',
              url: 'https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-12345',
              title: 'CVE-2025-12345',
            },
            {
              type: 'advisory',
              url: 'https://github.com/advisories/GHSA-xxxx-yyyy-zzzz',
              title: 'GitHub Security Advisory',
            },
          ],
          timeline: [
            {
              date: new Date('2025-06-14T10:30:00'),
              action: 'Vulnerability discovered',
              user: 'TypoSentinel Scanner',
            },
            {
              date: new Date('2025-06-14T11:00:00'),
              action: 'Assigned to Sarah Chen',
              user: 'Security Team Lead',
            },
            {
              date: new Date('2025-06-14T14:20:00'),
              action: 'Severity upgraded to Critical',
              user: 'Sarah Chen',
              details: 'Found evidence of data exfiltration',
            },
          ],
        },
        {
          id: '2',
          title: 'Cryptocurrency Miner in dev-utils Package',
          description: 'The dev-utils package version 2.1.0 contains hidden cryptocurrency mining code that activates during build processes.',
          severity: 'high',
          status: 'in-progress',
          category: 'malware',
          cvss: 7.8,
          package: {
            name: 'dev-utils',
            version: '2.1.0',
            ecosystem: 'npm',
          },
          discoveredAt: new Date('2025-06-13T09:15:00'),
          lastUpdated: new Date('2025-06-14T08:30:00'),
          assignee: {
            name: 'Mike Rodriguez',
            email: 'mike.rodriguez@company.com',
            avatar: '/avatars/mike.jpg',
          },
          reporter: {
            name: 'Build System Monitor',
            source: 'scan',
          },
          affectedProjects: ['build-tools', 'ci-pipeline'],
          remediation: {
            recommendation: 'Downgrade to version 2.0.9 or find alternative package. Review build logs for suspicious CPU usage.',
            effort: 'medium',
            priority: 2,
          },
          references: [
            {
              type: 'blog',
              url: 'https://blog.security.com/crypto-mining-npm-packages',
              title: 'Cryptocurrency Mining in NPM Packages',
            },
          ],
          timeline: [
            {
              date: new Date('2025-06-13T09:15:00'),
              action: 'Vulnerability discovered',
              user: 'Build System Monitor',
            },
            {
              date: new Date('2025-06-13T10:00:00'),
              action: 'Investigation started',
              user: 'Mike Rodriguez',
            },
            {
              date: new Date('2025-06-14T08:30:00'),
              action: 'Remediation plan created',
              user: 'Mike Rodriguez',
            },
          ],
        },
        {
          id: '3',
          title: 'Outdated Express.js with Known Vulnerabilities',
          description: 'Express.js version 4.16.1 contains multiple known security vulnerabilities including prototype pollution and DoS attacks.',
          severity: 'medium',
          status: 'resolved',
          category: 'dependency',
          cve: 'CVE-2022-24999',
          cvss: 5.3,
          package: {
            name: 'express',
            version: '4.16.1',
            ecosystem: 'npm',
          },
          discoveredAt: new Date('2025-06-10T14:20:00'),
          lastUpdated: new Date('2025-06-12T16:45:00'),
          assignee: {
            name: 'Alex Kim',
            email: 'alex.kim@company.com',
            avatar: '/avatars/alex.jpg',
          },
          reporter: {
            name: 'Dependency Scanner',
            source: 'scan',
          },
          affectedProjects: ['api-server', 'auth-service'],
          remediation: {
            recommendation: 'Upgrade to Express.js version 4.18.2 or later. Test thoroughly after upgrade.',
            effort: 'low',
            priority: 3,
          },
          references: [
            {
              type: 'cve',
              url: 'https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-24999',
              title: 'CVE-2022-24999',
            },
          ],
          timeline: [
            {
              date: new Date('2025-06-10T14:20:00'),
              action: 'Vulnerability discovered',
              user: 'Dependency Scanner',
            },
            {
              date: new Date('2025-06-11T09:00:00'),
              action: 'Upgrade completed',
              user: 'Alex Kim',
            },
            {
              date: new Date('2025-06-12T16:45:00'),
              action: 'Vulnerability resolved',
              user: 'Alex Kim',
            },
          ],
        },
        {
          id: '4',
          title: 'Supply Chain Attack: Compromised Build Tool',
          description: 'The webpack-optimizer package has been compromised and is injecting malicious code into production builds.',
          severity: 'critical',
          status: 'open',
          category: 'supply-chain',
          cvss: 9.8,
          package: {
            name: 'webpack-optimizer',
            version: '3.2.1',
            ecosystem: 'npm',
          },
          discoveredAt: new Date('2025-06-14T16:00:00'),
          lastUpdated: new Date('2025-06-14T16:00:00'),
          reporter: {
            name: 'External Security Researcher',
            source: 'external',
          },
          affectedProjects: ['web-frontend', 'admin-panel'],
          remediation: {
            recommendation: 'Immediately stop using this package. Rebuild all affected applications with a clean build environment.',
            effort: 'high',
            priority: 1,
          },
          references: [
            {
              type: 'advisory',
              url: 'https://github.com/advisories/GHSA-abcd-efgh-ijkl',
              title: 'Supply Chain Attack Advisory',
            },
          ],
          timeline: [
            {
              date: new Date('2025-06-14T16:00:00'),
              action: 'Vulnerability reported',
              user: 'External Security Researcher',
            },
          ],
        },
      ];
      
      setVulnerabilities(mockVulnerabilities);
    } catch (error) {
      console.error('Failed to load vulnerabilities:', error);
    } finally {
      setLoading(false);
    }
  };

  const filteredVulnerabilities = vulnerabilities.filter(vuln => {
    const matchesStatus = filterStatus === 'all' || vuln.status === filterStatus;
    const matchesSeverity = filterSeverity === 'all' || vuln.severity === filterSeverity;
    const matchesSearch = searchTerm === '' || 
      vuln.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
      vuln.package.name.toLowerCase().includes(searchTerm.toLowerCase());
    
    return matchesStatus && matchesSeverity && matchesSearch;
  });

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return '#d32f2f';
      case 'high': return '#f57c00';
      case 'medium': return '#1976d2';
      case 'low': return '#388e3c';
      default: return '#757575';
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'open': return 'error';
      case 'in-progress': return 'warning';
      case 'resolved': return 'success';
      case 'false-positive': return 'default';
      default: return 'default';
    }
  };

  const getSeverityIcon = (severity: string) => {
    switch (severity) {
      case 'critical': return <ErrorIcon sx={{ color: '#d32f2f' }} />;
      case 'high': return <WarningIcon sx={{ color: '#f57c00' }} />;
      case 'medium': return <SecurityIcon sx={{ color: '#1976d2' }} />;
      case 'low': return <CheckCircleIcon sx={{ color: '#388e3c' }} />;
      default: return <SecurityIcon />;
    }
  };

  // Statistics for dashboard
  const stats = {
    total: vulnerabilities.length,
    open: vulnerabilities.filter(v => v.status === 'open').length,
    inProgress: vulnerabilities.filter(v => v.status === 'in-progress').length,
    resolved: vulnerabilities.filter(v => v.status === 'resolved').length,
    critical: vulnerabilities.filter(v => v.severity === 'critical').length,
    high: vulnerabilities.filter(v => v.severity === 'high').length,
    medium: vulnerabilities.filter(v => v.severity === 'medium').length,
    low: vulnerabilities.filter(v => v.severity === 'low').length,
  };

  const severityData = [
    { name: 'Critical', value: stats.critical, color: '#d32f2f' },
    { name: 'High', value: stats.high, color: '#f57c00' },
    { name: 'Medium', value: stats.medium, color: '#1976d2' },
    { name: 'Low', value: stats.low, color: '#388e3c' },
  ];

  const statusData = [
    { name: 'Open', value: stats.open, color: '#d32f2f' },
    { name: 'In Progress', value: stats.inProgress, color: '#f57c00' },
    { name: 'Resolved', value: stats.resolved, color: '#388e3c' },
  ];

  const trendData = [
    { month: 'Jan', discovered: 12, resolved: 8 },
    { month: 'Feb', discovered: 19, resolved: 15 },
    { month: 'Mar', discovered: 8, resolved: 12 },
    { month: 'Apr', discovered: 15, resolved: 18 },
    { month: 'May', discovered: 22, resolved: 20 },
    { month: 'Jun', discovered: 25, resolved: 16 },
  ];

  return (
    <Box sx={{ p: 3 }}>
      {/* Header */}
      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 3 }}>
        <Typography variant="h4" gutterBottom>
          Vulnerability Management
        </Typography>
        <Box sx={{ display: 'flex', gap: 1 }}>
          <Button variant="outlined" startIcon={<ExportIcon />}>
            Export Report
          </Button>
          <Button variant="outlined" startIcon={<RefreshIcon />} onClick={loadVulnerabilities}>
            Refresh
          </Button>
        </Box>
      </Box>

      {/* Tabs */}
      <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 3 }}>
        <Tabs value={selectedTab} onChange={(_, newValue) => setSelectedTab(newValue)}>
          <Tab label="Dashboard" />
          <Tab label="Vulnerabilities" />
          <Tab label="Trends" />
        </Tabs>
      </Box>

      {/* Dashboard Tab */}
      {selectedTab === 0 && (
        <Grid container spacing={3}>
          {/* Summary Cards */}
          <Grid item xs={12} md={3}>
            <Card>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography color="text.secondary" gutterBottom>
                      Total Vulnerabilities
                    </Typography>
                    <Typography variant="h4">
                      {stats.total}
                    </Typography>
                  </Box>
                  <BugIcon sx={{ fontSize: 40, color: 'primary.main' }} />
                </Box>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={3}>
            <Card>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography color="text.secondary" gutterBottom>
                      Open Issues
                    </Typography>
                    <Typography variant="h4" color="error.main">
                      {stats.open}
                    </Typography>
                  </Box>
                  <ErrorIcon sx={{ fontSize: 40, color: 'error.main' }} />
                </Box>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={3}>
            <Card>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography color="text.secondary" gutterBottom>
                      In Progress
                    </Typography>
                    <Typography variant="h4" color="warning.main">
                      {stats.inProgress}
                    </Typography>
                  </Box>
                  <ScheduleIcon sx={{ fontSize: 40, color: 'warning.main' }} />
                </Box>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={3}>
            <Card>
              <CardContent>
                <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                  <Box>
                    <Typography color="text.secondary" gutterBottom>
                      Resolved
                    </Typography>
                    <Typography variant="h4" color="success.main">
                      {stats.resolved}
                    </Typography>
                  </Box>
                  <CheckCircleIcon sx={{ fontSize: 40, color: 'success.main' }} />
                </Box>
              </CardContent>
            </Card>
          </Grid>

          {/* Charts */}
          <Grid item xs={12} md={6}>
            <Card>
              <CardContent>
                <Typography variant="h6" gutterBottom>
                  Vulnerabilities by Severity
                </Typography>
                <ResponsiveContainer width="100%" height={300}>
                  <PieChart>
                    <Pie
                      data={severityData}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={100}
                      paddingAngle={5}
                      dataKey="value"
                    >
                      {severityData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.color} />
                      ))}
                    </Pie>
                    <RechartsTooltip />
                  </PieChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>
          </Grid>
          <Grid item xs={12} md={6}>
            <Card>
              <CardContent>
                <Typography variant="h6" gutterBottom>
                  Status Distribution
                </Typography>
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={statusData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" />
                    <YAxis />
                    <RechartsTooltip />
                    <Bar dataKey="value" fill={(entry: any) => entry.color} />
                  </BarChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>
          </Grid>

          {/* Recent Critical Vulnerabilities */}
          <Grid item xs={12}>
            <Card>
              <CardContent>
                <Typography variant="h6" gutterBottom>
                  Recent Critical Vulnerabilities
                </Typography>
                <List>
                  {vulnerabilities
                    .filter(v => v.severity === 'critical')
                    .slice(0, 5)
                    .map((vuln) => (
                      <ListItem key={vuln.id} divider>
                        <ListItemIcon>
                          {getSeverityIcon(vuln.severity)}
                        </ListItemIcon>
                        <ListItemText
                          primary={vuln.title}
                          secondary={
                            <Box>
                              <Typography variant="body2" color="text.secondary">
                                {vuln.package.name}@{vuln.package.version} • {vuln.discoveredAt.toLocaleDateString()}
                              </Typography>
                              <Box sx={{ display: 'flex', gap: 1, mt: 1 }}>
                                <Chip 
                                  label={vuln.status.replace('-', ' ')} 
                                  color={getStatusColor(vuln.status) as any}
                                  size="small"
                                />
                                {vuln.assignee && (
                                  <Chip 
                                    label={vuln.assignee.name} 
                                    variant="outlined"
                                    size="small"
                                    avatar={<Avatar sx={{ width: 20, height: 20 }}>{vuln.assignee.name[0]}</Avatar>}
                                  />
                                )}
                              </Box>
                            </Box>
                          }
                        />
                        <Button 
                          size="small" 
                          onClick={() => {
                            setSelectedVulnerability(vuln);
                            setDetailsDialogOpen(true);
                          }}
                        >
                          View Details
                        </Button>
                      </ListItem>
                    ))
                  }
                </List>
              </CardContent>
            </Card>
          </Grid>
        </Grid>
      )}

      {/* Vulnerabilities Tab */}
      {selectedTab === 1 && (
        <Box>
          {/* Filters */}
          <Card sx={{ mb: 3 }}>
            <CardContent>
              <Grid container spacing={2} alignItems="center">
                <Grid item xs={12} md={4}>
                  <TextField
                    fullWidth
                    placeholder="Search vulnerabilities..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    InputProps={{
                      startAdornment: <SearchIcon sx={{ mr: 1, color: 'text.secondary' }} />,
                    }}
                  />
                </Grid>
                <Grid item xs={12} md={3}>
                  <FormControl fullWidth>
                    <InputLabel>Status</InputLabel>
                    <Select
                      value={filterStatus}
                      label="Status"
                      onChange={(e) => setFilterStatus(e.target.value)}
                    >
                      <MenuItem value="all">All Statuses</MenuItem>
                      <MenuItem value="open">Open</MenuItem>
                      <MenuItem value="in-progress">In Progress</MenuItem>
                      <MenuItem value="resolved">Resolved</MenuItem>
                      <MenuItem value="false-positive">False Positive</MenuItem>
                    </Select>
                  </FormControl>
                </Grid>
                <Grid item xs={12} md={3}>
                  <FormControl fullWidth>
                    <InputLabel>Severity</InputLabel>
                    <Select
                      value={filterSeverity}
                      label="Severity"
                      onChange={(e) => setFilterSeverity(e.target.value)}
                    >
                      <MenuItem value="all">All Severities</MenuItem>
                      <MenuItem value="critical">Critical</MenuItem>
                      <MenuItem value="high">High</MenuItem>
                      <MenuItem value="medium">Medium</MenuItem>
                      <MenuItem value="low">Low</MenuItem>
                    </Select>
                  </FormControl>
                </Grid>
                <Grid item xs={12} md={2}>
                  <Typography variant="body2" color="text.secondary">
                    {filteredVulnerabilities.length} of {vulnerabilities.length} vulnerabilities
                  </Typography>
                </Grid>
              </Grid>
            </CardContent>
          </Card>

          {/* Vulnerabilities List */}
          <Card>
            <CardContent>
              <TableContainer>
                <Table>
                  <TableHead>
                    <TableRow>
                      <TableCell>Vulnerability</TableCell>
                      <TableCell>Package</TableCell>
                      <TableCell>Severity</TableCell>
                      <TableCell>Status</TableCell>
                      <TableCell>Assignee</TableCell>
                      <TableCell>Discovered</TableCell>
                      <TableCell>Actions</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {filteredVulnerabilities.map((vuln) => (
                      <TableRow key={vuln.id} hover>
                        <TableCell>
                          <Box sx={{ display: 'flex', alignItems: 'center' }}>
                            {getSeverityIcon(vuln.severity)}
                            <Box sx={{ ml: 1 }}>
                              <Typography variant="body2" fontWeight={500}>
                                {vuln.title}
                              </Typography>
                              <Typography variant="caption" color="text.secondary">
                                {vuln.cve && `${vuln.cve} • `}CVSS: {vuln.cvss || 'N/A'}
                              </Typography>
                            </Box>
                          </Box>
                        </TableCell>
                        <TableCell>
                          <Typography variant="body2">
                            {vuln.package.name}
                          </Typography>
                          <Typography variant="caption" color="text.secondary">
                            v{vuln.package.version} ({vuln.package.ecosystem})
                          </Typography>
                        </TableCell>
                        <TableCell>
                          <Chip 
                            label={vuln.severity.toUpperCase()} 
                            sx={{ 
                              backgroundColor: getSeverityColor(vuln.severity),
                              color: 'white',
                              fontWeight: 'bold'
                            }}
                            size="small"
                          />
                        </TableCell>
                        <TableCell>
                          <Chip 
                            label={vuln.status.replace('-', ' ')} 
                            color={getStatusColor(vuln.status) as any}
                            size="small"
                          />
                        </TableCell>
                        <TableCell>
                          {vuln.assignee ? (
                            <Box sx={{ display: 'flex', alignItems: 'center' }}>
                              <Avatar sx={{ width: 24, height: 24, mr: 1 }}>
                                {vuln.assignee.name[0]}
                              </Avatar>
                              <Typography variant="body2">
                                {vuln.assignee.name}
                              </Typography>
                            </Box>
                          ) : (
                            <Typography variant="body2" color="text.secondary">
                              Unassigned
                            </Typography>
                          )}
                        </TableCell>
                        <TableCell>
                          <Typography variant="body2">
                            {vuln.discoveredAt.toLocaleDateString()}
                          </Typography>
                        </TableCell>
                        <TableCell>
                          <Button 
                            size="small" 
                            variant="outlined"
                            onClick={() => {
                              setSelectedVulnerability(vuln);
                              setDetailsDialogOpen(true);
                            }}
                          >
                            Details
                          </Button>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
            </CardContent>
          </Card>
        </Box>
      )}

      {/* Trends Tab */}
      {selectedTab === 2 && (
        <Grid container spacing={3}>
          <Grid item xs={12}>
            <Card>
              <CardContent>
                <Typography variant="h6" gutterBottom>
                  Vulnerability Discovery vs Resolution Trends
                </Typography>
                <ResponsiveContainer width="100%" height={400}>
                  <LineChart data={trendData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="month" />
                    <YAxis />
                    <RechartsTooltip />
                    <Line 
                      type="monotone" 
                      dataKey="discovered" 
                      stroke="#f57c00" 
                      strokeWidth={2}
                      name="Discovered"
                    />
                    <Line 
                      type="monotone" 
                      dataKey="resolved" 
                      stroke="#388e3c" 
                      strokeWidth={2}
                      name="Resolved"
                    />
                  </LineChart>
                </ResponsiveContainer>
              </CardContent>
            </Card>
          </Grid>
        </Grid>
      )}

      {/* Vulnerability Details Dialog */}
      <Dialog 
        open={detailsDialogOpen} 
        onClose={() => setDetailsDialogOpen(false)} 
        maxWidth="md" 
        fullWidth
      >
        {selectedVulnerability && (
          <>
            <DialogTitle>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                {getSeverityIcon(selectedVulnerability.severity)}
                {selectedVulnerability.title}
              </Box>
            </DialogTitle>
            <DialogContent>
              <Box sx={{ mb: 2 }}>
                <Grid container spacing={2}>
                  <Grid item xs={6}>
                    <Typography variant="body2" color="text.secondary">
                      Package
                    </Typography>
                    <Typography variant="body1">
                      {selectedVulnerability.package.name}@{selectedVulnerability.package.version}
                    </Typography>
                  </Grid>
                  <Grid item xs={6}>
                    <Typography variant="body2" color="text.secondary">
                      CVSS Score
                    </Typography>
                    <Typography variant="body1">
                      {selectedVulnerability.cvss || 'N/A'}
                    </Typography>
                  </Grid>
                </Grid>
              </Box>
              
              <Typography variant="body2" color="text.secondary" gutterBottom>
                Description
              </Typography>
              <Typography variant="body1" sx={{ mb: 2 }}>
                {selectedVulnerability.description}
              </Typography>

              <Typography variant="body2" color="text.secondary" gutterBottom>
                Remediation
              </Typography>
              <Typography variant="body1" sx={{ mb: 2 }}>
                {selectedVulnerability.remediation.recommendation}
              </Typography>

              {selectedVulnerability.references.length > 0 && (
                <>
                  <Typography variant="body2" color="text.secondary" gutterBottom>
                    References
                  </Typography>
                  <List dense>
                    {selectedVulnerability.references.map((ref, index) => (
                      <ListItem key={index}>
                        <ListItemIcon>
                          <LinkIcon fontSize="small" />
                        </ListItemIcon>
                        <ListItemText
                          primary={
                            <a href={ref.url} target="_blank" rel="noopener noreferrer">
                              {ref.title}
                            </a>
                          }
                          secondary={ref.type}
                        />
                      </ListItem>
                    ))}
                  </List>
                </>
              )}

              <Accordion>
                <AccordionSummary expandIcon={<ExpandMoreIcon />}>
                  <Typography>Timeline</Typography>
                </AccordionSummary>
                <AccordionDetails>
                  <List>
                    {selectedVulnerability.timeline.map((event, index) => (
                      <ListItem key={index}>
                        <ListItemIcon>
                          <CalendarIcon fontSize="small" />
                        </ListItemIcon>
                        <ListItemText
                          primary={event.action}
                          secondary={
                            <>
                              {event.user} • {event.date.toLocaleString()}
                              {event.details && (
                                <Typography variant="body2" sx={{ mt: 0.5 }}>
                                  {event.details}
                                </Typography>
                              )}
                            </>
                          }
                        />
                      </ListItem>
                    ))}
                  </List>
                </AccordionDetails>
              </Accordion>
            </DialogContent>
            <DialogActions>
              <Button onClick={() => setDetailsDialogOpen(false)}>Close</Button>
              <Button variant="contained">Assign to Me</Button>
            </DialogActions>
          </>
        )}
      </Dialog>
    </Box>
  );
};

export default VulnerabilityManagement;